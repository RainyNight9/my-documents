<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
  </head>
  <body>
    <h2>å‰è¨€</h2><p>å‰ä¸¤ç« ï¼Œæˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº†ç‰©æ–™ã€ç”¨æˆ·ç³»ç»Ÿçš„è®¾è®¡ä¸å¼€å‘ï¼Œåœ¨ç»è¿‡äº†ç”¨æˆ·ç³»ç»Ÿä¸ç‰©æ–™ç³»ç»Ÿçš„æŠ˜ç£¨ä¹‹åï¼Œå¤§å®¶åº”è¯¥å¯¹ <code>NestJS</code>
      å·²ç»éå¸¸çš„ç†Ÿæ‚‰äº†ï¼Œå­¦ä¹ æ—…é€”ä¹Ÿåˆ°äº†ç½‘å…³ç³»ç»Ÿä¸­<strong>æœ€å…³é”®ä¸æ ¸å¿ƒ</strong>çš„åŠŸèƒ½æ¨¡å—å¼€å‘ã€‚</p><p>ç”±äºç‰©æ–™ä¸ç½‘å…³æ ¸å¿ƒåŠŸèƒ½çš„è€¦åˆåº¦éå¸¸é«˜ï¼Œæ“ä½œèµ·æ¥éå¸¸éº»çƒ¦ï¼Œæ¯•ç«Ÿæˆ‘ä»¬æ²¡æœ‰çœŸå®çš„ç•Œé¢ï¼Œæ‰€ä»¥åœ¨æœ¬ç« å†…å®¹ä¸­ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨
      <code>mock</code> æ•°æ®æ¥å®ç°ä»£ç†è½¬å‘çš„åŠŸèƒ½ï¼ŒåŒæ—¶å¯¹ç¼“å­˜æ•°æ®åšä¸€ä¸ªå¤§æ¦‚çš„ä»‹ç»ã€‚</p><h2>ç½‘å…³æ ¸å¿ƒç³»ç»Ÿå¼€å‘</h2><h4>æ‹¦æˆªè·¯ç”±</h4><p>åœ¨éœ€æ±‚åˆ†æä¸­æˆ‘ä»¬æåˆ°äº†ï¼Œç½‘å…³åŸºç¡€æœåŠ¡ä½œä¸ºæ‰€æœ‰èµ„æºçš„å‰ç½®å…¥å£ï¼Œéœ€è¦å¯¹æ‰€æœ‰çš„è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œå†æ ¹æ®è¯·æ±‚çš„ç±»å‹åˆ†å‘åˆ°å¯¹åº”çš„æœåŠ¡æˆ–è€…è¿”å›éœ€æ±‚çš„èµ„æºï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ¥å—æ‰€æœ‰è¯·æ±‚çš„
      <code>Controller</code>ã€‚</p><p>æ–°å»º <code>src/core/intercepter.controller.ts</code>
      å¦‚ä¸‹æ‰€ç¤º</p><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Public</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/auth/constants'</span>;<span class="hljs-keyword">import</span> {  <span class="hljs-title class_">Controller</span>,  <span class="hljs-title class_">Get</span>,  <span class="hljs-title class_">Req</span>,  <span class="hljs-title class_">Res</span>,} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FastifyReply</span>, <span class="hljs-title class_">FastifyRequest</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'fastify'</span>;<span class="hljs-meta">@Controller</span>()<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IntercepterController</span> {  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) { }  <span class="hljs-meta">@Get</span>()  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getApp</span>(<span class="hljs-params"><span class="hljs-meta">@Req</span>() req: FastifyRequest, <span class="hljs-meta">@Res</span>() res: FastifyReply</span>) {    res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'html'</span>)  }}</code></pre><blockquote><p>æ³¨æ„ï¼Œæ­¤æ—¶çš„
        <code>getApp</code> å¼•å…¥äº† <code>@Res() res: FastifyReply</code>ï¼Œä¸èƒ½ç›´æ¥
        <code>return</code> è¿”å›å€¼ï¼Œéœ€è¦ä½¿ç”¨ <code>res.send</code> æ¥è¿”å› <code>html</code>
        æ ¼å¼</p></blockquote><p>æ–°å»º <code>src/core/intercepter.module.ts</code>ï¼Œå¹¶åœ¨
      <code>app.module.ts</code> ä¸­å¯¼å…¥ã€‚</p><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">IntercepterController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./intercepter.controller'</span>;<span class="hljs-meta">@Module</span>({  <span class="hljs-attr">controllers</span>: [<span class="hljs-title class_">IntercepterController</span>],})<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IntercepterModule</span> { }</code></pre><p>ç„¶åè¯·æ±‚æ¥å£
      <a href="http://localhost/api" target="_blank" rel="nofollow noopener
        noreferrer">http://localhost/api</a> ï¼ˆ<strong>ä¸ºäº†æ–¹ä¾¿åæœŸä¿®æ”¹ <code>DNS</code>
        æµ‹è¯•æœ¬åœ°åŸŸåï¼Œå¯ä»¥å°†é¡¹ç›®å¯åŠ¨ç«¯å£æ”¹æˆ 80</strong>ï¼‰ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹è¿”å›å€¼ã€‚</p><p><img
        src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f51de1f90d414269a80034eabc35089e~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><p>ä»å›¾ä¸Šçœ‹å‡ºï¼Œè¯·æ±‚è·¯å¾„æ˜¯æºå¸¦äº† <code>api</code>
      å‰ç¼€çš„ï¼Œå¹¶ä¸ç¬¦åˆæ‹¦æˆªå…¨éƒ¨è·¯ç”±çš„è¦æ±‚ï¼Œå¯ä»¥ä¿®æ”¹ <code>main.ts</code> ä¸­çš„ <code>setGlobalPrefix</code>
      æ–¹æ³•ï¼š</p><pre><code class="hljs language-diff"><span class="hljs-deletion">- app.setGlobalPrefix('api');</span><span class="hljs-addition">+ app.setGlobalPrefix('api', { exclude: ['*'] }); </span></code></pre><p>åŒæ—¶å†ä¿®æ”¹
      <code>src/core/intercepter.controller.ts</code> ä¸­çš„ <code>getApp</code> çš„
      <code>Get</code> é…ç½®ï¼š</p><pre><code class="hljs language-diff"><span class="hljs-deletion">- @Controller()</span><span class="hljs-addition">+ @Controller('*')</span>export class IntercepterController {  constructor() { }  @Get()  async getApp(@Req() req: FastifyRequest, @Res() res: FastifyReply) {    res.send('html')  }}</code></pre><p>ç„¶åå†è®¿é—®å¦‚ä¸‹è·¯ç”±å¯¹æ¯”å³å¯ä»¥å‘ç°ï¼Œå½“è®¿é—®åˆ°é¡¹ç›®å·²å­˜åœ¨çš„æ¥å£æ—¶ï¼Œä¼šæ­£å¸¸èµ°ä¹‹å‰çš„ä¸šåŠ¡é€»è¾‘ï¼Œå½“è®¿é—®ä¸å­˜åœ¨çš„ä¸šåŠ¡é€»è¾‘è·¯ç”±æ—¶ï¼Œå°†ç»Ÿä¸€è¿›å…¥
      <code>IntercepterController</code> ä¸­ï¼š</p><p><img
        src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2d0a80ad81024acda2f7330fad156d7f~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><h4>è§£æè·¯ç”±</h4><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®åŸŸåæ¥åŒ¹é…ä¸åŒçš„è¿”å›é¡µé¢ï¼Œåœ¨ä¸Šä¸€æ­¥å·²ç»å°†é¡¹ç›®å¯åŠ¨ç«¯å£ä¿®æ”¹ä¸º
      <strong>80</strong>ï¼Œæ‰€ä»¥ç›´æ¥ä¿®æ”¹ç³»ç»Ÿçš„ <code>host</code> ç›®å½•ï¼Œæ¥ä¿®æ”¹åŸŸå <code>DNS</code>
      è§£æï¼Œä½¿ä¹‹æŒ‡å‘æœ¬åœ°æœåŠ¡ï¼Œç„¶åæµè§ˆå™¨è®¿é—®å³å¯ï¼š</p><pre><code class="hljs language-yaml"><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> <span class="hljs-string">www.cookieboty.com</span><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> <span class="hljs-string">nginx.cookieboty.com</span><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> <span class="hljs-string">jenkins.cookieboty.com</span><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> <span class="hljs-string">gitlab.cookieboty.com</span><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> <span class="hljs-string">devops.cookieboty.com</span><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> <span class="hljs-string">fe.cookieboty.com</span></code></pre><pre><code class="hljs language-diff">@Controller('*')export class IntercepterController {  constructor() { }  @Get()  async getApp(@Req() req: FastifyRequest, @Res() res: FastifyReply) {<span class="hljs-deletion">-    res.send('html')</span><span class="hljs-addition">+    res.send(req.headers.host)</span>  }}</code></pre><p><img
        src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6bba855e6a4f4205855c0d55d933bc57~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>req.headers.host</code>
      æ¥æ‹¿åˆ°å¯¹åº”çš„åŸŸåæ¥åˆ¤æ–­è¿”å›èµ„æºï¼Œä½†æ˜¯ä»…ä»…æœ‰åŸŸåè‚¯å®šæ˜¯ä¸è¶³å¤Ÿçš„ã€‚</p><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªåŸŸåä¸‹é¢ä¼šå­˜åœ¨å¤šä¸ªå‰ç«¯é¡¹ç›®ï¼Œè¿™äº›å‰ç«¯é¡¹ç›®å¯ä»¥é€šè¿‡è·¯ç”±å‰ç¼€æ¥åŒºåˆ†ï¼Œä¾‹å¦‚
      <a href="http://www.cookieboty.com/devops" target="_blank" rel="nofollow
        noopener noreferrer">www.cookieboty.com/devops</a> ã€<a
        href="http://www.cookieboty.com/jenkins" target="_blank" rel="nofollow
        noopener noreferrer">www.cookieboty.com/jenkins</a> ç­‰ç­‰ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿéœ€è¦å¯¹æ•´ä¸ª <code>url</code>
      è¿›è¡Œè§£æã€‚</p><p>åŒæ—¶ï¼Œä¹Ÿå­˜åœ¨ <code>SPA</code> é¡¹ç›®ä¸­ä½¿ç”¨ <code>history</code>
      çš„æƒ…å†µï¼Œè¿™æ ·çš„è¯å°±ä¼šå­˜åœ¨è™šæ‹Ÿè·¯ç”±ï¼ŒçœŸå®çš„è®¿é—®åœ°å€ä¸æµè§ˆå™¨è¯·æ±‚çš„åœ°å€ä¸åŒ¹é…çš„æƒ…å†µï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦æ¨¡æ‹Ÿ <code>Nginx</code> ä¸­çš„
      <code>try_files</code> æ¨¡å¼ã€‚</p><p><code>ç¬¬ä¸€æ­¥</code>ï¼šå€ŸåŠ© <code>url</code>
      åº“æ¥ç»„è£…è·¯ç”±</p><pre><code class="hljs language-diff"><span class="hljs-addition">+ import { URL } from 'url';</span>export class IntercepterController {  constructor() { }  @Get()  async getApp(@Req() req: FastifyRequest, @Res() res: FastifyReply) {<span class="hljs-addition">+   const urlObj = new URL(req.url, `http://${req.headers.host}`);</span><span class="hljs-addition">+   console.log('urlObj===>', urlObj)</span>    res.send(req.headers.host)  }}</code></pre><p>è®¿é—®ä¹‹å‰çš„åŸŸåå¯ä»¥åœ¨æ§åˆ¶å°å¾—åˆ°å¦‚ä¸‹çš„ç»“æ„ï¼š</p><p><img
        src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3e7457f9da2d4868982713167018d3c6~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><blockquote><p>å¯ä»¥çœ‹åˆ°æ§åˆ¶å°ä¸­æœ‰ä¸¤ç§æ‰“å°ï¼Œæ™®é€šçš„ <code>html</code>
        ä¼šè‡ªåŠ¨è¯·æ±‚ <code>favicon</code> èµ„æºï¼Œæˆ‘ä»¬åªéœ€è¦æ‹¦æˆªæ­£å¸¸çš„è¯·æ±‚ï¼Œè¿‡æ»¤æ‰ <code>favicon.ico</code>
        è¿™ç§ç±»å‹çš„è¯·æ±‚å³å¯ï¼Œæˆ–è€…è¿”å›ä¸€ä¸ªé€šç”¨çš„å°å›¾æ ‡ä¹Ÿè¡Œã€‚</p></blockquote><p><strong>ç¬¬äºŒæ­¥</strong>ï¼šä¿®æ”¹
      <code>IntercepterController</code>ï¼Œæ·»åŠ è¯»å– <code>html</code> æ–¹æ³•ä¸åˆ¤æ–­ç©ºå¼‚å¸¸ï¼š</p><pre><code>@Controller()export class IntercepterController {  constructor(private readonly intercepterService: IntercepterService) { }  @Get('*')  @Public()  async getApp(@Req() req: FastifyRequest, @Res() res: FastifyReply) {    const urlObj = new URL(req.url, `http://${req.headers.host}`);        if (urlObj.pathname === '/favicon.ico') return res.send('ico');        const html = await this.intercepterService.readHtml(urlObj);   if (!html) return res.send('404');       res.headers({      'Content-Type': 'text/html',    });    res.send(html);  }}</code></pre><p><strong>ç¬¬ä¸‰æ­¥</strong>ï¼šæ–°å»º
      <code>src/core/intercepter.service.ts</code> æ·»åŠ  <code>IntercepterService</code></p><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">WebSiteDataModel</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./types'</span>;<span class="hljs-keyword">import</span> { getMatchedSync } <span class="hljs-keyword">from</span> <span class="hljs-string">'./intercepter'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">WebsitesMock</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./websites_mock.json'</span>;<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">FilesMock</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./files_mock.json'</span>;<span class="hljs-meta">@Injectable</span>()<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IntercepterService</span> {  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) { }  <span class="hljs-keyword">get</span> <span class="hljs-title function_">websites</span>(): <span class="hljs-title class_">Record</span>&#x3C;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">WebSiteDataModel</span>> {    <span class="hljs-keyword">return</span> <span class="hljs-title class_">WebsitesMock</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&#x3C;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">WebSiteDataModel</span>>  }  <span class="hljs-keyword">async</span> <span class="hljs-title function_">readHtml</span>(<span class="hljs-params">urlObj: URL</span>) {    <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: matchedData } = <span class="hljs-title function_">getMatchedSync</span>(urlObj, <span class="hljs-variable language_">this</span>.<span class="hljs-property">websites</span>);    <span class="hljs-keyword">if</span> (!matchedData) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>    <span class="hljs-keyword">const</span> html = <span class="hljs-title class_">FilesMock</span>[matchedData.<span class="hljs-property">pageId</span>]    <span class="hljs-keyword">return</span> html;  }}</code></pre><p><code>files_mock.json</code></p><pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>  <span class="hljs-attr">"1"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"devops"</span><span class="hljs-punctuation">,</span>  <span class="hljs-attr">"2"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"jenkins"</span><span class="hljs-punctuation">,</span>  <span class="hljs-attr">"3"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nginx"</span><span class="hljs-punctuation">}</span></code></pre><p><code>websites_mock.json</code></p><pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>  <span class="hljs-attr">"www.cookieboty.com"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>    <span class="hljs-attr">"/devops"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>      <span class="hljs-attr">"lastModified"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>      <span class="hljs-attr">"pageId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>    <span class="hljs-attr">"/jenkins"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>      <span class="hljs-attr">"lastModified"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>      <span class="hljs-attr">"pageId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span>    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>    <span class="hljs-attr">"/nginx"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>      <span class="hljs-attr">"lastModified"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>      <span class="hljs-attr">"pageId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span>    <span class="hljs-punctuation">}</span>  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span></code></pre><p><strong>ç¬¬å››æ­¥</strong>ï¼šåˆ›å»ºè§£æ
      <code>url</code> çš„æ–¹æ³•ï¼Œè§£æè·¯ç”±åœ°å€ï¼Œä¾‹å¦‚å°† <code>devops/list</code>ã€<code>devops/detail</code>
      ç­‰è·¯ç”±å…¨éƒ¨æŒ‡å‘åˆ°æ ¹è·¯ç”±åœ°å€ <code>devops</code> çš„èµ„æºä¸Šï¼Œåœ¨ç¬¬ä¸‰æ­¥ä¸­çš„ <code>getMatchedSync</code>
      æ–¹æ³•å°±ç”¨ä½œæ­¤åˆ¤æ–­ï¼š</p><pre><code class="hljs language-ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getMatchedSync = (  <span class="hljs-attr">urlObj</span>: <span class="hljs-variable constant_">URL</span>,  <span class="hljs-attr">websites</span>: <span class="hljs-title class_">Record</span>&#x3C;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">WebSiteDataModel</span>> = {},): { <span class="hljs-attr">path</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>; <span class="hljs-attr">data</span>: <span class="hljs-title class_">PageModelItem</span> | <span class="hljs-literal">undefined</span> } | <span class="hljs-function"><span class="hljs-params">undefined</span> =></span> {  <span class="hljs-keyword">if</span> (!urlObj.<span class="hljs-property">hostname</span>) {    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;  }  <span class="hljs-keyword">const</span> website = <span class="hljs-title function_">matchWebsite</span>(urlObj.<span class="hljs-property">hostname</span>, websites);  <span class="hljs-keyword">if</span> (!website) {    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;  }  <span class="hljs-keyword">const</span> { data, path } = <span class="hljs-title function_">matchPath</span>(website, urlObj.<span class="hljs-property">pathname</span>);  <span class="hljs-keyword">if</span> (!data) {    <span class="hljs-keyword">return</span> { <span class="hljs-attr">path</span>: <span class="hljs-literal">undefined</span>, <span class="hljs-attr">data</span>: <span class="hljs-literal">undefined</span> };  }  <span class="hljs-keyword">return</span> { data, path };}</code></pre><p>å…ˆç”±
      <code>matchWebsite</code> æ¥åŒ¹é… <code>host</code>ï¼Œè·å–åŒ¹é…æˆåŠŸçš„ <code>host</code>
      æ•°æ®ä¹‹åï¼Œå†ä½¿ç”¨ matchPath æ–¹æ³•è¿›è¡Œ <code>path</code> çš„åŒ¹é…ï¼š</p><pre><code class="hljs language-ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> matchWebsite = (  <span class="hljs-attr">host</span>: <span class="hljs-built_in">string</span>,  <span class="hljs-attr">websites</span>: <span class="hljs-title class_">Record</span>&#x3C;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">WebSiteDataModel</span>>,): <span class="hljs-title class_">WebSiteDataModel</span> | <span class="hljs-function"><span class="hljs-params">undefined</span> =></span> {  <span class="hljs-keyword">return</span> websites[host];}<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> matchPath = (  <span class="hljs-attr">website</span>: <span class="hljs-title class_">WebSiteDataModel</span> | <span class="hljs-literal">undefined</span>,  <span class="hljs-attr">targetPath</span>: <span class="hljs-built_in">string</span>,): { <span class="hljs-attr">path</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">data</span>: <span class="hljs-title class_">PageModelItem</span> } | <span class="hljs-function"><span class="hljs-params">undefined</span> =></span> {  <span class="hljs-keyword">if</span> (!website) <span class="hljs-keyword">return</span>;  <span class="hljs-keyword">const</span> targetPathArr = <span class="hljs-title function_">splitPath</span>(targetPath);  <span class="hljs-keyword">if</span> (targetPathArr.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">i</span>) =></span> i === <span class="hljs-string">'*'</span>)) {    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(      <span class="hljs-string">'[matchPath] website custome path include *, redirect to 404'</span>,    );  }  <span class="hljs-comment">// å…¨åŒ¹é…</span>  <span class="hljs-keyword">if</span> (website[targetPath]) {    <span class="hljs-keyword">return</span> {      <span class="hljs-attr">path</span>: targetPath,      <span class="hljs-attr">data</span>: website[targetPath],    };  }  <span class="hljs-comment">// .html åç¼€ ä¸” ä¸ç­‰äº index.html,</span>  <span class="hljs-keyword">if</span> (<span class="hljs-regexp">//[^/]+.html$/</span>.<span class="hljs-title function_">test</span>(targetPath) &#x26;&#x26; !<span class="hljs-regexp">//index.html/</span>.<span class="hljs-title function_">test</span>(targetPath)) {    <span class="hljs-keyword">return</span> {      <span class="hljs-attr">path</span>: targetPath,      <span class="hljs-attr">data</span>: website[targetPath],    };  }  <span class="hljs-comment">// é€šé…</span>  <span class="hljs-keyword">let</span> matchLen = <span class="hljs-number">0</span>;  <span class="hljs-keyword">let</span> <span class="hljs-attr">resultKey</span>: <span class="hljs-built_in">string</span>;  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(website.<span class="hljs-property">path</span> || {}).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">path</span>) =></span> {    <span class="hljs-keyword">if</span> (!path.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'/'</span>)) path = <span class="hljs-string">`/<span class="hljs-subst">${path}</span>`</span>;    <span class="hljs-keyword">const</span> pathArr = <span class="hljs-title function_">splitPath</span>(path);    <span class="hljs-comment">// éå¿…é¡»å®¹é”™ï¼šä»…å…è®¸æœ€åä¸€ä¸ªå­—ç¬¦å‡ºç° *</span>    <span class="hljs-keyword">if</span> (pathArr.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>).<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">i</span>) =></span> i === <span class="hljs-string">'*'</span>))      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'[matchPath] path include *'</span>);    <span class="hljs-comment">/**     * éå†è·¯ç”±è§„åˆ™åˆ—è¡¨ï¼ŒåŒ¹é…å‘½ä¸­ç«‹å³åœæ­¢éå†     */</span>    <span class="hljs-keyword">let</span> currentMatchLen = <span class="hljs-number">0</span>;    <span class="hljs-keyword">let</span> <span class="hljs-attr">currentResultKey</span>: <span class="hljs-built_in">string</span>;    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &#x3C; pathArr.<span class="hljs-property">length</span>; i += <span class="hljs-number">1</span>) {      <span class="hljs-keyword">if</span> (targetPathArr[i] !== pathArr[i]) {        currentMatchLen = <span class="hljs-number">0</span>;        currentResultKey = <span class="hljs-literal">undefined</span>;        <span class="hljs-keyword">return</span>;      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-literal">undefined</span> === targetPathArr[i]) {        currentMatchLen = <span class="hljs-number">0</span>;        currentResultKey = <span class="hljs-literal">undefined</span>;        <span class="hljs-keyword">return</span>;      }      currentMatchLen = i + <span class="hljs-number">1</span>;      currentResultKey = path;    }    <span class="hljs-keyword">if</span> (matchLen &#x3C; currentMatchLen) {      matchLen = currentMatchLen;      resultKey = currentResultKey;    }  });  <span class="hljs-keyword">return</span> {    <span class="hljs-attr">path</span>: resultKey,    <span class="hljs-attr">data</span>: website.<span class="hljs-property">path</span>[resultKey],  };}</code></pre><h4>è·å–èµ„æº</h4><p>åœ¨è§£æè·¯ç”±çš„ç¬¬ä¸‰æ­¥ä¸­ï¼Œå¤§å®¶åº”è¯¥æ³¨æ„åˆ°åœ¨è·¯ç”±åŒ¹é…ä¸­ï¼Œæœ‰
      <strong>2</strong> ä¸ª <code>mock json</code> æ–‡ä»¶ <code>websites_mock.json</code>
      ä¸ <code>files_mock.json</code>ï¼Œå®ƒæ˜¯ç”±ç‰©æ–™ç³»ç»Ÿä¸­çš„ <code>pages</code> ç»„æˆçš„ï¼Œå…·ä½“çš„ç»“æ„ä¸ºï¼š</p><pre><code class="hljs language-ts"><span class="hljs-comment">/** * <span class="hljs-doctag">@description</span> ç«™ç‚¹æ•°æ®æ¨¡å‹ */</span><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WebSiteDataModel</span> {  <span class="hljs-comment">/**   * <span class="hljs-doctag">@description</span> ç«™ç‚¹ä¸‹çš„æ‰€æœ‰ path è¡¨   */</span>  [<span class="hljs-attr">host</span>: <span class="hljs-built_in">string</span>]: {    [<span class="hljs-attr">path</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-title class_">PageModelItem</span>;  }}<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PageModelItem</span> {  <span class="hljs-comment">/**   * <span class="hljs-doctag">@description</span> æœ€åä¿®æ”¹æ—¶é—´   */</span>  lastModified?: <span class="hljs-built_in">number</span>;  <span class="hljs-comment">/**   * <span class="hljs-doctag">@description</span> é¡µé¢ id   */</span>  pageId?: <span class="hljs-built_in">number</span>;    <span class="hljs-comment">/**   * <span class="hljs-doctag">@description</span> æƒé™   */</span>  permissions?: <span class="hljs-title class_">Array</span>&#x3C;<span class="hljs-function">() =></span> (<span class="hljs-built_in">boolean</span> | <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-built_in">boolean</span>>) | <span class="hljs-built_in">boolean</span>>;}</code></pre><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ˜¯éœ€è¦é€šè¿‡
      <code>pageId</code> å»æ•°æ®åº“æŸ¥è¯¢å‡ºå¯¹åº”çš„èµ„æºè¿”å›ï¼Œä¸è¿‡åœ¨ <code>mock</code>
      çš„æƒ…å†µçœç•¥äº†ï¼Œç°åœ¨æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹ç»“æœå¦‚ä½•ï¼š</p><p><img
        src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b97b6feac96e49ecaf6f4ef51828c0c5~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><blockquote><p>æ³¨æ„ <a
          href="http://www.cookieboty.com/jenkins/list" target="_blank"
          rel="nofollow noopener noreferrer">http://www.cookieboty.com/jenkins/list</a>
        ä¸ <a href="http://www.cookieboty.com/jenkins" target="_blank"
          rel="nofollow noopener noreferrer">http://www.cookieboty.com/jenkins</a>
        è¿™ä¸¤ä¸ªè·¯ç”±ï¼Œå®ƒå°±æ˜¯ä¹‹å‰æ‰€æåˆ°è¿‡çš„è™šæ‹Ÿè·¯ç”±åŒ¹é…ï¼Œå½“è®¿é—®çš„èµ„æºä¸º <code>SPA</code> é¡¹ç›®ä½¿ç”¨ <code>history</code>
        æ„å»ºçš„è¯ï¼Œ<code>jenkins</code> ä¹‹åæ‰€æœ‰çš„è·¯å¾„éƒ½éœ€è¦å¼ºåˆ¶æŒ‡å‘ <code>jenkins</code> è¿™ä¸ªè·¯ç”±ä¸Šã€‚</p></blockquote><h4>ç¼“å­˜</h4><p>ç”±äºæˆ‘ä»¬æ˜¯é™æ€èµ„æºä»£ç†ï¼Œæ‰€ä»¥ä¸ºäº†è¾¾åˆ°æœ€å¿«çš„è®¿é—®é€Ÿåº¦ï¼Œç»™ç”¨æˆ·æä¾›æœ€é«˜çš„æ€§èƒ½ä½“éªŒï¼Œå¯ä»¥å€ŸåŠ©
      <strong>3</strong> å±‚ç¼“å­˜æ¥å®ç°ã€‚</p><p><strong>ç¬¬ä¸€å±‚ç¼“å­˜</strong>ï¼šç”±å®¢æˆ·ç«¯è‡ªèº«åœ¨è®¿é—®ä¹‹åäº§ç”Ÿçš„åå•†ç¼“å­˜ï¼Œå½“è¯·æ±‚èµ„æºä¸å˜çš„æƒ…å†µä¸‹ï¼Œç”¨æˆ·è®¿é—®çš„æ˜¯æœ¬åœ°èµ„æºï¼Œè¿™ä¸ªçŸ¥è¯†ç‚¹ï¼Œå¤§éƒ¨åˆ†çš„å‰ç«¯åŒå­¦éƒ½åº”è¯¥æŒæ¡çš„éå¸¸ç†Ÿæ‚‰ï¼Œè¿™é‡Œå°±ä¸å†æ‹“å±•äº†ã€‚æ¥ä¸‹æ¥ä»‹ç»ä¸€ä¸‹ï¼Œåœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­å¦‚ä½•åˆ©ç”¨ç¼“å­˜æ¥æé«˜è®¿é—®æ•ˆç‡ã€‚</p><p><img
        src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4c75a9135fbb4e10b1eeb3cbb14e0f62~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç¬¬äºŒå±‚ç¼“å­˜ä¸ç¬¬ä¸‰å±‚ç¼“å­˜åˆ†åˆ«æ˜¯ç¨‹åºè¿è¡Œæœ¬åœ°æœåŠ¡å™¨ä¸ <strong>Redis</strong>
      æœåŠ¡ã€‚</p><p>å½“ç¬¬ä¸€ä¸ªç”¨æˆ·åœ¨è®¿é—®é¡µé¢æ—¶ï¼Œå¦‚æœåœ¨æœ¬åœ°æ²¡æœ‰æŸ¥è¯¢åˆ°èµ„æºçš„è¯ï¼Œä¼šå‘ <strong>Redis</strong> æœåŠ¡è¯·æ±‚èµ„æºï¼Œå½“
      <strong>Redis</strong> æœåŠ¡ä¹Ÿæ²¡æœ‰è¯·æ±‚åˆ°å¯¹åº”çš„èµ„æºçš„è¯ï¼Œæœ€åå†å»è¯·æ±‚ <strong>MongoDB</strong> è·å–ã€‚</p><p>åŒæ ·åœ¨æ¯ä¸€æ¬¡è¯·æ±‚åˆ°èµ„æºçš„æƒ…å†µä¸‹ï¼Œéƒ½ä¼šåœ¨å¯¹åº”çš„å±‚çº§ç¼“å­˜èµ„æºï¼Œè¿™æ ·ä»»ä¸€ä¸€ä¸ªç”¨æˆ·è®¿é—®èµ„æºä¹‹åï¼Œå°±ä¼šäº§ç”Ÿç¼“å­˜æ•°æ®ï¼Œè¿™æ ·å¯ä»¥å‡å°‘æ•°æ®åº“çš„è¯»å†™ï¼ŒåŒæ—¶æé«˜å“åº”é€Ÿåº¦ã€‚</p><p>å¯èƒ½æœ‰åŒå­¦è¯´
      <code>Redis</code>
      è¿™ä¸€å±‚å¯ä»¥çœç•¥ï¼Œä½†ä¸€èˆ¬ç½‘å…³æœåŠ¡ä¹Ÿä¼šä½¿ç”¨åˆ†å¸ƒå¼éƒ¨ç½²æ–¹å¼ï¼Œåœ¨åˆ†å¸ƒå¼æ¶æ„ä¸­ä½ å‘½ä¸­çš„æœåŠ¡ä¸ä¸€å®šæ˜¯åœ¨æœ¬åœ°æœ‰ç¼“å­˜äº†ï¼Œæ‰€ä»¥å³ä½¿ä¸¢å¤±æœ¬åœ°ç¼“å­˜ï¼Œä¹Ÿä¸èƒ½èˆå¼ƒ
      <code>Redis</code>ï¼Œå½“ä»»ä¸€çš„æœåŠ¡å‘½ä¸­èµ„æºä¹‹åï¼Œéƒ½ä¼šåœ¨ <code>Redis</code>
      ä¸­äº§ç”Ÿç¼“å­˜ï¼Œå…¶ä»–çš„æœåŠ¡ä¹Ÿå¯ä»¥å…±äº«ç¼“å­˜æ•°æ®ã€‚</p><p>å¦å¤–åœ¨æœ¬åœ°ç¼“å­˜ä¸­ï¼Œç”±äºä¼šå­˜å‚¨å¤§é‡çš„æ–‡ä»¶ï¼Œæ‰€ä»¥ä¹Ÿä¼šå­˜åœ¨æ—§ç‰ˆèµ„æºå†—ä½™çš„æƒ…å†µï¼Œæ‰€ä»¥åœ¨ä¹‹å‰çš„è®¾è®¡ä¸­ï¼Œæ°¸è¿œéƒ½åªä¿å­˜æœ€æ–°çš„èµ„æºäº§ç‰©ï¼Œä¸ä¼šä¿ç•™å†å²äº§ç‰©ï¼Œé€šè¿‡
      <code>lastModified</code> å‚æ•°æ¥åˆ¤æ–­éœ€è¦æ›´æ–°èµ„æºã€‚</p><p>å½“èµ„æºè¿‡å¤šçš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>LRU</code>
      ç®—æ³•æ¥æ¸…ç©ºæœ¬åœ°èµ„æºï¼Œçœ‹éœ€æ±‚è¿›è¡ŒåŠŸèƒ½æ‹“å±•å³å¯ï¼Œå¤§å®¶å°½æƒ…å‘æŒ¥ï¼Œä¸ç”¨å®¢æ°”ã€‚</p><blockquote><p>åœ¨ç¼“å­˜çš„å·¥å…·é€‰æ‹©ä¸Šï¼Œå¤§å®¶å¯ä»¥é€‰æ‹©è‡ªå·±ç†Ÿæ‚‰çš„å·¥å…·å³å¯ï¼Œåªæ˜¯
        <code>NestJS</code> è‡ªå¸¦çš„ç¼“å­˜æ’ä»¶å¯¹æ¥ <code>Redis</code> æ¯”è¾ƒæ–¹ä¾¿ï¼Œå¹¶ä¸ä»£è¡¨ä½ ä¸€å®šè¦ä½¿ç”¨ <code>Redis</code>
        æ‰è¡Œï¼Œæ¯”å¦‚æˆ‘ä»¬å…¬å¸ç›®å‰çš„ç¼“å­˜ä½¿ç”¨çš„æ˜¯ <code>Nacos</code>ã€‚</p></blockquote><h2>å†™åœ¨æœ€å</h2><p>æœ¬ç« çš„ä»£ç åœ°å€ä¸º
      <a href="https://github.com/boty-design/gateway/tree/feat/core"
        target="_blank" rel="nofollow noopener noreferrer">feat/core</a>ï¼Œéœ€è¦çš„åŒå­¦è‡ªå–ï¼Œä¼šæŒç»­æ›´æ–°ã€‚</p><p>ç”±äºç¯‡å¹…æ‰€é™ï¼Œæ–‡ç« é‡Œé¢æåˆ°çš„å¼€å‘å†…å®¹æ¯”è¾ƒå°‘ï¼Œåªæœ‰æœ€æ ¸å¿ƒçš„ä¸¤ä¸ªåŠŸèƒ½ï¼Œå…¶ä»–çš„åŠŸèƒ½å¯ä»¥ç­‰å¾…å®Œæ•´çš„é¡¹ç›®å‡ºæ¥ä¹‹åå†å¯¹æ¯”å­¦ä¹ å³å¯ï¼Œä¸€èˆ¬å…³é”®çš„åœ°æ–¹æˆ‘ä¼šåšå¿…è¦çš„æ³¨é‡Šï¼Œå¦‚æœè¿˜æœ‰å…¶ä»–çš„é—®é¢˜å¯ä»¥åŠ ç¾¤è®¨è®ºæˆ–è€…ç›´æ¥è”ç³»æˆ‘éƒ½è¡Œã€‚</p><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»é™†é™†ç»­ç»­å¼€å‘
      <strong>3</strong> ä¸ªå¤§çš„åŠŸèƒ½æ¨¡å—ï¼Œå¤§å®¶åº”è¯¥èƒ½æ„Ÿè§‰åˆ°ç›®å‰çš„å·¥ç¨‹å·²ç»å¾ˆåºå¤§äº†ï¼Œå¦‚æœæ˜¯æ™®é€šå¼€å‘æ¨¡å¼çš„è¯ï¼Œæ¯ä¸€æ¬¡çš„é‡å¯é€Ÿåº¦å·²ç»å˜æ…¢ã€‚</p><p>æ•´ä¸ªé¡¹ç›®ç›®å‰å·²ç»æœ‰
      <strong>40+</strong> ä¸ªæ¥å£ï¼Œå¦‚æœç‰©æ–™ç³»ç»Ÿå†å¤æ‚ç‚¹çš„è¯ï¼Œå·²ç» <strong>50+</strong> çš„æ¥å£ä¸åœ¨è¯ä¸‹ã€‚è€Œè¿™åªæ˜¯
      <code>Controller</code> çš„æ•°é‡ï¼Œå¹¶æœªæ‹¬å·¥å…·ç±»ä¸ <code>Service</code> å±‚çš„ä»£ç ã€‚</p><p>æ‰€ä»¥åœ¨æ¥ä¸‹æ¥ä¸‹ä¸€ç« ï¼Œæˆ‘ä»¬å°†å¯¹è¿™ä¸ªé€æ¸å˜æˆå·¨çŸ³çš„å·¥ç¨‹è¿›è¡Œé¡¹ç›®æ‹†åˆ†ï¼Œé™ä½é¡¹ç›®ä¹‹é—´çš„è€¦åˆåº¦ï¼Œåšåˆ°ç‹¬ç«‹éƒ¨ç½²ä¸ç‹¬ç«‹å¼€å‘ã€‚</p><p>å¦‚æœä½ æœ‰ä»€ä¹ˆç–‘é—®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºæå‡ºæˆ–è€…åŠ ç¾¤æ²Ÿé€šã€‚
      ğŸ‘</p>
  </body>
</html>