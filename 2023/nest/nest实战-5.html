<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
  </head>
  <body>
    <h2>å‰è¨€</h2><p>åœ¨ä¸Šä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å¯¹ <strong>CLI</strong>
      åˆ›å»ºçš„åŸºç¡€å·¥ç¨‹æ¨¡æ¿æ·»åŠ äº†ä¸€äº›é€šç”¨æ€§çš„åŠŸèƒ½é…ç½®ï¼Œä¹Ÿèƒ½æ»¡è¶³å¤§éƒ¨åˆ†ä¸šåŠ¡å¼€å‘çš„éœ€æ±‚ã€‚</p><p>åœ¨å®Œæˆäº†åŸºç¡€é…ç½®ä¹‹åï¼Œå°±å¯ä»¥æ ¹æ®è‡ªèº«å›¢é˜Ÿçš„æƒ…å†µæ¥å¼€å‘ä¸“å±çš„ä¸šåŠ¡åŠŸèƒ½ï¼Œä¾‹å¦‚å›¢é˜Ÿä¸­ä½¿ç”¨ä¼ä¸šå¾®ä¿¡ã€é’‰é’‰ã€é£ä¹¦ç­‰ä¼ä¸šå·¥å…·ï¼Œå¯ä»¥å¯¹æ¥åŒ¹é…çš„ä¸‰æ–¹åŠŸèƒ½ã€‚åœ¨ç”¨æˆ·ç³»ç»Ÿä¸­ï¼Œä¸ºäº†å¼€å‘ä¾¿æ·ä»¥åŠæ–¹ä¾¿å›¢é˜Ÿçš„ä½¿ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©ä¸‰æ–¹ç™»å½•å¸®åŠ©è·å–å›¢é˜Ÿå’Œä¸ªäººçš„ä¿¡æ¯ã€‚å¦å¤–ä¸Šè¿°å‡ ä¸ªä¸‰æ–¹è½¯ä»¶ä¹Ÿæä¾›äº†å¾ˆå¤šä¾¿æ·çš„åŠŸèƒ½ï¼Œä¾‹å¦‚æœºå™¨äººã€æ¶ˆæ¯é€šçŸ¥ã€æ–‡æ¡£ç­‰ã€‚</p><p>åœ¨
      <a href="https://juejin.cn/book/6948353204648148995" target="_blank"
        rel="nofollow noopener noreferrer">DevOps å°å†Œ</a>ä¸­ï¼Œä½¿ç”¨é’‰é’‰ä½œä¸ºä¸‰æ–¹æ‹“å±•ï¼Œä¸ºäº†å¸¦ç»™å¤§å®¶ä¸ä¸€æ ·çš„å­¦ä¹ ä½“éªŒï¼Œè¿™æ¬¡å°†ä½¿ç”¨é£ä¹¦ä½œä¸ºç”¨ä¾‹æ¥å®Œæˆæˆ‘ä»¬ç”¨æˆ·ã€æœºå™¨äººç­‰åŠŸèƒ½ã€‚</p><h2>é£ä¹¦åº”ç”¨å¯¹æ¥</h2><h3>åˆ›å»ºåº”ç”¨</h3><p>è¦åˆ©ç”¨é£ä¹¦çš„åŠŸèƒ½ï¼Œé¦–å…ˆè¦å»<a
        href="https://open.feishu.cn/app" target="_blank" rel="nofollow noopener
        noreferrer">å¼€æ”¾å¹³å°</a>åˆ›å»ºä¸€ä¸ªé£ä¹¦åº”ç”¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img
        src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bfe6b0b9245341da933be8c9c2f86091~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><p>åˆ›å»ºå®Œæ¯•ä¹‹åï¼Œéœ€è¦æ‹¿åˆ°é£ä¹¦åº”ç”¨çš„ <strong>App ID</strong>ï¼ˆåº”ç”¨å”¯ä¸€çš„ ID
      æ ‡è¯†ï¼‰ ä¸ <strong>App Secret</strong>ï¼ˆåº”ç”¨çš„å¯†é’¥ï¼‰ æ‰èƒ½è°ƒç”¨é£ä¹¦çš„ <strong>Open API</strong>ã€‚</p><p><img
        src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/348117865caf41b09d9bdd7be54f82b3~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><h3>å°è£…åº•å±‚è¯·æ±‚åº“</h3><p>è™½ç„¶ <code>NestJS</code> å†…ç½®äº† <code>@nestjs/axios</code>
      è¯·æ±‚åº“ï¼Œä½†æ˜¯å¯¹äºé£ä¹¦çš„ <code>Open API</code> å°è£…ï¼Œæˆ‘ä»¬è¿˜æ˜¯åˆ©ç”¨ä¹‹å‰çš„æ¨¡å¼ï¼Œä¸å°†å®ƒä¸ <code>NestJS</code>
      è¿‡åº¦çš„è€¦åˆåœ¨ä¸€èµ·ã€‚</p><blockquote><p>å°†é£ä¹¦ <strong>Open Api</strong>
        ç‹¬ç«‹å°è£…ä¹‹åï¼Œå¯ä»¥æŠ½æˆä¸€ä¸ªå·¥å…·åº“ï¼ŒåæœŸå¯ä»¥æä¾›ç»™å…¶ä»–çš„ <code>SDK</code> ä½¿ç”¨ï¼Œå¦‚æœè·Ÿ <code>NestJS</code>
        è€¦åˆè¿‡å¤šï¼Œå†æƒ³æä¾›ç»™å…¶ä»– <code>SDK</code> ä½¿ç”¨ï¼Œå°±åªèƒ½æä¾› <code>HTTP</code>
        è¯·æ±‚è°ƒç”¨çš„æ–¹å¼ï¼Œè¿™æ ·ä½¿ç”¨èµ·æ¥ä¸å¤ªæ–¹ä¾¿ã€‚çœ‹ä¸ªäººä¹ æƒ¯ï¼Œæˆ‘å€¾å‘ä½¿ç”¨ç‹¬ç«‹å°è£…çš„æ¨¡å¼ã€‚</p></blockquote><ol><li>æ·»åŠ åº”ç”¨é…ç½®ï¼Œä½¿ç”¨ä¸Šä¸€ç« èŠ‚çš„ç¯å¢ƒé…ç½®åŠŸèƒ½ï¼Œåœ¨
        <code>yaml</code> æ–‡ä»¶ä¸­æ·»åŠ é£ä¹¦çš„é…ç½®é¡¹ï¼š</li></ol><pre><code class="hljs language-yaml"><span class="hljs-attr">FEISHU_CONFIG:</span>  <span class="hljs-attr">FEISHU_URL:</span> <span class="hljs-string">https://open.feishu.cn/open-apis</span>  <span class="hljs-attr">FEISHU_API_HOST:</span> <span class="hljs-string">https://open.feishu.cn</span>  <span class="hljs-attr">FEISHU_APP_ID:</span> <span class="hljs-string">balabalabala</span>  <span class="hljs-attr">FEISHU_APP_SECRET:</span> <span class="hljs-string">balabalabala</span></code></pre><blockquote><p><strong>ID</strong>
        ä¸ <strong>Secret</strong> çš„ä¿¡æ¯è®°å¾—å¦¥å–„ä¿ç®¡ï¼Œå¦‚æœä½ åˆ›å»ºçš„åº”ç”¨æƒé™è¿‡é«˜çš„è¯ï¼Œæ„å¤–æ³„å¯†å¯èƒ½ä¼šå¯¼è‡´ä¸å¯é¢„æœŸçš„æŸå¤±ï¼Œ<strong>åˆ‡è®°</strong>ï¼</p></blockquote><ol
      start="2"><li>æ–°å»º <code>utils/request.ts</code> æ–‡ä»¶ï¼š</li></ol><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> axios, { <span class="hljs-title class_">Method</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;<span class="hljs-keyword">import</span> { getConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils'</span>;<span class="hljs-keyword">const</span> { <span class="hljs-attr">FEISHU_CONFIG</span>: { <span class="hljs-variable constant_">FEISHU_URL</span> } } = <span class="hljs-title function_">getConfig</span>()<span class="hljs-comment">/** * <span class="hljs-doctag">@description</span>: ä»»æ„è¯·æ±‚ */</span><span class="hljs-keyword">const</span> <span class="hljs-title function_">request</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">{ url, option = {} }</span>) => {  <span class="hljs-keyword">try</span> {    <span class="hljs-keyword">return</span> axios.<span class="hljs-title function_">request</span>({      url,      ...option,    });  } <span class="hljs-keyword">catch</span> (error) {    <span class="hljs-keyword">throw</span> error;  }};<span class="hljs-keyword">interface</span> <span class="hljs-title class_">IMethodV</span> {  <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>;  method?: <span class="hljs-title class_">Method</span>;  headers?: { [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">string</span> };  params?: <span class="hljs-title class_">Record</span>&#x3C;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">unknown</span>>;  query?: <span class="hljs-title class_">Record</span>&#x3C;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">unknown</span>>;}<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IRequest</span> {  <span class="hljs-attr">data</span>: <span class="hljs-built_in">any</span>;  <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>;}<span class="hljs-comment">/** * <span class="hljs-doctag">@description</span>: å¸¦ version çš„é€šç”¨ api è¯·æ±‚ */</span><span class="hljs-keyword">const</span> methodV = <span class="hljs-keyword">async</span> ({  url,  method,  headers,  params = {},  query = {},}: <span class="hljs-title class_">IMethodV</span>): <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-title class_">IRequest</span>> => {  <span class="hljs-keyword">let</span> sendUrl = <span class="hljs-string">''</span>;  <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/^(http://|https://)/</span>.<span class="hljs-title function_">test</span>(url)) {    sendUrl = url;  } <span class="hljs-keyword">else</span> {    sendUrl = <span class="hljs-string">`<span class="hljs-subst">${FEISHU_URL}</span><span class="hljs-subst">${url}</span>`</span>;  }  <span class="hljs-keyword">try</span> {    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =></span> {      <span class="hljs-title function_">axios</span>({        <span class="hljs-attr">headers</span>: {          <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json; charset=utf-8'</span>,          ...headers,        },        <span class="hljs-attr">url</span>: sendUrl,        method,        <span class="hljs-attr">params</span>: query,        <span class="hljs-attr">data</span>: {          ...params,        },      })        .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">{ data, status }</span>) =></span> {          <span class="hljs-title function_">resolve</span>({ data, <span class="hljs-attr">code</span>: status });        })        .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =></span> {          <span class="hljs-title function_">reject</span>(error);        });    });  } <span class="hljs-keyword">catch</span> (error) {    <span class="hljs-keyword">throw</span> error;  }};<span class="hljs-keyword">export</span> { request, methodV };</code></pre><blockquote><p>è¿™é‡Œè·Ÿä¹‹å‰ä¸€æ ·ï¼Œå°è£…äº†ä¸¤ç§è¯·æ±‚æ–¹æ³•ï¼Œä¸€ç§æ˜¯æ¤å…¥é£ä¹¦è¯·æ±‚çš„ç‰ˆæœ¬ï¼Œå¦ä¸€ç§æ˜¯è‡ªç”±è¯·æ±‚ï¼Œè¿™ä¸ªä¹ æƒ¯ä¹Ÿçœ‹ä¸ªäººï¼Œå¦‚æœè‡ªå·±çš„é¡¹ç›®ä¸éœ€è¦è‡ªç”±è¯·æ±‚æˆ–è€…ç›´æ¥ä½¿ç”¨
        <code>@nestjs/axios</code> çš„è¯·æ±‚æ¨¡å—çš„è¯ï¼Œå¯ä»¥æŠŠ <code>request</code> æ–¹æ³•åˆ é™¤ã€‚</p></blockquote><p>æ­¤å¤–ä¸Šè¿°å¼•ç”¨ä¸­ï¼Œä½¿ç”¨äº†
      <code>alias @</code>ï¼Œæ­£å¸¸æƒ…å†µä¹Ÿæ˜¯ä¸ä¼šè¢« <code>TS</code> é¡¹ç›®è¯†åˆ«ï¼Œéœ€è¦åœ¨ tsconfig.json
      é…ç½®æ–‡ä»¶ä¸­æ·»åŠ  <code>path</code> å‚æ•°ï¼š</p><pre><code class="hljs language-diff">{  "compilerOptions": {<span class="hljs-addition">+    "paths": {</span><span class="hljs-addition">+      "@/*": [</span><span class="hljs-addition">+        "src/*"</span><span class="hljs-addition">+      ],</span><span class="hljs-addition">+    },</span>    "module": "commonjs",    "declaration": true,    "removeComments": true,    "emitDecoratorMetadata": true,    "experimentalDecorators": true,    "allowSyntheticDefaultImports": true,    "target": "es2017",    "sourceMap": true,    "outDir": "./dist",    "baseUrl": "./",    "incremental": true,    "skipLibCheck": true,    "strictNullChecks": false,    "noImplicitAny": false,    "strictBindCallApply": false,    "forceConsistentCasingInFileNames": false,    "noFallthroughCasesInSwitch": false,    "resolveJsonModule": true  }}</code></pre><ol
      start="3"><li>åˆ›å»ºé£ä¹¦è¯·æ±‚åŸºç¡€å±‚ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</li></ol><p><img
        src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5940e9416a8d4b4aa34c7fb4e0c8edf7~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><p>ä¸Šå›¾ä¸­å°è£…çš„æ¨¡å—æ¯”è¾ƒå°‘ï¼Œåªæœ‰æƒé™ã€ç”¨æˆ·ç­‰æ¨¡å—ï¼Œå®é™…å¼€å‘ä¸­éœ€è¦æŒ‰ç…§ä¸šåŠ¡éœ€æ±‚é€‰æ‹©æ€§å°è£…å¯¹åº”çš„æ¨¡å—ï¼Œæ¯”å¦‚ç¾¤ç»„ã€æ¶ˆæ¯ã€é€šè®¯å½•ç­‰ç­‰ã€‚ä¸‹é¢ä»¥è·å–
      <code>Token</code> çš„æ–¹æ³•åšä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼š</p><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">APP_ID</span>, <span class="hljs-variable constant_">APP_SECRET</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./const'</span>;<span class="hljs-keyword">import</span> { methodV } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/utils/request'</span>;<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">GetAppTokenRes</span> = {  <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>;  <span class="hljs-attr">msg</span>: <span class="hljs-built_in">string</span>;  <span class="hljs-attr">app_access_token</span>: <span class="hljs-built_in">string</span>;  <span class="hljs-attr">expire</span>: <span class="hljs-built_in">number</span>;};<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getAppToken</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) => {  <span class="hljs-keyword">const</span> { data } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">methodV</span>({    <span class="hljs-attr">url</span>: <span class="hljs-string">`/auth/v3/app_access_token/internal`</span>,    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,    <span class="hljs-attr">params</span>: {      <span class="hljs-attr">app_id</span>: <span class="hljs-variable constant_">APP_ID</span>,      <span class="hljs-attr">app_secret</span>: <span class="hljs-variable constant_">APP_SECRET</span>,    },  });  <span class="hljs-keyword">return</span> data <span class="hljs-keyword">as</span> <span class="hljs-title class_">GetAppTokenRes</span>;};</code></pre><p>ä»¥ä¸Šå°±å·²ç»å®Œæˆäº†ä¸€ä¸ªç‹¬ç«‹çš„é£ä¹¦åº”ç”¨åº•å±‚è¯·æ±‚å±‚çš„å°è£…ï¼Œæ¥ä¸‹æ¥çœ‹å¦‚ä½•åœ¨ä¸šåŠ¡ä¸­ä½¿ç”¨ã€‚</p><h2>è°ƒç”¨é£ä¹¦
      API</h2><p><img
        src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0ff30c28ef3a46a789afab078648819d~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><p>é£ä¹¦çš„è°ƒç”¨æ–‡æ¡£è¿˜æ˜¯éå¸¸è¯¦ç»†çš„ï¼ŒæŒ‰ç…§ä¸Šå›¾æ‰€ç¤ºçš„æµç¨‹æ­£ç¡®æ“ä½œï¼Œä¸€èˆ¬ä¸ä¼šå‡ºç°å¼‚å¸¸ã€‚</p><p>ç¬¬
      <strong>1</strong>ã€<strong>2</strong> æ­¥æˆ‘ä»¬å®Œæˆäº†ï¼ˆåº”ç”¨ç”³è¯·ä¸æƒé™æˆäºˆï¼‰ï¼ŒæŒ‰ç…§æ­¥éª¤ <strong>3</strong>
      è¿˜éœ€è¦å°è£… <a
        href="https://open.feishu.cn/document/ukTMukTMukTM/uMTNz4yM1MjLzUzM"
        target="_blank" rel="nofollow noopener noreferrer">API è®¿é—®å‡­è¯</a> æ–¹ä¾¿åç»­çš„è°ƒç”¨ã€‚</p><h4>å°è£…
      API è®¿é—®å‡­è¯</h4><p>æ ¹æ®æ–‡æ¡£æè¿°ï¼Œé£ä¹¦æä¾›äº†ä¸‹è¿° <strong>3</strong> ç§è®¿é—®å‡­è¯ï¼Œåˆ†åˆ«æœ‰ä¸åŒçš„ç”¨é€”ï¼š</p><table><thead><tr><th>è®¿é—®å‡­è¯ç±»å‹</th><th>æ˜¯å¦éœ€è¦ç”¨æˆ·æˆæƒ</th><th>æ˜¯å¦éœ€è¦ç§Ÿæˆ·ç®¡ç†å‘˜æˆæƒ</th><th>é€‚ç”¨çš„åº”ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>app_access_token</td><td>ä¸éœ€è¦</td><td>ä¸éœ€è¦</td><td>çº¯åå°æœåŠ¡ç­‰</td></tr><tr><td>tenant_access_token</td><td>ä¸éœ€è¦</td><td>éœ€è¦</td><td>ç½‘é¡µåº”ç”¨ã€æœºå™¨äººã€çº¯åå°æœåŠ¡ç­‰</td></tr><tr><td>user_access_token</td><td>éœ€è¦</td><td>ä¸éœ€è¦</td><td>å°ç¨‹åºã€ç½‘é¡µåº”ç”¨ç­‰</td></tr></tbody></table><p>å‡­è¯çš„æœ‰æ•ˆæœŸæ˜¯
      <strong>2</strong> å°æ—¶ï¼Œåªæœ‰åœ¨å°äº <strong>30</strong>
      åˆ†é’Ÿçš„æ—¶å€™è°ƒç”¨æ‰ä¼šè¿”å›æ–°çš„å‡­è¯ï¼Œå¦åˆ™è¿”å›çš„è¿˜æ˜¯åŸå‡­è¯ï¼Œæ‰€ä»¥é¢‘ç¹è°ƒç”¨è¿”å›çš„ä»·å€¼ä¸å¤§ã€‚</p><p>è°ƒç”¨ä¸‰æ–¹æ¥å£è·å–å‡­è¯åï¼Œå†ä½¿ç”¨å‡­è¯è°ƒç”¨
      <strong>API</strong> çš„é“¾è·¯è¿‡ç¨‹æ¯”è¾ƒé•¿ï¼ŒåŒæ—¶ä¹Ÿå¯èƒ½æ”¶ç½‘ç»œæ³¢åŠ¨ã€è¯·æ±‚é¢‘ç‡çš„é™åˆ¶ï¼Œéœ€è¦å°†å‡­è¯ç¼“å­˜åœ¨æœ¬åœ°ï¼Œç­‰æœ‰æ•ˆæœŸå°äº
      <strong>30</strong> åˆ†é’Ÿæ—¶å†å»æ¢å–æ–°çš„å‡­è¯ï¼Œå‡å°‘è°ƒç”¨é“¾æ¥ã€é™ä½è¯·æ±‚é¢‘ç‡ã€‚</p><p><code>NestJS</code>
      æä¾›äº†<strong>é«˜é€Ÿç¼“å­˜</strong>çš„æ’ä»¶ <code>cache-manager</code>ï¼Œä¸ºå¯¹å„ç§ç¼“å­˜å­˜å‚¨æä¾›ç¨‹åºæä¾›äº†ç»Ÿä¸€çš„
      <code>API</code>ï¼Œå†…ç½®çš„æ˜¯å†…å­˜ä¸­çš„æ•°æ®å­˜å‚¨ã€‚</p><ol><li>å®‰è£…å¯¹åº”çš„ä¾èµ–ä¸ <code>@types</code></li></ol><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">$ </span><span class="bash">yarn add cache-manager</span> <span class="hljs-meta prompt_">$ </span><span class="bash">yarn add -D @types/cache-manager</span></code></pre><ol
      start="2"><li>åœ¨ä½¿ç”¨çš„ <code>Module</code> ä¸­æ³¨å†Œ <code>CacheModule</code>ï¼Œæ–°å»º
        <code>src/user/user.module.ts</code></li></ol><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">CacheModule</span>, forwardRef, <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FeishuService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./feishu/feishu.service'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FeishuController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./feishu/feishu.controller'</span>;<span class="hljs-meta">@Module</span>({  <span class="hljs-attr">imports</span>: [    <span class="hljs-title class_">CacheModule</span>.<span class="hljs-title function_">register</span>(),  ],  <span class="hljs-attr">controllers</span>: [    <span class="hljs-title class_">FeishuController</span>  ],  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">FeishuService</span>],})<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserModule</span> { }</code></pre><p>å¦‚æœéœ€è¦åœ¨å…¶ä»–åœ°æ–¹ä¹Ÿä½¿ç”¨ç¼“å­˜ï¼Œä½†åˆä¸æƒ³æ¯æ¬¡éƒ½å¼•å…¥
      <code>CacheModule</code>ï¼Œä¹Ÿå¯ä»¥åœ¨ <code>app.module.ts</code> ä¸­å¼•å…¥ï¼Œè·Ÿ <code>ConfigModule</code>
      å¼€å¯å…¨å±€é…ç½®å³å¯ï¼š</p><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">CacheModule</span>, <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.controller'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.service'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user/user.module'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;<span class="hljs-keyword">import</span> { getConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils'</span>;<span class="hljs-meta">@Module</span>({  <span class="hljs-attr">imports</span>: [    <span class="hljs-title class_">CacheModule</span>.<span class="hljs-title function_">register</span>({      <span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span>,    }),    <span class="hljs-title class_">ConfigModule</span>.<span class="hljs-title function_">forRoot</span>({      <span class="hljs-attr">ignoreEnvFile</span>: <span class="hljs-literal">true</span>,      <span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span>,      <span class="hljs-attr">load</span>: [getConfig]    }), <span class="hljs-title class_">UserModule</span>],  <span class="hljs-attr">controllers</span>: [<span class="hljs-title class_">AppController</span>],  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">AppService</span>],})<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> { }</code></pre><blockquote><p>ä¸ºäº†é¡¹ç›®å¼€å‘æ–¹ä¾¿ï¼Œæˆ‘ä»¬çš„é¡¹ç›®é»˜è®¤å¼€å¯å…¨å±€ç¼“å­˜é…ç½®ï¼Œæ‰€ä»¥ä¸éœ€è¦åœ¨
        <code>user.module.ts</code> å†æ¬¡æ³¨å†Œ <code>CacheModule</code></p></blockquote><p>åœ¨
      <code>yaml</code> é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ç¼“å­˜ <code>key</code> => <code>APP_TOKEN_CACHE_KEY</code>ï¼Œæ³¨æ„å¦‚æœä¸æ·»åŠ ç¼“å­˜
      <code>key</code> çš„è¯ï¼Œåœ¨é«˜é€Ÿç¼“å­˜é‡Œé¢å¯ä»¥è¯»å–æ•°æ®ï¼Œä½†æ˜¯åœ¨ä¸‹ä¸€ç« æ›¿æ¢ <code>Redis</code> çš„æ—¶å€™ï¼Œç”±äºæœªé…ç½®
      <code>key</code>ï¼Œç¨‹åºå°†ä½¿ç”¨ <code>undefined</code> è¯»å– <code>Redis</code>ï¼Œå¯¼è‡´
      <code>Redis</code> æŠ¥é”™ã€‚</p><pre><code class="hljs language-yaml"><span class="hljs-attr">APP_TOKEN_CACHE_KEY:</span> <span class="hljs-string">APP_TOKEN_CACHE_KEY</span></code></pre><ol
      start="3"><li>æ–°å»º <code>src/user/feishu/feishu.service.ts</code></li></ol><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">CACHE_MANAGER</span>, <span class="hljs-title class_">Inject</span>, <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">Logger</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<span class="hljs-keyword">import</span> {  getAppToken,  getUserAccessToken,  getUserToken,  refreshUserToken,} <span class="hljs-keyword">from</span> <span class="hljs-string">'src/helper/feishu/auth'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Cache</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'cache-manager'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessException</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/common/exceptions/business.exception'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;<span class="hljs-meta">@Injectable</span>()<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeishuService</span> {  <span class="hljs-keyword">private</span> <span class="hljs-variable constant_">APP_TOKEN_CACHE_KEY</span>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">    <span class="hljs-meta">@Inject</span>(CACHE_MANAGER) <span class="hljs-keyword">private</span> cacheManager: Cache,    <span class="hljs-keyword">private</span> configService: ConfigService,  </span>) {    <span class="hljs-variable language_">this</span>.<span class="hljs-property">APP_TOKEN_CACHE_KEY</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">configService</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'APP_TOKEN_CACHE_KEY'</span>)  }  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getAppToken</span>(<span class="hljs-params"></span>) {    <span class="hljs-keyword">let</span> <span class="hljs-attr">appToken</span>: <span class="hljs-built_in">string</span>;    appToken = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cacheManager</span>.<span class="hljs-title function_">get</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">APP_TOKEN_CACHE_KEY</span>);    <span class="hljs-keyword">if</span> (!appToken) {      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getAppToken</span>();      <span class="hljs-keyword">if</span> (response.<span class="hljs-property">code</span> === <span class="hljs-number">0</span>) {        <span class="hljs-comment">// token æœ‰æ•ˆæœŸä¸º 2 å°æ—¶ï¼Œåœ¨æ­¤æœŸé—´è°ƒç”¨è¯¥æ¥å£ token ä¸ä¼šæ”¹å˜ã€‚å½“ token æœ‰æ•ˆæœŸå°äº 30 åˆ†çš„æ—¶å€™,å†æ¬¡è¯·æ±‚è·å– token çš„æ—¶å€™ï¼Œä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ tokenï¼Œä¸æ­¤åŒæ—¶è€çš„ token ä¾ç„¶æœ‰æ•ˆã€‚</span>        appToken = response.<span class="hljs-property">app_access_token</span>;        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cacheManager</span>.<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">APP_TOKEN_CACHE_KEY</span>, appToken, {          <span class="hljs-attr">ttl</span>: response.<span class="hljs-property">expire</span> - <span class="hljs-number">60</span>,        });      } <span class="hljs-keyword">else</span> {        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">'é£ä¹¦è°ƒç”¨å¼‚å¸¸'</span>)      }    }    <span class="hljs-keyword">return</span> appToken;  }}</code></pre><p>ä¸ºäº†å’Œç¼“å­˜ç®¡ç†å™¨å®ä¾‹è¿›è¡Œäº¤äº’ï¼Œéœ€è¦ä½¿ç”¨
      <code>CACHE_MANAGER</code> æ ‡è®°å°†å…¶æ³¨å…¥ <code>cacheManager</code> å®ä¾‹ã€‚</p><p><code>Cache</code>
      çš„å®ä¾‹ <code>cacheManager</code>ï¼Œæ‹¥æœ‰ <code>get</code>ã€<code>set</code>ã€<code>del</code>
      ç­‰å¤šä¸ªæ–¹æ³•ï¼Œä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ï¼Œä¹Ÿæä¾›å­˜å‚¨ç¼“å­˜è¿‡æœŸæ—¶é—´çš„é…ç½®é¡¹ <code>ttl</code>ï¼ˆä½äº <code>key</code> ä¸
      <code>value</code>
      ä¹‹åçš„ç¬¬ä¸‰ä¸ªä¼ å…¥å‚æ•°ï¼‰ï¼Œå¯ä»¥æ ¹æ®éœ€æ±‚è‡ªè¡Œé…ç½®ï¼Œä¸Šè¿°ä»£ç å°±æ˜¯é…ç½®äº†ç¼“å­˜æ—¶é—´çš„ç¤ºä¾‹ï¼Œåœ¨æ¢å–ä¸åˆ°å‡­è¯æˆ–è€…æœ¬åœ°ç¼“å­˜è¶…æ—¶ä¹‹åæ‰ä¼šè¯·æ±‚é£ä¹¦çš„æ¥å£æ¢å–æ–°çš„å‡­è¯ã€‚</p><h4>é£ä¹¦æœºå™¨äºº</h4><p>å°è£…å®Œåº”ç”¨å‡­è¯ä¹‹åå°±å¯ä»¥ä½¿ç”¨å‡­è¯è°ƒç”¨é£ä¹¦çš„
      Open APIï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨é£ä¹¦æœºå™¨äººæ¨é€æ¶ˆæ¯ä½œä¸ºä¾‹å­ç»™å¤§å®¶æ¼”ç¤ºä¸€ä¸‹ã€‚</p><ol><li><p>é¦–å…ˆéœ€è¦å¼€å¯æœºå™¨äººçš„èƒ½åŠ›ã€‚<img
            src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6b07f7db3b604a5db992049e0e3447ef~tplv-k3u1fbpfcp-watermark.image?"
            alt="image.png"></p></li><li><p>å‘å¸ƒåº”ç”¨å¹¶é€‰æ‹©åº”ç”¨ä½¿ç”¨èŒƒå›´ï¼Œå¦‚æœä¸åœ¨åº”ç”¨å¯ç”¨èŒƒå›´çš„ç”¨æˆ·ï¼Œæœºå™¨äººæ˜¯æ²¡åŠæ³•æ¨é€æ¶ˆæ¯çš„ã€‚<img
            src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e7a9bee8fb874984850c08acf70cfb22~tplv-k3u1fbpfcp-watermark.image?"
            alt="image.png"></p></li><li><p>å°è£…æœºå™¨äººå‘é€æ¶ˆæ¯å¯¹åº”çš„ APIã€‚</p></li></ol><p>å‘é€æ¶ˆæ¯çš„æ¥å£ä¸º
      <a
        href="https://open.feishu.cn/open-apis/im/v1/messages?receive_id_type=%5B%5D"
        target="_blank" rel="nofollow noopener noreferrer">https://open.feishu.cn/open-apis/im/v1/messages?receive_id_type=[]</a>
      ï¼Œå¯ç”¨æ ¹æ®ä»¥ä¸‹å‡ ç§ç±»å‹å‘é€æ¶ˆæ¯ç»™æŒ‡å®šçš„ç”¨æˆ·æˆ–ç¾¤ç»„ï¼š</p><p><code>Query å‚æ•° receive_id_type</code>
      <strong>å¯é€‰å€¼</strong>ï¼š</p><ul><li><code>open_id</code>ï¼šä»¥ open_id æ¥è¯†åˆ«ç”¨æˆ·(<a
          href="https://open.feishu.cn/document/home/user-identity-introduction/open-id"
          target="_blank" rel="nofollow noopener noreferrer">ä»€ä¹ˆæ˜¯ Open ID</a>) ã€‚</li><li><code>user_id</code>ï¼šä»¥
        user_id æ¥è¯†åˆ«ç”¨æˆ·ï¼Œéœ€è¦æœ‰è·å–ç”¨æˆ· userID çš„æƒé™ (<a
          href="https://open.feishu.cn/document/home/user-identity-introduction/user-id"
          target="_blank" rel="nofollow noopener noreferrer">ä»€ä¹ˆæ˜¯ User ID</a>)ã€‚</li><li><code>union_id</code>ï¼šä»¥
        union_id æ¥è¯†åˆ«ç”¨æˆ·(<a
          href="https://open.feishu.cn/document/home/user-identity-introduction/union-id"
          target="_blank" rel="nofollow noopener noreferrer">ä»€ä¹ˆæ˜¯ Union ID</a>)ã€‚</li><li><code>email</code>ï¼šä»¥
        email æ¥è¯†åˆ«ç”¨æˆ·ï¼Œæ˜¯ç”¨æˆ·çš„çœŸå®é‚®ç®±ã€‚</li><li><code>chat_id</code>ï¼šä»¥ chat_id æ¥è¯†åˆ«ç¾¤èŠï¼Œç¾¤ ID
        è¯´æ˜è¯·å‚è€ƒï¼š<a
          href="https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/im-v1/chat-id-description"
          target="_blank" rel="nofollow noopener noreferrer">ç¾¤ID è¯´æ˜</a> ã€‚</li></ul><p>æ ¹æ®å‘é€ç”¨æˆ·ä¸ä¿¡æ¯çš„ç±»å‹æœ‰å¦‚ä¸‹å‡ ç§å‚æ•°ã€‚</p><p><code>Body</code>
      <strong>å‚æ•°</strong>ï¼š</p><table><thead><tr><th>åç§°</th><th>ç±»å‹</th><th>å¿…å¡«</th><th>æè¿°</th></tr></thead><tbody><tr><td>receive_id</td><td>string</td><td>æ˜¯</td><td>ä¾æ®
            receive_id_type çš„å€¼ï¼Œå¡«å†™å¯¹åº”çš„æ¶ˆæ¯æ¥æ”¶è€… id<strong>ç¤ºä¾‹å€¼</strong>ï¼š"ou_7d8a6e6df7621556ce0d21922b676706ccs"</td></tr><tr><td>content</td><td>string</td><td>æ˜¯</td><td>æ¶ˆæ¯å†…å®¹ï¼Œjson
            ç»“æ„åºåˆ—åŒ–åçš„å­—ç¬¦ä¸²ã€‚ä¸åŒmsg_typeå¯¹åº”ä¸åŒå†…å®¹ã€‚æ¶ˆæ¯ç±»å‹
            åŒ…æ‹¬ï¼štextã€postã€imageã€fileã€audioã€mediaã€stickerã€interactiveã€share_chatã€share_userç­‰ï¼Œå…·ä½“æ ¼å¼è¯´æ˜å‚è€ƒï¼š<a
              href="https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/im-v1/message/create_json"
              target="_blank" rel="nofollow noopener noreferrer">å‘é€æ¶ˆæ¯contentè¯´æ˜</a></td></tr><tr><td>msg_type</td><td>string</td><td>æ˜¯</td><td>æ¶ˆæ¯ç±»å‹
            åŒ…æ‹¬ï¼štextã€postã€imageã€fileã€audioã€mediaã€stickerã€interactiveã€share_chatã€share_userç­‰ï¼Œç±»å‹å®šä¹‰è¯·å‚è€ƒ<a
              href="https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/im-v1/message/create_json"
              target="_blank" rel="nofollow noopener noreferrer">å‘é€æ¶ˆæ¯contentè¯´æ˜</a></td></tr></tbody></table><p>æ ¹æ®ä¸Šè¿°çš„æ¥å£æè¿°ï¼Œå¯ç”¨å°è£…å¦‚ä¸‹çš„å‡½æ•°ï¼š</p><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { methodV } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/utils/request'</span>;<span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-variable constant_">RECEIVE_TYPE</span> { <span class="hljs-string">'open_id'</span>, <span class="hljs-string">'user_id'</span>, <span class="hljs-string">'union_id'</span>, <span class="hljs-string">'email'</span>, <span class="hljs-string">'chat_id'</span> }<span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-variable constant_">MSG_TYPE</span> { text, post, image, file, audio, media, sticker, interactive, share_chat, share_user}<span class="hljs-keyword">type</span> <span class="hljs-variable constant_">MESSAGES_PARAMS</span> = {  <span class="hljs-attr">receive_id</span>: <span class="hljs-built_in">string</span>  <span class="hljs-attr">content</span>: <span class="hljs-built_in">string</span>  <span class="hljs-attr">msg_type</span>: <span class="hljs-variable constant_">MSG_TYPE</span>}<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">messages</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">receive_id_type: RECEIVE_TYPE, params: MESSAGES_PARAMS, app_token: <span class="hljs-built_in">string</span></span>) => {  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(receive_id_type, params, app_token)  <span class="hljs-keyword">const</span> { data } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">methodV</span>({    <span class="hljs-attr">url</span>: <span class="hljs-string">`/im/v1/messages`</span>,    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,    <span class="hljs-attr">query</span>: { receive_id_type },    params,    <span class="hljs-attr">headers</span>: {      <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${app_token}</span>`</span>,    },  });  <span class="hljs-keyword">return</span> data;};</code></pre><ol
      start="4"><li>å¼€å‘å¯¹åº”çš„ <code>Service</code>ã€‚</li></ol><pre><code class="hljs language-ts">  <span class="hljs-keyword">async</span> <span class="hljs-title function_">sendMessage</span>(<span class="hljs-params">receive_id_type, params</span>) {    <span class="hljs-keyword">const</span> app_token = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getAppToken</span>()    <span class="hljs-keyword">return</span> <span class="hljs-title function_">messages</span>(receive_id_type, params, app_token <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>)  }</code></pre><p>æ³¨æ„ï¼šè¿™é‡Œçš„
      <code>app_token</code> è·å–æ–¹å¼ä½¿ç”¨ä¸Šè¿°å°è£…å¥½çš„è®¿é—®å‡­è¯æ–¹æ³•ï¼Œå¸¦æœ‰ç¼“å­˜çš„ç‰ˆæœ¬ã€‚</p><ol start="5"><li>æ–°å»ºå¯¹åº”çš„
        <code>feishu.controller.ts</code> ä»¥åŠ <code>feishu.dto.ts</code>ï¼š</li></ol><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Body</span>, <span class="hljs-title class_">Controller</span>, <span class="hljs-title class_">Post</span>, <span class="hljs-title class_">Version</span>, <span class="hljs-variable constant_">VERSION_NEUTRAL</span>, } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ApiOperation</span>, <span class="hljs-title class_">ApiTags</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/swagger'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FeishuService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./feishu.service'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FeishuMessageDto</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./feishu.dto'</span>;<span class="hljs-meta">@ApiTags</span>(<span class="hljs-string">'é£ä¹¦'</span>)<span class="hljs-meta">@Controller</span>(<span class="hljs-string">'feishu'</span>)<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeishuController</span> {  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> feishuService: FeishuService</span>) { }  <span class="hljs-meta">@ApiOperation</span>({    <span class="hljs-attr">summary</span>: <span class="hljs-string">'æ¶ˆæ¯æ¨é€'</span>,  })  <span class="hljs-meta">@Version</span>([<span class="hljs-variable constant_">VERSION_NEUTRAL</span>])  <span class="hljs-meta">@Post</span>(<span class="hljs-string">'sendMessage'</span>)  <span class="hljs-title function_">sendMessage</span>(<span class="hljs-params"><span class="hljs-meta">@Body</span>() params: FeishuMessageDto</span>) {    <span class="hljs-keyword">const</span> { receive_id_type, ...rest } = params    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">feishuService</span>.<span class="hljs-title function_">sendMessage</span>(receive_id_type, rest);  }}</code></pre><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">RECEIVE_TYPE</span>, <span class="hljs-variable constant_">MSG_TYPE</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/helper/feishu/message'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ApiProperty</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/swagger'</span>;<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeishuMessageDto</span> {  <span class="hljs-meta">@ApiProperty</span>({ <span class="hljs-attr">example</span>: <span class="hljs-string">'email'</span>})  <span class="hljs-attr">receive_id_type</span>: <span class="hljs-variable constant_">RECEIVE_TYPE</span>  <span class="hljs-meta">@ApiProperty</span>({ <span class="hljs-attr">example</span>: <span class="hljs-string">'cookieboty@qq.com'</span> })  receive_id?: <span class="hljs-built_in">string</span>  <span class="hljs-meta">@ApiProperty</span>({ <span class="hljs-attr">example</span>: <span class="hljs-string">'{"text":" test content"}'</span> })  content?: <span class="hljs-built_in">string</span>  <span class="hljs-meta">@ApiProperty</span>({ <span class="hljs-attr">example</span>: <span class="hljs-string">'text'</span>, <span class="hljs-attr">enum</span>: <span class="hljs-variable constant_">MSG_TYPE</span> })  msg_type?: keyof <span class="hljs-variable constant_">MSG_TYPE</span>}</code></pre><ol
      start="6"><li>æ­£å¸¸å¯¼å…¥ <code>Module</code> ä¹‹åï¼Œæ‰“å¼€ <code>swagger</code>
        å¯ä»¥çœ‹åˆ°å¯¹åº”çš„æ¥å£ä¿¡æ¯ã€‚</li></ol><p><img
        src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d8dd231ebdd648129c393dd01fc3c1e2~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><ol start="7"><li>ç‚¹å‡» <strong>Try it out</strong>
        å‘é€æµ‹è¯•ä¿¡æ¯ï¼Œå¦‚æœæŒ‰ç…§æ­¥éª¤ä¸€è·¯ä¸‹æ¥çš„è¯ï¼Œåº”è¯¥èƒ½æ­£å¸¸æ”¶åˆ°é£ä¹¦æœºå™¨äººæ¨é€çš„æ¶ˆæ¯äº†ã€‚</li></ol><p><img
        src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eca80f9932d048e9b049c41d8515e29b~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><p>ä»¥ä¸Šå°±å®Œæˆäº†é£ä¹¦æœºå™¨äººæ¨é€æ¶ˆæ¯çš„å¼€å‘ï¼Œå¤§å®¶å¯ä»¥å‘æŒ¥è‡ªå·±çš„æƒ³è±¡ï¼Œçœ‹åœ¨ä»€ä¹ˆåœºæ™¯éœ€è¦æ¨é€æ¶ˆæ¯ï¼Œä¾‹å¦‚ï¼š<code>CICD</code>ã€å®‰å…¨é¢„è­¦ã€æµç¨‹æµè½¬ã€<code>Bug</code>
      é€šçŸ¥ç­‰ç­‰å„ç§åœºæ™¯æ¨é€ã€‚</p><p>åŒæ—¶ï¼Œé£ä¹¦æœºå™¨çš„æ¶ˆæ¯æœ‰å¾ˆå¤šä¸ªæ€§åŒ–çš„è®¾è®¡ï¼Œä¾‹å¦‚å¡ç‰‡æ¶ˆæ¯ã€å¯Œæ–‡æœ¬ã€è¯­éŸ³ç­‰ç­‰ï¼Œå¡ç‰‡æ¶ˆæ¯é£ä¹¦ä¹Ÿæä¾›äº†<a
        href="https://open.feishu.cn/tool/cardbuilder" target="_blank"
        rel="nofollow noopener noreferrer">å¯è§†åŒ–æ­å»ºçš„å·¥å…·</a>ï¼Œéå¸¸æ–¹ä¾¿å®šåˆ¶åŒ–ä¸€å¥—æ¼‚äº®çš„å¡ç‰‡æ¶ˆæ¯ï¼š</p><p><img
        src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6608a7fe10e446449f548bdb2056c80f~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><blockquote><p><strong>é£ä¹¦å‘é€æ¶ˆæ¯ä½¿ç”¨çš„é‚®ç®±ä¸ä½ ç™»å½•æ³¨å†Œé‚®ç®±å¹¶ä¸ç›¸åŒ</strong>ï¼Œæœ‰ä¸å°‘åŒå­¦ä¼šå¡åœ¨è¿™ä¸€æ­¥ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨é‚®ç®±å‘é€çš„åŒå­¦éœ€è¦åœ¨ç®¡ç†å‘˜åå°é…ç½®è¯¥ç”¨æˆ·çš„é‚®ç®±æ‰èƒ½æ­£å¸¸å‘é€ä¿¡æ¯ï¼Œæˆ–è€…å¯ä»¥ä½¿ç”¨æ‰‹æœºå·ã€ç”¨æˆ·
        id æ¥å‘é€æ¶ˆæ¯ã€‚<strong>åŒæ—¶è¦æ³¨æ„å‘é€æ¶ˆæ¯çš„æœºå™¨äººè¦å…·å¤‡æ¨é€æ¶ˆæ¯çš„æƒé™</strong>ã€‚</p></blockquote><h4>å®Œå–„ä½“éªŒ</h4><p>å‰é¢çš„æµç¨‹éƒ½æ˜¯æ­£å¸¸è¯·æ±‚ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹éæ­£å¸¸è¯·æ±‚ã€‚é¦–å…ˆï¼Œå°†
      <code>receive_id_type</code> çš„ç±»å‹æ”¹æˆ <code>email2</code>ï¼Œè¿™ä¸ªå‚æ•°æ²¡æœ‰å­˜åœ¨äºé£ä¹¦æ–‡æ¡£ä¸­æä¾›çš„å‚æ•°ç±»å‹ä¸­ï¼Œç„¶åè¯·æ±‚æ¥å£ï¼š</p><p><img
        src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/825fe40a83e746b79e9256a51d5e70a9~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿”å›çš„æ¥å£æ˜¯ä¸šåŠ¡æ€§è´¨çš„é€šç”¨æŠ¥é”™
      503ï¼Œä½†æˆ‘ä»¬å·²ç»é¢„å…ˆçŸ¥é“äº†è¯·æ±‚å‚æ•°ç±»å‹æœ‰å‡ ç§ï¼Œè¿™ç§é”™è¯¯å¯ä»¥åœ¨è¯·æ±‚é£ä¹¦ä¹‹åå°±é¢„å…ˆæ ¡éªŒå‡ºæ¥ï¼Œå‡å°‘è¯·æ±‚æ¬¡æ•°åŒæ—¶ç»™äºˆç”¨æˆ·æ­£ç¡®çš„åé¦ˆï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©
      <code>class-validator</code> æ¥åšå…¥å‚æ ¡éªŒï¼š</p><ol><li>å®‰è£… <code>class-validator</code>
        ç›¸å…³çš„ä¾èµ–ã€‚</li></ol><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">$ </span><span class="bash">yarn add class-validator class-transformer</span></code></pre><ol
      start="2"><li><code>main.ts</code> æ·»åŠ  <code>ValidationPipe</code> éªŒè¯ç®¡é“ï¼Œä»
        <code>@nestjs/common</code> å¯¼å‡ºã€‚</li></ol><pre><code class="hljs language-diff"><span class="hljs-addition">+import { ValidationPipe, VersioningType, VERSION_NEUTRAL } from '@nestjs/common';</span>import { NestFactory } from '@nestjs/core';import {  FastifyAdapter,  NestFastifyApplication,} from '@nestjs/platform-fastify';import { AppModule } from './app.module';import { AllExceptionsFilter } from './common/exceptions/base.exception.filter';import { HttpExceptionFilter } from './common/exceptions/http.exception.filter';import { TransformInterceptor } from './common/interceptors/transform.interceptor';import { generateDocument } from './doc';declare const module: any;async function bootstrap() {  const app = await NestFactory.create&#x3C;NestFastifyApplication>(    AppModule,    new FastifyAdapter(),  );  // ç»Ÿä¸€å“åº”ä½“æ ¼å¼  app.useGlobalInterceptors(new TransformInterceptor());  // å¼‚å¸¸è¿‡æ»¤å™¨  app.useGlobalFilters(new AllExceptionsFilter(), new HttpExceptionFilter());  // æ¥å£ç‰ˆæœ¬åŒ–ç®¡ç†  app.enableVersioning({    defaultVersion: [VERSION_NEUTRAL, '1', '2'],    type: VersioningType.URI,  });<span class="hljs-addition">+  // å¯åŠ¨å…¨å±€å­—æ®µæ ¡éªŒï¼Œä¿è¯è¯·æ±‚æ¥å£å­—æ®µæ ¡éªŒæ­£ç¡®ã€‚</span><span class="hljs-addition">+  app.useGlobalPipes(new ValidationPipe());</span>  // åˆ›å»ºæ–‡æ¡£  generateDocument(app)  // æ·»åŠ çƒ­æ›´æ–°  if (module.hot) {    module.hot.accept();    module.hot.dispose(() => app.close());  }  await app.listen(3000);}bootstrap();</code></pre><ol
      start="3"><li>ä½¿ç”¨ <code>class-validator</code> å†…ç½®çš„éªŒè¯è£…é¥°å™¨å¯¹éœ€è¦éªŒè¯çš„ Dto å‚æ•°æ·»åŠ æ ¡éªŒã€‚</li></ol><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">RECEIVE_TYPE</span>, <span class="hljs-variable constant_">MSG_TYPE</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/helper/feishu/message'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ApiProperty</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/swagger'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">IsNotEmpty</span>, <span class="hljs-title class_">IsEnum</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'class-validator'</span>;<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeishuMessageDto</span> {  <span class="hljs-meta">@IsNotEmpty</span>()  <span class="hljs-meta">@IsEnum</span>(<span class="hljs-variable constant_">RECEIVE_TYPE</span>)  <span class="hljs-meta">@ApiProperty</span>({ <span class="hljs-attr">example</span>: <span class="hljs-string">'email'</span> })  <span class="hljs-attr">receive_id_type</span>: <span class="hljs-variable constant_">RECEIVE_TYPE</span>  <span class="hljs-meta">@IsNotEmpty</span>()  <span class="hljs-meta">@ApiProperty</span>({ <span class="hljs-attr">example</span>: <span class="hljs-string">'cookieboty@qq.com'</span> })  receive_id?: <span class="hljs-built_in">string</span>  <span class="hljs-meta">@IsNotEmpty</span>()  <span class="hljs-meta">@ApiProperty</span>({ <span class="hljs-attr">example</span>: <span class="hljs-string">'{"text":" test content"}'</span> })  content?: <span class="hljs-built_in">string</span>  <span class="hljs-meta">@IsNotEmpty</span>()  <span class="hljs-meta">@IsEnum</span>(<span class="hljs-variable constant_">MSG_TYPE</span>)  <span class="hljs-meta">@ApiProperty</span>({ <span class="hljs-attr">example</span>: <span class="hljs-string">'text'</span> })  msg_type?: <span class="hljs-variable constant_">MSG_TYPE</span>}</code></pre><p>æˆ‘ä»¬ä½¿ç”¨äº†
      <code>IsNotEmpty</code>ï¼ˆç¦æ­¢ä¼ ç©ºï¼‰ä»¥åŠ <code>IsEnum</code>(å‚æ•°å¿…é¡»æ˜¯æœ‰æ•ˆçš„æšä¸¾ï¼‰æ¥çº¦æŸå‰ç«¯ä¼ å‚æ•°ï¼Œç„¶åä¸€èµ·æ¥çœ‹çœ‹æ•ˆæœï¼š</p><p><img
        src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cfcfaad80df64c5880949e773fe0f2bd~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç”±äº <code>email2</code> å¹¶ä¸å­˜åœ¨äºä¹‹å‰å®šä¹‰å¥½çš„æšä¸¾ <code>RECEIVE_TYPE</code>
      é‡Œé¢ï¼Œæ‰€ä»¥åœ¨å‚æ•°æ ¡éªŒçš„æ—¶å€™å°±è¢«æ‹¦æˆªå¹¶ä¸”è¿”å›äº†å…·ä½“çš„é”™è¯¯ä¿¡æ¯ <code>receive_id_type must be a valid enum
        value</code>ï¼Œå¯¹äºå‰ç«¯ä¼ å‚æ•°ä¸é”™è¯¯æç¤ºæ¯”è¾ƒå‹å¥½ã€‚</p><p>å†…ç½®çš„éªŒè¯è£…é¥°å™¨éå¸¸å¤šï¼Œä¸‹é¢åªæ˜¯ç®€å•çš„ä¸€äº›ä¾‹å­ï¼Œæ›´å¤šçš„è£…é¥°å™¨å¯ä»¥<a
        href="https://github.com/typestack/class-validator" target="_blank"
        rel="nofollow noopener noreferrer">ç¿»é˜…æ–‡æ¡£</a></p><table><thead><tr><th>è£…é¥°å™¨</th><th>æè¿°</th></tr></thead><tbody><tr><td><strong>å¸¸è§çš„éªŒè¯è£…é¥°å™¨</strong></td><td></td></tr><tr><td><code>@IsDefined(value:
              any)</code></td><td>æ£€æŸ¥å€¼æ˜¯å¦å·²å®šä¹‰ï¼ˆ!== undefined, !== nullï¼‰ã€‚è¿™æ˜¯å”¯ä¸€å¿½ç•¥
            skipMissingProperties é€‰é¡¹çš„è£…é¥°å™¨ã€‚</td></tr><tr><td><code>@IsOptional()</code></td><td>æ£€æŸ¥ç»™å®šå€¼æ˜¯å¦ä¸ºç©ºï¼ˆ===
            nullï¼Œ=== undefinedï¼‰ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å¿½ç•¥è¯¥å±æ€§ä¸Šçš„æ‰€æœ‰éªŒè¯å™¨ã€‚</td></tr><tr><td><code>@Equals(comparison:
              any)</code></td><td>æ£€æŸ¥å€¼æ˜¯å¦ç­‰äº ("===") æ¯”è¾ƒã€‚</td></tr><tr><td><code>@NotEquals(comparison:
              any)</code></td><td>æ£€æŸ¥å€¼æ˜¯å¦ä¸ç­‰äº ("!==") æ¯”è¾ƒã€‚</td></tr><tr><td><code>@IsEmpty()</code></td><td>æ£€æŸ¥ç»™å®šå€¼æ˜¯å¦ä¸ºç©ºï¼ˆ===
            ''ã€=== nullã€=== æœªå®šä¹‰ï¼‰ã€‚</td></tr><tr><td><code>@IsNotEmpty()</code></td><td>æ£€æŸ¥ç»™å®šå€¼æ˜¯å¦ä¸ä¸ºç©ºï¼ˆï¼==
            ''ï¼Œï¼== nullï¼Œï¼== undefinedï¼‰ã€‚</td></tr><tr><td><code>@IsIn(values:
              any[])</code></td><td>æ£€æŸ¥å€¼æ˜¯å¦åœ¨å…è®¸å€¼çš„æ•°ç»„ä¸­ã€‚</td></tr><tr><td><code>@IsNotIn(values:
              any[])</code></td><td>æ£€æŸ¥ value æ˜¯å¦ä¸åœ¨ä¸å…è®¸çš„å€¼æ•°ç»„ä¸­ã€‚</td></tr><tr><td><strong>ç±»å‹éªŒè¯è£…é¥°å™¨</strong></td><td></td></tr><tr><td><code>@IsBoolean()</code></td><td>æ£€æŸ¥å€¼æ˜¯å¦ä¸ºå¸ƒå°”å€¼ã€‚</td></tr><tr><td><code>@IsDate()</code></td><td>æ£€æŸ¥å€¼æ˜¯å¦ä¸ºæ—¥æœŸã€‚</td></tr><tr><td><code>@IsString()</code></td><td>æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦ä¸ºå­—ç¬¦ä¸²ã€‚</td></tr><tr><td><code>@IsNumber(options:
              IsNumberOptions)</code></td><td>æ£€æŸ¥å€¼æ˜¯å¦ä¸ºæ•°å­—ã€‚</td></tr><tr><td><code>@IsInt()</code></td><td>æ£€æŸ¥å€¼æ˜¯å¦ä¸ºæ•´æ•°ã€‚</td></tr><tr><td><code>@IsArray()</code></td><td>æ£€æŸ¥å€¼æ˜¯å¦ä¸ºæ•°ç»„</td></tr><tr><td><code>@IsEnum(entity:
              object)</code></td><td>æ£€æŸ¥å€¼æ˜¯å¦æ˜¯æœ‰æ•ˆçš„æšä¸¾</td></tr></tbody></table><ol
      start="4"><li>å®Œæˆäº†å‚æ•°æ ¡éªŒåï¼Œè¿˜å‰©ä¸‹æœ€åä¸€æ­¥ï¼Œå…ˆçœ‹ä¸‹ç°åœ¨çš„æ–‡æ¡£æè¿°ã€‚</li></ol><p><img
        src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/db00ae1e05024339b3a14e9fe61609e2~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><p>ä»ä¸Šè¿°é¡µé¢ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ¥å£å­—æ®µæè¿°ä½¿ç”¨ <code>enum</code>
      ç±»å‹åœ¨å±•ç¤ºä¸Šå¹¶ä¸ç›´è§‚ï¼Œå¯¹æ¥çš„å‰ç«¯åŒå­¦æ— æ³•æ„ŸçŸ¥åˆ°åº•ç”¨äº†ä»€ä¹ˆã€éœ€è¦ä¼ ä»€ä¹ˆå€¼æ‰èƒ½ç¬¦åˆè¦æ±‚ï¼Œè¿™ä¸ªå¯ä»¥ä½¿ç”¨ <code>Swagger</code> ä¸­
      <code>ApiProperty</code> çš„ <code>enum</code> å‚æ•°ï¼Œæ¥è®©æ–‡æ¡£è¯†åˆ«å‡ºå¯¹åº”çš„æšä¸¾å‚æ•°ï¼š</p><pre><code class="hljs language-ts">  <span class="hljs-meta">@IsNotEmpty</span>()  <span class="hljs-meta">@IsEnum</span>(<span class="hljs-variable constant_">RECEIVE_TYPE</span>)  <span class="hljs-meta">@ApiProperty</span>({ <span class="hljs-attr">example</span>: <span class="hljs-string">'email'</span>, <span class="hljs-attr">enum</span>: <span class="hljs-variable constant_">RECEIVE_TYPE</span> })  <span class="hljs-attr">receive_id_type</span>: <span class="hljs-variable constant_">RECEIVE_TYPE</span></code></pre><p>é…ç½®å®Œæ¯•ä¹‹åå¯ä»¥çœ‹åˆ°
      <code>Swagger</code> çš„å­—æ®µæè¿°ä¹Ÿèƒ½å°†å¯¹åº”çš„æšä¸¾æ­£ç¡®æ˜¾ç¤ºäº†</p><p><img
        src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a7fa969b31964fa3b43b1bcc264dc4b9~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><h2>å†™åœ¨æœ€å</h2><p>æœ¬ç« çš„ç¤ºä¾‹ä»£ç ä»¥ä¸Šä¼  <a
        href="https://github.com/boty-design/gateway/tree/demo/v5"
        target="_blank" rel="nofollow noopener noreferrer">demo/v5</a>ï¼Œéœ€è¦çš„åŒå­¦è‡ªå–ã€‚</p><p>æœ¬ç« ä»¥<strong>å¯¹æ¥é£ä¹¦åº”ç”¨</strong>å®Œæˆäº†ä¸€ä¸ªç®€å•çš„ä¸šåŠ¡åç«¯éœ€æ±‚å¼€å‘ï¼ŒåŒ…æ‹¬é£ä¹¦
      <strong>Open Api</strong> çš„å¯¹æ¥ä»¥åŠ<strong>NestJs</strong> çš„ç¼“å­˜ã€<code>Controller</code>ã€<code>Service</code>
      ç­‰æ¨¡å—çš„å¼€å‘ï¼Œä»å°çš„éœ€æ±‚é€æ­¥ç†Ÿæ‚‰ <code>NestJs</code> æ¡†æ¶çš„å¼€å‘æ¨¡å¼ä¸åç«¯ä¸šåŠ¡å¼€å‘é€»è¾‘ã€‚</p><p>é£ä¹¦çš„ä¸‰æ–¹åº”ç”¨è¿˜æä¾›äº†å¾ˆå¤šé¢å¤–çš„å¤–éƒ¨æ¥å£ï¼Œä¾‹å¦‚é£ä¹¦æ–‡æ¡£ã€ç»„ç»‡æ¶æ„ï¼ˆäººå‘˜ä¿¡æ¯ç®¡ç†ï¼‰ã€å®¡æ‰¹ç­‰ç­‰éƒ½æ˜¯éå¸¸æœ‰ç”¨å¤„çš„åŠŸèƒ½ï¼Œåœ¨æ¥ä¸‹å»çš„ç”¨æˆ·ç³»ç»Ÿä¸­æˆ‘ä»¬å°±ä¼šä½¿ç”¨ç»„ç»‡æ¶æ„ä¸­çš„æ¥å£ä½œä¸ºè‡ªå»ºç”¨æˆ·ç³»ç»Ÿçš„åº•å±‚æ•°æ®ä¸ä¸‰æ–¹ç™»å½•ã€‚</p><p>å¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±å›¢é˜Ÿçš„éœ€æ±‚é€‰æ‹©å¯¹åº”çš„æ¨¡å—æ¥å‡å°‘å¼€å‘å·¥ä½œé‡ï¼Œæ¯”å¦‚å®¡æ‰¹çš„ä»»åŠ¡æµå¼€å‘å°±éå¸¸éº»çƒ¦ï¼Œå°±ç®—æœ‰å¼€æºçš„æ’ä»¶é›†æˆï¼Œè¿˜æ˜¯éœ€è¦é¢å¤–å¯¹æ¥æ¶ˆæ¯é€šçŸ¥ã€‚è€Œç›´æ¥åˆ©ç”¨é£ä¹¦æä¾›çš„å®¡æ‰¹æ¥å£ä¸ä»…èƒ½å‡å°‘ä»£ç é‡ã€æé«˜å¼€å‘æ•ˆç‡åŒæ—¶ä¹Ÿæ‰“é€šé£ä¹¦çš„äº¤äº’ï¼Œç»™ç”¨æˆ·æœ€å°çš„å¿ƒæ™ºå­¦ä¹ æˆæœ¬ã€‚</p><p>å¦‚æœä½ æœ‰ä»€ä¹ˆç–‘é—®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºæå‡ºæˆ–è€…åŠ ç¾¤æ²Ÿé€šã€‚
      ğŸ‘</p>
  </body>
</html>