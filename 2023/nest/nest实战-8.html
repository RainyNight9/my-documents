<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
  </head>
  <body>
    <h2>前言</h2><p>统一的用户中心作为基础服务，为了方便团队同学使用，一般会将 <strong>OA</strong>
      系统、钉钉、飞书、企业微信等等各种第三方常用服务的用户数据打通，使得团队成员可以快速登录。</p><p>在 <a
        href="https://juejin.cn/book/6948353204648148995" target="_blank"
        rel="nofollow noopener noreferrer">DevOps 小册</a>中，我们使用了 <code>GitLab</code>
      作为三方应用授权，避免用户重复登录，飞书也提供了一样的三方授权能力。</p><p>在本章中，我们将学习使用 <code>NestJS</code>
      的守卫模块结合之前封装过的飞书<strong>用户模块</strong>进行三方授权登录，并保存用户信息，为用户系统的业务开发做完最后一步的准备工作。</p><h2>飞书对接</h2><p>飞书应用第三方网站免登的步骤如下。</p><ol><li>网页后端发现用户未登录，<a
          href="https://open.feishu.cn/document/ukTMukTMukTM/ukzN4UjL5cDO14SO3gTN"
          target="_blank" rel="nofollow noopener noreferrer">请求身份验证</a>；</li><li>用户登录后，开放平台生成登录预授权码，302跳转至重定向地址。</li><li>网页后端调用<a
          href="https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/authen-v1/authen/access_token"
          target="_blank" rel="nofollow noopener noreferrer">获取登录用户身份</a>校验登录预授权码合法性，获取到用户身份。</li><li>如需其他用户信息，网页后端可调用<a
          href="https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/authen-v1/authen/user_info"
          target="_blank" rel="nofollow noopener noreferrer">获取用户信息（身份验证）</a>。</li></ol><p>授权流程图如下所示：</p><p><img
        src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0fff3a5fc92c432ea5aa09cf3a392c74~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><p>接下来，我们按照步骤逐步实现飞书的三方授权</p><h4>请求用户身份验证</h4><p><strong>第一步</strong>：开启网页能力并配置重定向链接。</p><p><img
        src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d66663a5eba541b08f55a711c23449ce~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><p>如上图所示，点击网页菜单开启网页能力之后，在安全设置菜单中，添加回调 URL
      地址。这里我们使用的是 <code>http://127.0.0.1:8080/auth</code>，你可以根据自己的喜好来设定。</p><p><strong>第二步</strong>：请求用户身份验证。</p><p>根据飞书的文档组装身份验证请求接口：<code>https://open.feishu.cn/open-apis/authen/v1/index?redirect_uri={REDIRECT_URI}&#x26;app_id={APPID}&#x26;state={STATE}
      </code>，参数说明如下所示：</p><table><thead><tr><th>参数</th><th>类型</th><th>必须</th><th>说明</th></tr></thead><tbody><tr><td>redirect_uri</td><td>string</td><td>是</td><td>重定向
            <code>URL</code>（使用第一步配置的重定向 <code>URL</code> 即可）</td></tr><tr><td>app_id</td><td>string</td><td>是</td><td>固定的应用标识，在应用后台【凭证和基础信息】中可见</td></tr><tr><td>state</td><td>string</td><td>否</td><td>用来维护请求和回调状态的附加字符串，
            在授权完成回调时会附加此参数，应用可以根据此字符串来判断上下文关系</td></tr></tbody></table><p>所以对于我们的应用，请求身份的链接为：<code>https://open.feishu.cn/open-apis/authen/v1/index?app_id=cli_xxxxxxd&#x26;redirect_uri=http%3A%2F%2F127.0.0.1%3A8080%2Fauth</code>，在浏览器直接输入此链接如果出现如下的飞书授权界面，则代表我们已经正常配置成功了：</p><p><img
        src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/24e4a3045ab94e42a991f28f82ecff48~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><p><strong>第三步</strong>：获取登录预授权码。这一步比较简单，正常出现飞书应用授权的界面之后，点击授权【<strong>按钮</strong>】即可获取到对应的登录预授权码。</p><p><img
        src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5a69e15e58894e7e92d06c26cf58861b~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><p>出现上图的界面并不意外，毕竟这个链接是随便填写的，飞书并不会真的去校验这个链接是否真实存在。当我们点击授权之后，它会将登录预授权码放在重定向
      <code>URL</code> 的 <code>code</code> 参数中直接转发，所以即使这个请求是假的，也能顺利拿到对应的 <code>code</code>。</p><p><strong>第四步</strong>：获取用户凭证。在这一步中，使用第三步获取到的登录预授权码，也就是重定向
      <code>URL Query</code> 参数中的 <code>code</code> 向飞书换取真正的用户凭证，注意 <code>code</code>
      的有效期只有 <strong>5</strong> 分钟，且只能使用一次，过期或已使用的 <code>code</code>
      都无法再次换取真实用户凭证。</p><ol><li>在 <code>src/helper/feishu/auth.ts</code>
        中添加新的换取用户凭证方法：</li></ol><pre><code class="hljs language-ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getUserToken</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">{ code, app_token }</span>) => {  <span class="hljs-keyword">const</span> { data } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">methodV</span>({    <span class="hljs-attr">url</span>: <span class="hljs-string">`/authen/v1/access_token`</span>,    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,    <span class="hljs-attr">headers</span>: {      <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${app_token}</span>`</span>,    },    <span class="hljs-attr">params</span>: {      <span class="hljs-attr">grant_type</span>: <span class="hljs-string">'authorization_code'</span>,      code,    },  });  <span class="hljs-keyword">return</span> data;};</code></pre><ol
      start="2"><li>在 <code>src/user/feishu/feishu.service.ts</code>
        中添加新的换取用户凭证的 <code>Service</code>：</li></ol><pre><code class="hljs language-ts"><span class="hljs-keyword">async</span> <span class="hljs-title function_">getUserToken</span>(<span class="hljs-params">code: <span class="hljs-built_in">string</span></span>) {    <span class="hljs-keyword">const</span> app_token = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getAppToken</span>()    <span class="hljs-keyword">const</span> <span class="hljs-attr">dto</span>: <span class="hljs-title class_">GetUserTokenDto</span> = {      code,      app_token    };    <span class="hljs-keyword">const</span> <span class="hljs-attr">res</span>: <span class="hljs-built_in">any</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUserToken</span>(dto);    <span class="hljs-keyword">if</span> (res.<span class="hljs-property">code</span> !== <span class="hljs-number">0</span>) {      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(res.<span class="hljs-property">msg</span>);    }    <span class="hljs-keyword">return</span> res.<span class="hljs-property">data</span>;}</code></pre><ol
      start="3"><li>在 <code>src/user/feishu/feishu.controller.ts</code>
        中添加新的换取用户凭证的 <code>Controller</code>：</li></ol><pre><code class="hljs language-ts">  <span class="hljs-meta">@ApiOperation</span>({    <span class="hljs-attr">summary</span>: <span class="hljs-string">'获取用户凭证'</span>,  })  <span class="hljs-meta">@Post</span>(<span class="hljs-string">'getUserToken'</span>)  <span class="hljs-title function_">getUserToken</span>(<span class="hljs-params"><span class="hljs-meta">@Body</span>() params: GetUserTokenDto</span>) {    <span class="hljs-keyword">const</span> { code } = params    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">feishuService</span>.<span class="hljs-title function_">getUserToken</span>(code);  }</code></pre><ol
      start="4"><li>在 <code>feishu.dto.ts</code> 中添加新的 <code>GetUserTokenDto</code>：</li></ol><pre><code>export class GetUserTokenDto {  @IsNotEmpty()  @ApiProperty({ example: 'xxxx', description: '飞书临时登录凭证' })  code: string;  app_token: string;}</code></pre><p>打开
      <strong>Swagger</strong> 调试 <code>getUserToken</code>
      接口，将第三步获取的临时登录凭证输入参数调试。如果配置正常的话，此时可以拿到飞书的用户信息和真实的用户凭证 <code>access_token</code>，以及
      <code>refresh_token</code> 等回调值。</p><p><img
        src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/aa7ca11c948648cd86c7bd3b66e61925~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><p>之后可以将 <code>access_token</code> 的值缓存起来，使用 <code>access_token</code>
      调用飞书提供的任意接口，但前提是这个应用拥有对应的模块接口权限才能够正常调用。</p><p><strong>第五步</strong>:
      刷新用户凭证。安全起见，飞书获取的 <code>access_token</code> 和 <code>refresh_token</code>
      均存在有效期。<code>access_token</code> 的有效期为 <strong>2</strong>
      小时，过期之前可以通过有效期更长的 <code>refresh_token</code> 缓存新的 <code>access_token</code>，来保证能够正常调用飞书接口。</p><ol><li>在
        <code>src/helper/feishu/auth.ts</code> 中新增刷新用户 <code>access_token</code>
        方法：</li></ol><pre><code class="hljs language-ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">refreshUserToken</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">{ refreshToken, app_token }</span>) => {  <span class="hljs-keyword">const</span> { data } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">methodV</span>({    <span class="hljs-attr">url</span>: <span class="hljs-string">`/authen/v1/refresh_access_token`</span>,    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,    <span class="hljs-attr">headers</span>: {      <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${app_token}</span>`</span>,    },    <span class="hljs-attr">params</span>: {      <span class="hljs-attr">grant_type</span>: <span class="hljs-string">'refresh_token'</span>,      <span class="hljs-attr">refresh_token</span>: refreshToken,      app_token,    },  });  <span class="hljs-keyword">return</span> data;};</code></pre><ol
      start="2"><li>在 <code>src/user/feishu/feishu.service.ts</code> 中添加<strong>刷新</strong>、<strong>存储</strong>、<strong>读取</strong>
        <code>access_token</code> 的 <code>Service</code>：</li></ol><pre><code class="hljs language-ts">  <span class="hljs-keyword">async</span> <span class="hljs-title function_">setUserCacheToken</span>(<span class="hljs-params">tokenInfo: <span class="hljs-built_in">any</span></span>) {    <span class="hljs-keyword">const</span> {      refresh_token,      access_token,      user_id,      expires_in,      refresh_expires_in,    } = tokenInfo;    <span class="hljs-comment">// 缓存用户的 token</span>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cacheManager</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.USER_TOKEN_CACHE_KEY}</span>_<span class="hljs-subst">${user_id}</span>`</span>, access_token, {      <span class="hljs-attr">ttl</span>: expires_in - <span class="hljs-number">60</span>,    });    <span class="hljs-comment">// 缓存用户的 fresh token</span>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cacheManager</span>.<span class="hljs-title function_">set</span>(      <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.USER_REFRESH_TOKEN_CACHE_KEY}</span>_<span class="hljs-subst">${user_id}</span>`</span>,      refresh_token,      {        <span class="hljs-attr">ttl</span>: refresh_expires_in - <span class="hljs-number">60</span>,      },    );  }  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getCachedUserToken</span>(<span class="hljs-params">userId: <span class="hljs-built_in">string</span></span>) {    <span class="hljs-keyword">let</span> <span class="hljs-attr">userToken</span>: <span class="hljs-built_in">string</span> = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cacheManager</span>.<span class="hljs-title function_">get</span>(       <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.USER_TOKEN_CACHE_KEY}</span>_<span class="hljs-subst">${userId}</span>`</span>,    );    <span class="hljs-comment">// 如果 token 失效</span>    <span class="hljs-keyword">if</span> (!userToken) {      <span class="hljs-keyword">const</span> <span class="hljs-attr">refreshToken</span>: <span class="hljs-built_in">string</span> = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cacheManager</span>.<span class="hljs-title function_">get</span>(        <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.USER_REFRESH_TOKEN_CACHE_KEY}</span>_<span class="hljs-subst">${userId}</span>`</span>,      );      <span class="hljs-keyword">if</span> (!refreshToken) {        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>({          <span class="hljs-attr">code</span>: <span class="hljs-variable constant_">BUSINESS_ERROR_CODE</span>.<span class="hljs-property">TOKEN_INVALID</span>,          <span class="hljs-attr">message</span>: <span class="hljs-string">'token 已失效'</span>,        });      }      <span class="hljs-comment">// 获取新的用户 token</span>      <span class="hljs-keyword">const</span> usrTokenInfo = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUserTokenByRefreshToken</span>(refreshToken);      <span class="hljs-comment">// 更新缓存的用户 token</span>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setUserCacheToken</span>(usrTokenInfo);      userToken = usrTokenInfo.<span class="hljs-property">access_token</span>;    }    <span class="hljs-keyword">return</span> userToken;  }  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getUserTokenByRefreshToken</span>(<span class="hljs-params">refreshToken: <span class="hljs-built_in">string</span></span>) {    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">refreshUserToken</span>({      refreshToken,      <span class="hljs-attr">app_token</span>: <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getAppToken</span>(),    });  }</code></pre><p>根据方法名可以清晰地知道对应的功能，我就不过多介绍了。至此，飞书应用的三方授权模块对接完毕。</p><h2>鉴权与登录</h2><p>上述步骤只是对接了飞书应用，还不足够完成登录态。接下来，我们要借助
      <code>NestJS</code> 提供的 <code>Guards</code> 模块、<code>Passport</code> 与
      <code>JWT</code> 来完成登录模块的开发。</p><p>首选需要安装对应的依赖：</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">$ </span><span class="bash">yarn add @nestjs/passport passport</span><span class="hljs-meta prompt_">$ </span><span class="bash">yarn add -D @types/passport-local</span><span class="hljs-meta prompt_">$ </span><span class="bash">yarn add @nestjs/jwt passport-jwt</span><span class="hljs-meta prompt_">$ </span><span class="bash">yarn add @fastify/cookie</span></code></pre><p><strong>第一步</strong>：新建
      <code>src/auth/auth.service.ts</code>。</p><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">JwtService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/jwt'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FeishuUserInfo</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/user/feishu/feishu.dto'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FeishuService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/user/feishu/feishu.service'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/user/user.mongo.entity'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/user/user.service'</span>;<span class="hljs-meta">@Injectable</span>()<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthService</span> {  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">    <span class="hljs-keyword">private</span> jwtService: JwtService,    <span class="hljs-keyword">private</span> userService: UserService,    <span class="hljs-keyword">private</span> feishuService: FeishuService,  </span>) { }  <span class="hljs-comment">// 验证飞书用户 </span>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">validateFeishuUser</span>(<span class="hljs-attr">code</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-title class_">Payload</span>> {    <span class="hljs-keyword">const</span> <span class="hljs-attr">feishuInfo</span>: <span class="hljs-title class_">FeishuUserInfo</span> = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getFeishuTokenByApplications</span>(      code,    );    <span class="hljs-comment">// 将飞书的用户信息同步到数据库</span>    <span class="hljs-keyword">const</span> <span class="hljs-attr">user</span>: <span class="hljs-title class_">User</span> = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">createOrUpdateByFeishu</span>(      feishuInfo,    );    <span class="hljs-keyword">return</span> {      <span class="hljs-attr">userId</span>: user.<span class="hljs-property">id</span>,      <span class="hljs-attr">username</span>: user.<span class="hljs-property">username</span>,      <span class="hljs-attr">name</span>: user.<span class="hljs-property">name</span>,      <span class="hljs-attr">email</span>: user.<span class="hljs-property">email</span>,      <span class="hljs-attr">feishuAccessToken</span>: feishuInfo.<span class="hljs-property">accessToken</span>,      <span class="hljs-attr">feishuUserId</span>: feishuInfo.<span class="hljs-property">feishuUserId</span>,    };  }<span class="hljs-comment">// jwt 登录</span>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">user: Payload</span>) {    <span class="hljs-keyword">return</span> {      <span class="hljs-attr">access_token</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">jwtService</span>.<span class="hljs-title function_">sign</span>(user),    };  }<span class="hljs-comment">// 获取飞书用户信息</span>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getFeishuTokenByApplications</span>(<span class="hljs-params">code: <span class="hljs-built_in">string</span></span>) {    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">feishuService</span>.<span class="hljs-title function_">getUserToken</span>(code);    <span class="hljs-keyword">const</span> <span class="hljs-attr">feishuInfo</span>: <span class="hljs-title class_">FeishuUserInfo</span> = {      <span class="hljs-attr">accessToken</span>: data.<span class="hljs-property">access_token</span>,      <span class="hljs-attr">avatarBig</span>: data.<span class="hljs-property">avatar_big</span>,      <span class="hljs-attr">avatarMiddle</span>: data.<span class="hljs-property">avatar_middle</span>,      <span class="hljs-attr">avatarThumb</span>: data.<span class="hljs-property">avatar_thumb</span>,      <span class="hljs-attr">avatarUrl</span>: data.<span class="hljs-property">avatar_url</span>,      <span class="hljs-attr">email</span>: data.<span class="hljs-property">email</span>,      <span class="hljs-attr">enName</span>: data.<span class="hljs-property">en_name</span>,      <span class="hljs-attr">mobile</span>: data.<span class="hljs-property">mobile</span>,      <span class="hljs-attr">name</span>: data.<span class="hljs-property">name</span>,      <span class="hljs-attr">feishuUnionId</span>: data.<span class="hljs-property">union_id</span>,      <span class="hljs-attr">feishuUserId</span>: data.<span class="hljs-property">user_id</span>,    };    <span class="hljs-keyword">return</span> feishuInfo;  }}</code></pre><p>上述代码中分为两个模块，一个是获取飞书用户信息以及对获取到的用户信息本地落库，另外一个是调用
      <code>jwtService</code> 进行登录。</p><p><strong>第二步</strong>：新建 <code>/src/auth/strategies</code>
      目录，添加 <code>feishu-auth.strategy.ts</code> 与 <code>jwt-auth.strategy.ts</code>
      两个文件：</p><pre><code class="hljs language-ts"><span class="hljs-comment">// feishu-auth.strategy.ts</span><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PassportStrategy</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/passport'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">Query</span>, <span class="hljs-title class_">UnauthorizedException</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AuthService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../auth.service'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Strategy</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'passport-custom'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FastifyRequest</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'fastify'</span><span class="hljs-meta">@Injectable</span>()<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeishuStrategy</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">PassportStrategy</span>(<span class="hljs-title class_">Strategy</span>, <span class="hljs-string">'feishu'</span>) {  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> authService: AuthService</span>) {    <span class="hljs-variable language_">super</span>();  }  <span class="hljs-keyword">async</span> <span class="hljs-title function_">validate</span>(<span class="hljs-attr">req</span>: <span class="hljs-title class_">FastifyRequest</span>): <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-title class_">Payload</span>> {    <span class="hljs-keyword">const</span> <span class="hljs-attr">q</span>: <span class="hljs-built_in">any</span> = req.<span class="hljs-property">query</span>;    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">authService</span>.<span class="hljs-title function_">validateFeishuUser</span>(q.<span class="hljs-property">code</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>);    <span class="hljs-keyword">if</span> (!user) {      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnauthorizedException</span>();    }    <span class="hljs-keyword">return</span> user;  }}</code></pre><pre><code class="hljs language-ts"><span class="hljs-comment">// jwt-auth.strategy.ts</span><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PassportStrategy</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/passport'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Strategy</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'passport-jwt'</span>;<span class="hljs-keyword">import</span> { jwtConstants } <span class="hljs-keyword">from</span> <span class="hljs-string">'../constants'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FastifyRequest</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"fastify"</span>;<span class="hljs-keyword">const</span> cookieExtractor = <span class="hljs-keyword">function</span> (<span class="hljs-params">req: FastifyRequest</span>) {  <span class="hljs-keyword">let</span> token = <span class="hljs-literal">null</span>;  <span class="hljs-keyword">if</span> (req &#x26;&#x26; req.<span class="hljs-property">cookies</span>) {    token = req.<span class="hljs-property">cookies</span>[<span class="hljs-string">'jwt'</span>];  }  <span class="hljs-keyword">return</span> token;};<span class="hljs-meta">@Injectable</span>()<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtStrategy</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">PassportStrategy</span>(<span class="hljs-title class_">Strategy</span>) {  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {    <span class="hljs-variable language_">super</span>({      <span class="hljs-attr">jwtFromRequest</span>: cookieExtractor,      <span class="hljs-attr">ignoreExpiration</span>: jwtConstants.<span class="hljs-property">ignoreExpiration</span>,      <span class="hljs-attr">secretOrKey</span>: jwtConstants.<span class="hljs-property">secret</span>,    });  }  <span class="hljs-keyword">async</span> <span class="hljs-title function_">validate</span>(<span class="hljs-attr">payload</span>: <span class="hljs-title class_">Payload</span>): <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-title class_">Payload</span>> {    <span class="hljs-keyword">return</span> { ...payload };  }}</code></pre><p><code>FeishuStrategy</code>
      根据 <code>passport</code> 提供的方法，自定义了飞书的专属策略，调用 <code>authService</code> 中的
      <code>validateFeishuUser</code> 方法，从飞书获取对应的用户信息。<code>JwtStrategy</code>
      则是使用 <code>passport-jwt</code>拓展的功能，对 <code>cookie</code> 做了拦截、解密等功能。</p><p>注意无论是使用
      <code>passport</code> 自带的三方功能或者自行拓展 <code>passport</code>，都需要对 <code>validate</code>
      方法进行重写以便实现自己的业务逻辑。</p><p><strong>第三步</strong>：新建 <code>/src/auth/guards</code>
      目录，添加 <code>feishu-auth.guard.ts</code> 与 <code>jwt-auth.guard.ts</code>
      两个文件：</p><pre><code class="hljs language-ts"><span class="hljs-comment">// feishu-auth.guard.ts</span><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AuthGuard</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/passport'</span>;<span class="hljs-meta">@Injectable</span>()<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeishuAuthGuard</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">AuthGuard</span>(<span class="hljs-string">'feishu'</span>) { }</code></pre><p>这里要<strong>注意</strong>，因为
      <code>FeishuAuthGuard</code> 已经继承了通用的 <code>AuthGuard</code>，验证逻辑在 <code>FeishuStrategy</code>
      实现了，所以并没有额外的代码出现，如果有其他的逻辑则需要对不同的方法进行重写已完成需求。</p><pre><code class="hljs language-ts"><span class="hljs-comment">// jwt-auth.guard.ts</span><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ExecutionContext</span>, <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Reflector</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AuthGuard</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/passport'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">BUSINESS_ERROR_CODE</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/common/exceptions/business.error.codes'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessException</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/common/exceptions/business.exception'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">IS_PUBLIC_KEY</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../constants'</span>;<span class="hljs-meta">@Injectable</span>()<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtAuthGuard</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">AuthGuard</span>(<span class="hljs-string">'jwt'</span>) {  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> reflector: Reflector</span>) {    <span class="hljs-variable language_">super</span>();  }  <span class="hljs-title function_">canActivate</span>(<span class="hljs-params">context: ExecutionContext</span>) {    <span class="hljs-keyword">const</span> loginAuth = <span class="hljs-variable language_">this</span>.<span class="hljs-property">reflector</span>.<span class="hljs-property">getAllAndOverride</span>&#x3C;<span class="hljs-built_in">boolean</span>>(<span class="hljs-variable constant_">IS_PUBLIC_KEY</span>, [      context.<span class="hljs-title function_">getHandler</span>(),      context.<span class="hljs-title function_">getClass</span>(),    ]);    <span class="hljs-keyword">if</span> (loginAuth) {      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;    }    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">canActivate</span>(context);  }  <span class="hljs-title function_">handleRequest</span>(<span class="hljs-params">err, user, info</span>) {    <span class="hljs-keyword">if</span> (err || !user) {      <span class="hljs-keyword">throw</span> (        err ||        <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>({          <span class="hljs-attr">code</span>: <span class="hljs-variable constant_">BUSINESS_ERROR_CODE</span>.<span class="hljs-property">TOKEN_INVALID</span>,          <span class="hljs-attr">message</span>: <span class="hljs-string">'token 已失效'</span>,        })      );    }    <span class="hljs-keyword">return</span> user;  }}</code></pre><p><code>JwtAuthGuard</code>
      模块实现了 <code>canActivate</code> 与 <code>handleRequest</code>
      的重写，分别是针对于自定义逻辑与异常捕获的处理。</p><p>因为我们使用了 <code>JwtAuthGuard</code>
      作为全局验证，但有的时候也是需要针对于部分接口开启白名单。例如，登录接口就需要开启白名单，毕竟把登录接口也拦截了，整个项目就无法正常使用了。</p><p><strong>第四步</strong>：在<strong>第二步</strong>中，<code>FeishuStrategy</code>
      将获取到的飞书用户信息返回出来，被路由守卫挂载到 <code>request</code>
      上，用户信息里面的内容会在后期频繁使用到，所以我们自定义一个用户的装饰器 <code>PayloadUser</code>，方便后期使用。</p><pre><code class="hljs language-ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">PayloadUser</span> = <span class="hljs-title function_">createParamDecorator</span>(  (data, <span class="hljs-attr">ctx</span>: <span class="hljs-title class_">ExecutionContext</span>): <span class="hljs-function"><span class="hljs-params">Payload</span> =></span> {    <span class="hljs-keyword">const</span> request = ctx.<span class="hljs-title function_">switchToHttp</span>().<span class="hljs-title function_">getRequest</span>();    <span class="hljs-keyword">return</span> request.<span class="hljs-property">user</span>;  },);</code></pre><p><strong>第五步</strong>：新建
      <code>src/auth/auth.controller.ts</code>。</p><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> {  <span class="hljs-title class_">Controller</span>,  <span class="hljs-title class_">UseGuards</span>,  <span class="hljs-title class_">Res</span>,  <span class="hljs-title class_">Get</span>,  <span class="hljs-title class_">Query</span>,  <span class="hljs-variable constant_">VERSION_NEUTRAL</span>,} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FeishuAuthGuard</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./guards/feishu-auth.guard'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AuthService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./auth.service'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ApiOperation</span>, <span class="hljs-title class_">ApiTags</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/swagger'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">GetTokenByApplications</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./auth.dto'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Public</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./constants'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PayloadUser</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/helper'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FastifyReply</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'fastify'</span><span class="hljs-meta">@ApiTags</span>(<span class="hljs-string">'用户认证'</span>)<span class="hljs-meta">@Controller</span>({  <span class="hljs-attr">path</span>: <span class="hljs-string">'auth'</span>,  <span class="hljs-attr">version</span>: [<span class="hljs-variable constant_">VERSION_NEUTRAL</span>]})<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthController</span> {  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">    <span class="hljs-keyword">private</span> authService: AuthService,  </span>) { }  <span class="hljs-meta">@ApiOperation</span>({    <span class="hljs-attr">summary</span>: <span class="hljs-string">'飞书 Auth2 授权登录'</span>,    <span class="hljs-attr">description</span>: <span class="hljs-string">'通过 code 获取`access_token`https://open.feishu.cn/open-apis/authen/v1/index?app_id=cli_xxxxxx&#x26;redirect_uri=http%3A%2F%2F127.0.0.1%3A8080%2Fauth'</span>,  })  <span class="hljs-meta">@UseGuards</span>(<span class="hljs-title class_">FeishuAuthGuard</span>)  <span class="hljs-meta">@Public</span>()  <span class="hljs-meta">@Get</span>(<span class="hljs-string">'/feishu/auth2'</span>)  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getFeishuTokenByApplications</span>(<span class="hljs-params">    <span class="hljs-meta">@PayloadUser</span>() user: Payload,    <span class="hljs-meta">@Res</span>({ passthrough: <span class="hljs-literal">true</span> }) response: FastifyReply,    <span class="hljs-meta">@Query</span>() query: GetTokenByApplications,  </span>) {    <span class="hljs-keyword">const</span> { access_token } = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">authService</span>.<span class="hljs-title function_">login</span>(user);    response.<span class="hljs-title function_">setCookie</span>(<span class="hljs-string">'jwt'</span>, access_token, {      <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>,    });    <span class="hljs-keyword">return</span> access_token  }  <span class="hljs-meta">@ApiOperation</span>({    <span class="hljs-attr">summary</span>: <span class="hljs-string">'解析 token'</span>,    <span class="hljs-attr">description</span>: <span class="hljs-string">'解析 token 信息'</span>,  })  <span class="hljs-meta">@Get</span>(<span class="hljs-string">'/token/info'</span>)  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getTokenInfo</span>(<span class="hljs-params"><span class="hljs-meta">@PayloadUser</span>() user: Payload</span>) {    <span class="hljs-keyword">return</span> user;  }}</code></pre><p><code>/src/helper/index.ts</code>
      的内容如下：</p><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { createParamDecorator, <span class="hljs-title class_">ExecutionContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">PayloadUser</span> = <span class="hljs-title function_">createParamDecorator</span>(  (data, <span class="hljs-attr">ctx</span>: <span class="hljs-title class_">ExecutionContext</span>): <span class="hljs-function"><span class="hljs-params">Payload</span> =></span> {    <span class="hljs-keyword">const</span> request = ctx.<span class="hljs-title function_">switchToHttp</span>().<span class="hljs-title function_">getRequest</span>();    <span class="hljs-keyword">return</span> request.<span class="hljs-property">user</span>;  },);</code></pre><p>由于
      <code>Payload</code> 这种类型的申明会频繁使用到，所以可以创建全局类型申明文件来使用，新建 <code>types/globle.d.ts</code>
      文件，根据自己的需求定制即可:</p><pre><code>declare type Payload = {  status?: number;  userId: number;  username: string;  name: string;  email: string;  feishuAccessToken: string;  feishuUserId: string;  department?: string;  departmentId?: string;};</code></pre><p>在
      <code>getFeishuTokenByApplications</code> 方法中我们使用了 <code>@UseGuards(FeishuAuthGuard)</code>
      与 <code>@Public()</code> 两个装饰器，分别是飞书应用授权拦截与开启接口白名单。</p><p>在经过了 <code>@UseGuards(FeishuAuthGuard)</code>
      之后，可以使用 <code>@PayloadUser</code> 获取到的飞书用户信息，再将用户信息进行 <code>JWT</code> 注册。</p><p><strong>第六步</strong>：新建
      <code>/src/auth/auth.module.ts</code>。</p><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/user/user.module'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AuthService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./auth.service'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">JwtStrategy</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./strategies/jwt-auth.strategy'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PassportModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/passport'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">JwtModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/jwt'</span>;<span class="hljs-keyword">import</span> { jwtConstants } <span class="hljs-keyword">from</span> <span class="hljs-string">'./constants'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AuthController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./auth.controller'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FeishuStrategy</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./strategies/feishu-auth.strategy'</span>;<span class="hljs-meta">@Module</span>({  <span class="hljs-attr">imports</span>: [    <span class="hljs-title class_">UserModule</span>,    <span class="hljs-title class_">PassportModule</span>,    <span class="hljs-title class_">JwtModule</span>.<span class="hljs-title function_">register</span>({      <span class="hljs-attr">secret</span>: jwtConstants.<span class="hljs-property">secret</span>,      <span class="hljs-attr">signOptions</span>: { <span class="hljs-attr">expiresIn</span>: jwtConstants.<span class="hljs-property">expiresIn</span> },    }),  ],  <span class="hljs-attr">controllers</span>: [<span class="hljs-title class_">AuthController</span>],  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">AuthService</span>, <span class="hljs-title class_">JwtStrategy</span>, <span class="hljs-title class_">FeishuStrategy</span>],  <span class="hljs-attr">exports</span>: [<span class="hljs-title class_">AuthService</span>],})<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthModule</span> { }</code></pre><p>将
      <code>JwtModule</code> 在 <code>AuthModule</code> 中注册，并将其他的 <code>Controller</code>、<code>Services</code>
      等都导入，最后记得将 <code>AuthModule</code> 导入 <code>app.module.ts</code>：</p><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">CacheModule</span>, <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user/user.module'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;<span class="hljs-keyword">import</span> { getConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils'</span>;<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> redisStore <span class="hljs-keyword">from</span> <span class="hljs-string">'cache-manager-redis-store'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">APP_GUARD</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">JwtAuthGuard</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./auth/guards/jwt-auth.guard'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AuthModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./auth/auth.module'</span>;<span class="hljs-meta">@Module</span>({  <span class="hljs-attr">imports</span>: [    <span class="hljs-title class_">CacheModule</span>.<span class="hljs-title function_">register</span>({      <span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span>,      <span class="hljs-attr">store</span>: redisStore,      <span class="hljs-attr">host</span>: <span class="hljs-title function_">getConfig</span>(<span class="hljs-string">'REDIS_CONFIG'</span>).<span class="hljs-property">host</span>,      <span class="hljs-attr">port</span>: <span class="hljs-title function_">getConfig</span>(<span class="hljs-string">'REDIS_CONFIG'</span>).<span class="hljs-property">port</span>,      <span class="hljs-attr">auth_pass</span>: <span class="hljs-title function_">getConfig</span>(<span class="hljs-string">'REDIS_CONFIG'</span>).<span class="hljs-property">auth</span>,      <span class="hljs-attr">db</span>: <span class="hljs-title function_">getConfig</span>(<span class="hljs-string">'REDIS_CONFIG'</span>).<span class="hljs-property">db</span>    }),    <span class="hljs-title class_">ConfigModule</span>.<span class="hljs-title function_">forRoot</span>({      <span class="hljs-attr">ignoreEnvFile</span>: <span class="hljs-literal">true</span>,      <span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span>,      <span class="hljs-attr">load</span>: [getConfig]    }),    <span class="hljs-title class_">UserModule</span>,    <span class="hljs-title class_">AuthModule</span>  ],  <span class="hljs-attr">controllers</span>: [],  <span class="hljs-attr">providers</span>: [    {      <span class="hljs-attr">provide</span>: <span class="hljs-variable constant_">APP_GUARD</span>,      <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">JwtAuthGuard</span>,    },  ],})<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> { }</code></pre><p><code>/src/auth/constants.ts</code>
      的内容如下：</p><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">SetMetadata</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> jwtConstants = {  <span class="hljs-attr">secret</span>: <span class="hljs-string">'yyds'</span>, <span class="hljs-comment">// 秘钥，不对外公开。</span>  <span class="hljs-attr">expiresIn</span>: <span class="hljs-string">'15s'</span>, <span class="hljs-comment">// 时效时长</span>  <span class="hljs-attr">ignoreExpiration</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否忽略 token 时效</span>};<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">IS_PUBLIC_KEY</span> = <span class="hljs-string">'isPublic'</span>;<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">Public</span> = (<span class="hljs-params"></span>) => <span class="hljs-title class_">SetMetadata</span>(<span class="hljs-variable constant_">IS_PUBLIC_KEY</span>, <span class="hljs-literal">true</span>);</code></pre><p><strong>第七步</strong>：修改
      <code>main.ts</code> 注册 <code>@fastify/cookie</code></p><pre><code class="hljs language-diff">import { ValidationPipe, VersioningType, VERSION_NEUTRAL } from '@nestjs/common';import { NestFactory } from '@nestjs/core';import {  FastifyAdapter,  NestFastifyApplication,} from '@nestjs/platform-fastify';import fastify from 'fastify';import { AppModule } from './app.module';import { AllExceptionsFilter } from './common/exceptions/base.exception.filter';import { HttpExceptionFilter } from './common/exceptions/http.exception.filter';import { TransformInterceptor } from './common/interceptors/transform.interceptor';import { FastifyLogger } from './common/logger';import { generateDocument } from './doc';<span class="hljs-addition">+import fastifyCookie from '@fastify/cookie';</span>declare const module: any;async function bootstrap() {  const fastifyInstance = fastify({    logger: FastifyLogger,  })  const app = await NestFactory.create&#x3C;NestFastifyApplication>(    AppModule,    new FastifyAdapter(fastifyInstance)  );<span class="hljs-addition">+  app.register(fastifyCookie, {</span><span class="hljs-addition">+    secret: 'my-secret', // for cookies signature</span><span class="hljs-addition">+  });</span>  // 统一响应体格式  app.useGlobalInterceptors(new TransformInterceptor());  // 异常过滤器  app.useGlobalFilters(new AllExceptionsFilter(), new HttpExceptionFilter());  // 接口版本化管理  app.enableVersioning({    defaultVersion: [VERSION_NEUTRAL, '1', '2'],    type: VersioningType.URI,  });  // 启动全局字段校验，保证请求接口字段校验正确。  app.useGlobalPipes(new ValidationPipe());  // 创建文档  generateDocument(app)  // 添加热更新  if (module.hot) {    module.hot.accept();    module.hot.dispose(() => app.close());  }  await app.listen(3000);}bootstrap();</code></pre><p>将飞书应用对接中获取的临时登录凭证填入
      <code>Swagger</code> 测试接口中执行，如下图所示，<code>JWT Token</code> 已经正常返回了，并且被
      <code>NestJS</code> 后端注入到 <code>cookie</code> 中：</p><p><img
        src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d3c0c63fde7340768c588847f4e3e0d9~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><p><strong>第八步</strong>：一般来说，登录权限需要全局开启，只有少部分的接口通过白名单开放给外部使用，所以需要将
      <code>JWT</code> 的自定义路由挂载到全局，修改 <code>app.module.ts</code>，添加全局 <code>APP_GUARD</code>
      模块。</p><pre><code class="hljs language-js"><span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">APP_GUARD</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>;@<span class="hljs-title class_">Module</span>({  <span class="hljs-attr">imports</span>: [    <span class="hljs-title class_">CacheModule</span>.<span class="hljs-title function_">register</span>({      <span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span>,      <span class="hljs-attr">store</span>: redisStore,      <span class="hljs-attr">host</span>: <span class="hljs-title function_">getConfig</span>(<span class="hljs-string">'REDIS_CONFIG'</span>).<span class="hljs-property">host</span>,      <span class="hljs-attr">port</span>: <span class="hljs-title function_">getConfig</span>(<span class="hljs-string">'REDIS_CONFIG'</span>).<span class="hljs-property">port</span>,      <span class="hljs-attr">auth_pass</span>: <span class="hljs-title function_">getConfig</span>(<span class="hljs-string">'REDIS_CONFIG'</span>).<span class="hljs-property">auth</span>,      <span class="hljs-attr">db</span>: <span class="hljs-title function_">getConfig</span>(<span class="hljs-string">'REDIS_CONFIG'</span>).<span class="hljs-property">db</span>    }),    <span class="hljs-title class_">ConfigModule</span>.<span class="hljs-title function_">forRoot</span>({      <span class="hljs-attr">ignoreEnvFile</span>: <span class="hljs-literal">true</span>,      <span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span>,      <span class="hljs-attr">load</span>: [getConfig]    }),    <span class="hljs-title class_">AuthModule</span>,    <span class="hljs-title class_">UserModule</span>  ],  <span class="hljs-attr">controllers</span>: [],  <span class="hljs-attr">providers</span>: [    {      <span class="hljs-attr">provide</span>: <span class="hljs-variable constant_">APP_GUARD</span>,      <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">JwtAuthGuard</span>,    },  ],})</code></pre><p>在正常写入
      <code>JWT Token</code> 以及添加全局 <code>JWT</code> 路由拦截后，可以通过 <code>Swagger</code>
      中的 <code>/token/info</code> 接口来测试是否能正常解析 <code>token</code>
      的信息，如果一切正常的话，则出现如下图界面：</p><p><img
        src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0b4c6feb3cb24695827ad5b0bd64ecc7~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><h2>写在最后</h2><p>本章示例代码以上传 <a
        href="https://github.com/boty-design/gateway/tree/demo/v9"
        target="_blank" rel="nofollow noopener noreferrer">demo/v9</a>，文中示例已经是大部分的完整代码了，除了
      <code>User</code> 模块的实体类可以根据自己的类型来处理，如若需要的同学可以拉取代码对比。</p><p>本章主要介绍了如何利用飞书的三方接口以及
      <code>NestJS</code> 提供的 <code>Guards</code> 能力，使用 <code>Passport</code> 与
      <code>JWT</code> 来完成第三方应用授权的功能，减少用户的使用成本。</p><p>其中，我们学习了 <code>Guards</code>
      模块、<code>Passport</code> 以及 <code>JWT</code> 的相关知识，有兴趣的同学可以与其他的框架如 <code>Egg</code>
      的接入做一个对比，<strong>设计理念</strong>与<strong>代码编写</strong>的不同可以从登录功能的实现中深刻体会到。</p><p>另外，本章并未过多的介绍
      <code>Guards</code> 模块，<code>NestJS</code>
      源文档对此的描述已经足够完备，想要了解更多的细节或者设计可以去源文档直接查阅，作为实战类型的小册，本章之后的主体内容将聚焦在如何完成业务开发上，不会再针对某一个模块功能做更详细的解释。</p><p>如果你有什么疑问，欢迎在评论区提出或者加群沟通。
      👏</p>
  </body>
</html>