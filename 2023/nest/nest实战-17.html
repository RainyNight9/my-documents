<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
  </head>
  <body>
    <h2>å‰è¨€</h2><p>å¦‚æœå·²ç»å­¦ä¹ åˆ°äº†è¿™ä¸€ç« ï¼Œç›¸ä¿¡ä½ å·²ç»è‡³å°‘å°†ä¹‹å‰çš„é¡¹ç›®åšäº†ä¸€ä¸ªå¤§æ¦‚çš„é›å½¢å‡ºæ¥äº†ã€‚</p><p>æ— è®ºæ˜¯å‚è€ƒç¤ºä¾‹è¿˜æ˜¯å…¨éƒ¨é è‡ªå·±åšå‡ºæ¥çš„ï¼Œæ€»ä¹‹æ­å–œä½ å·²ç»åº¦è¿‡äº†åœ¨ä¸€ä¸ªé¡¹ç›®å¼€å‘å‘¨æœŸä¸­çš„æœ€å¼€å¿ƒçš„æ—¶åˆ»ï¼Œå› ä¸ºä¹‹å‰æ¯ä¸€é¡¹åŠŸèƒ½çš„å®Œæˆï¼Œå¸¦æ¥çš„éƒ½æ˜¯ä¸€ä¸ªä¸ªçš„æˆå°±æ„Ÿï¼Œè®©äººèƒ½åšæŒä¸‹æ¥å¹¶ä¸”ä¹æ­¤ä¸å½¼çš„æ˜¯åœ¨æ—…é€”ä¸­èƒ½ä¸æ–­çš„å®Œæˆä¸€äº›é˜¶æ®µæ€§çš„ç›®æ ‡ï¼Œä½†æ¥ä¸‹æ¥è¦åšçš„æˆ‘çŒœæ˜¯å¤§éƒ¨åˆ†çš„å¼€å‘éƒ½æœ‰ç‚¹å¤´ç–¼çš„æ˜¯äº‹æƒ…ï¼Œå› ä¸ºæœ¬ç« å¼€å§‹æˆ‘ä»¬éœ€è¦å†™è‡ªåŠ¨åŒ–æµ‹è¯•ç”¨ä¾‹äº†ã€‚</p><h2>NestJS
      è‡ªåŠ¨åŒ–æµ‹è¯•</h2><p>ä¸€ä¸ªé¡¹ç›®çš„è´¨é‡éœ€è¦é ä»€ä¹ˆæ¥ä¿è¯ï¼Œè‚¯å®šä¸æ˜¯çœ‹å¼€å‘äººå‘˜çš„ç»éªŒï¼Œåªè¦æ˜¯äººä¸€å®šä¼šçŠ¯é”™ï¼Œæ²¡æœ‰å®Œç¾çš„äººä¹Ÿæ²¡æœ‰å®Œç¾çš„ç¨‹åºã€‚ä½†ä»æ¦‚ç‡å­¦ä¸Šæ¥è¯´æœºå™¨ä¸€å®šæ˜¯æ¯”è¾ƒé è°±çš„ï¼Œæ¯•ç«Ÿåªæœ‰é€»è¾‘è€Œæ²¡æœ‰æ„Ÿæƒ…ï¼Œæ‰€ä»¥è‡ªåŠ¨åŒ–æµ‹è¯•èƒ½å¤Ÿç»™äºˆé¡¹ç›®ä¸€å®šçš„è´¨é‡å’Œæ€§èƒ½ä¿è¯ï¼ŒåŒæ—¶ä¸€ä¸ªé¡¹ç›®çš„è‡ªåŠ¨æµ‹æµ‹è¯•ç”¨ä¾‹è¦†ç›–è¶Šå…¨é¢ï¼Œå¯¹äºæµ‹è¯•åŒå­¦çš„è´Ÿæ‹…ä¹Ÿå°±è¶Šå°‘ã€‚</p><p>è‡ªåŠ¨åŒ–æµ‹è¯•æœ‰éå¸¸å¤šçš„ç±»å‹æœ‰å•å…ƒæµ‹è¯•ï¼Œç«¯åˆ°ç«¯(<code>e2e</code>)æµ‹è¯•ï¼Œé›†æˆæµ‹è¯•ç­‰ç­‰ï¼Œè‡ªåŠ¨æµ‹è¯•çš„æ¡†æ¶ä¹Ÿéå¸¸å¤šï¼Œæ‰€å¹¸<code>NestJS</code>
      æä¾›äº†å†…ç½®å¼€ç®±å³ç”¨çš„ <a href="https://github.com/facebook/jest" target="_blank"
        rel="nofollow noopener noreferrer">Jest</a> å’Œ <a
        href="https://github.com/visionmedia/supertest" target="_blank"
        rel="nofollow noopener noreferrer">SuperTest</a> é›†æˆï¼Œä»¥åŠåœ¨æµ‹è¯•ç¯å¢ƒä¸­å¯ä»¥æ¨¡æ‹Ÿ <code>NestJS</code>
      çš„ä¾èµ–æ³¨å…¥ä½“ç³»ï¼Œæ›´æ–¹ä¾¿çš„æµ‹è¯•æ¨¡å—ï¼Œè¿™æ ·ä½¿å¾—æˆ‘ä»¬å¯ä»¥é™ä½ä¸€å®šçš„é€‰æ‹©å›°éš¾ç—‡ï¼Œç›´æ¥ä½¿ç”¨ <code>NestJS</code> é›†æˆçš„å³å¯ã€‚</p><blockquote><p>å½“ç„¶ä½ ä»ç„¶å¯ä»¥é€‰æ‹©è‡ªå·±ç†Ÿæ‚‰çš„è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶ï¼ˆä¾‹å¦‚ï¼š<a
          href="https://mochajs.org/" target="_blank" rel="nofollow noopener
          noreferrer">mocha</a>ï¼‰æ¥ä½¿ç”¨ï¼Œ<code>NestJS</code> æ¡†æ¶å¹¶æœªå¯¹ä½ åšè¿‡å¤šçš„é™åˆ¶ï¼Œåªæ˜¯å¤„äº <code>NestJS</code>
        çš„ä½“ç³»å½“ä¸­ï¼Œé™¤éæœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œå¦åˆ™è¿˜æ˜¯å»ºè®®ä½¿ç”¨è‡ªå¸¦çš„æµ‹è¯•åŠŸèƒ½ã€‚</p></blockquote><h4>Unit TEST</h4><p>é¦–å…ˆå®‰è£…
      <code>NestJS</code> æµ‹è¯•å·¥å…·çš„ä¾èµ– <code>@nestjs/testing</code>ï¼Œå¦‚æœæ˜¯ <code>CLI</code>
      åˆ›å»ºçš„è¯å°±ä¸éœ€è¦å†å®‰è£…ä¾èµ–äº†ã€‚</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">$ </span><span class="bash">yarn add @nestjs/testing</span></code></pre><p>è¿˜è®°å¾—ä¹‹å‰åœ¨ä½¿ç”¨
      <code>CLI</code> å¿«é€Ÿåˆ›å»ºçš„ <code>*.spec.ts</code> æ–‡ä»¶å—ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦ä½¿ç”¨ä¸Šå®ƒäº†ã€‚</p><p><strong>ç¬¬ä¸€æ­¥</strong>ï¼šåœ¨
      <code>intercepter.controller.ts</code> ä¸­æ–°å¢ä¸€ä¸ªæµ‹è¯•æ–¹æ³•ï¼š</p><pre><code class="hljs language-diff">import {  Controller,  Get,  Req,  Res,} from '@nestjs/common';import { FastifyReply, FastifyRequest } from 'fastify';import { URL } from 'url';import { IntercepterService } from './intercepter.service';@Controller()export class IntercepterController {  constructor(private readonly intercepterService: IntercepterService) { }  @Get('*')  async getApp(@Req() req: FastifyRequest, @Res() res: FastifyReply) {    const urlObj = new URL(req.url, `http://${req.headers.host}`);    console.log(urlObj)    if (urlObj.pathname <span class="hljs-comment">=== '/favicon.ico') return res.send('ico');</span>    const html = await this.intercepterService.readHtml(urlObj);    if (!html) return res.send('404');    res.headers({      'Content-Type': 'text/html',    });    res.send(html);  }<span class="hljs-addition">+  @Get('test')</span><span class="hljs-addition">+  getTest() {</span><span class="hljs-addition">+    return 'test'</span><span class="hljs-addition">+  }</span>}</code></pre><p><strong>ç¬¬äºŒæ­¥</strong>ï¼šæ–°å»º
      <code>intercepter.controller.spec.ts</code>ï¼Œä¸€èˆ¬å•å…ƒæµ‹è¯•ç”¨ä¾‹ä¸æµ‹è¯•æ¨¡å—ä¿æŒåœ¨åŒä¸€ä¸ªç›®å½•ä¸‹ã€‚</p><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">IntercepterController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./intercepter.controller'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">IntercepterService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./intercepter.service'</span><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;<span class="hljs-keyword">import</span> { getConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'@app/common'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FastifyRequest</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'fastify'</span>;<span class="hljs-title function_">describe</span>(<span class="hljs-string">'IntercepterController'</span>, <span class="hljs-function">() =></span> {  <span class="hljs-keyword">let</span> <span class="hljs-attr">intercepterController</span>: <span class="hljs-title class_">IntercepterController</span>;  <span class="hljs-keyword">let</span> <span class="hljs-attr">intercepterService</span>: <span class="hljs-title class_">IntercepterService</span>;  <span class="hljs-keyword">let</span> <span class="hljs-attr">configService</span>: <span class="hljs-title class_">ConfigService</span>;  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =></span> {    configService = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConfigService</span>({      <span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span>,      <span class="hljs-attr">load</span>: [getConfig]    })    intercepterService = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntercepterService</span>(configService);    intercepterController = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntercepterController</span>(intercepterService);  });  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'getTest'</span>, <span class="hljs-function">() =></span> {    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should return an html'</span>, <span class="hljs-keyword">async</span> () => { <span class="hljs-comment">//     const result = 'devops';</span>      <span class="hljs-keyword">const</span> result = <span class="hljs-string">'test'</span>;      <span class="hljs-title function_">expect</span>(<span class="hljs-keyword">await</span> intercepterController.<span class="hljs-title function_">getTest</span>()).<span class="hljs-title function_">toBe</span>(result);    });  });});</code></pre><p><strong>ç¬¬ä¸‰æ­¥</strong>ï¼šè¿è¡Œæµ‹è¯•å‘½ä»¤
      <code>yarn test</code>ï¼Œå³å¯è·å¾—å¦‚ä¸‹ç»“æœï¼Œå½“ <code>result</code> åˆ†åˆ«æ˜¯ <code>devops</code>
      ä¸ <code>test</code> çš„æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š</p><p><img
        src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/41fc4c9c93bd48c0bbfbcdd660ed6b46~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><p><img
        src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6bb7d968b9a44d348dfe3766a14fb0b3~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><p>å¦‚ä¸Šä¸€ä¸ªéå¸¸ç®€å•æµ‹è¯•ç”¨ä¾‹å°±å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æŒ‘æˆ˜ä¸€ä¸‹é«˜éš¾çš„æµ‹è¯•ç”¨ä¾‹å¼€å‘ï¼Œæ¥æµ‹è¯•æˆ‘ä»¬ä¹‹å‰çš„ç½‘å…³ä»£ç†æ¥å£ã€‚</p><p>é¦–å…ˆçœ‹ä¸‹
      <code>IntercepterController</code> çš„ <code>getApp</code> è¿™ä¸ªæ–¹æ³•ï¼Œå®ƒçš„å…¥å‚åˆ†åˆ«ä¸º
      <code>@Req</code> ä¸ <code>@Res</code>ï¼Œåœ¨å•å…ƒæµ‹è¯•ä¸­æ˜¯æ²¡æœ‰æ­£å¸¸çš„è¯·æ±‚ä½“çš„ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨å°†è¿™ä¸¤ä¸ªå…¥å‚æ•°æ®æ¨¡æ‹Ÿå‡ºæ¥ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©
      <code>mock-req-res</code> è¿™ä¸ªåº“æ¥ç”Ÿæˆæ¨¡æ‹Ÿå‚æ•°ï¼š</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">$ </span><span class="bash">yarn add mock-req-res</span><span class="hljs-meta prompt_">$ </span><span class="bash">yarn add sinon</span></code></pre><p>åœ¨
      <code>intercepter.controller.spec.ts</code> ä¸­æ–°å¢æµ‹è¯•æ–¹æ³•ï¼š</p><pre><code class="hljs language-dart">  describe(<span class="hljs-string">'getApp'</span>, () => {    it(<span class="hljs-string">'should return devops'</span>, <span class="hljs-keyword">async</span> () => {      <span class="hljs-keyword">const</span> req = mockRequest({        headers: {          host: <span class="hljs-string">'www.cookieboty.com'</span>        },        url: <span class="hljs-string">'/devops'</span>      })      <span class="hljs-keyword">const</span> res = mockResponse()      <span class="hljs-keyword">const</span> result = <span class="hljs-string">'devops'</span>;      expect(<span class="hljs-keyword">await</span> intercepterController.getApp(req, res)).toBe(result);    });  });</code></pre><p>ç»§ç»­æ‰§è¡Œä¹‹å‰çš„æµ‹è¯•è„šæœ¬ï¼š<code>yarn
        test</code> å³å¯å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š</p><p><img
        src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0feed309c6074543971312a9b6ebf7ea~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><p>å•Šå˜ï¼ŒæŠ¥é”™å¾ˆæ­£å¸¸ï¼Œä»æŠ¥é”™ä¿¡æ¯èƒ½å¾ˆæ˜æ˜¾çœ‹å‡ºæ˜¯æ¨¡æ‹Ÿçš„ <code>@Res</code>
      å‚æ•°æœ‰é—®é¢˜ï¼Œå¦å¤–åœ¨ <code>getApp</code> ä¸­æ˜¯ç›´æ¥ä½¿ç”¨äº† <code>res.send</code>
      è¿”å›æ•°æ®ï¼Œè¿™æ ·åœ¨å•å…ƒæµ‹è¯•ä¸­æ˜¯æ— æ³•æ‹¿åˆ°æ­£å¸¸çš„è¿”å›å€¼ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦åŒæ—¶ä¿®æ”¹ <code>getApp</code> çš„è¿”å›æ–¹æ³•ï¼š</p><pre><code class="hljs language-diff"> @Get('*')  async getApp(@Req() req: FastifyRequest, @Res() res: FastifyReply) {    const urlObj = new URL(req.url, `http://${req.headers.host}`);    if (urlObj.pathname <span class="hljs-comment">=== '/favicon.ico') return res.send('ico');</span>    const html = await this.intercepterService.readHtml(urlObj);    if (!html) return res.send('404');    res.headers({      'Content-Type': 'text/html',    });<span class="hljs-deletion">-   res.send(html);</span><span class="hljs-addition">+   return res.send(html);</span>  }</code></pre><p>ç„¶ååœ¨ä¿®æ”¹
      <code>intercepter.controller.spec.ts</code> çš„ <code>getApp</code> æ–¹æ³•ï¼š</p><pre><code class="hljs language-diff">describe('getApp', () => {    it('should return devops', async () => {      const req = mockRequest({        headers: {          host: 'www.cookieboty.com'        },        url: '/devops'      })<span class="hljs-deletion">-      const res = mockResponse()</span><span class="hljs-addition">+      const res = mockResponse({</span><span class="hljs-addition">+        headers: () => { },</span><span class="hljs-addition">+        send: d => d</span><span class="hljs-addition">+      })</span>      const result = 'devops';      expect(await intercepterController.getApp(req, res)).toBe(result);    });  });</code></pre><p>å†æ¬¡è¿è¡Œæµ‹è¯•è„šæœ¬å¾—åˆ°å¦‚ä¸‹ç»“æœä»£è¡¨æµ‹è¯•æˆåŠŸï¼š</p><p><img
        src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/adc693c624454185b6f8f4b56a02adc9~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><p>ä¸Šè¿°çš„æµ‹è¯•è„šæœ¬ï¼Œå…¶å®è¿˜æ²¡æœ‰ä½¿ç”¨åˆ° <code>NestJS</code>
      ç»™æˆ‘ä»¬æä¾›çš„æµ‹è¯•å·¥å…·ï¼Œå¤§å®¶å¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬æ˜¯å°† <code>ConfigService</code> ä¸ <code>IntercepterService</code>
      å®ä¾‹ç›´æ¥ä¼ é€’çš„ï¼Œå½“ä¾èµ–çš„æµ‹è¯•æ¨¡å—å¤šèµ·æ¥çš„æ—¶å€™å¹¶ä¸æ˜¯éå¸¸æ–¹ä¾¿ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨ <code>NestJS</code> æä¾›çš„æµ‹è¯•å·¥å…·æ¥ä¿®æ”¹æˆ‘ä»¬çš„è„šæœ¬ã€‚</p><pre><code class="hljs language-diff">// intercepter.controller.spec.ts  beforeEach(async () => {  <span class="hljs-deletion">-    configService = new ConfigService({</span><span class="hljs-deletion">-      isGlobal: true,</span><span class="hljs-deletion">-      load: [getConfig]</span><span class="hljs-deletion">-    })</span><span class="hljs-deletion">-    intercepterService = new IntercepterService(configService);</span><span class="hljs-deletion">-    intercepterController = new IntercepterController(intercepterService);</span>    <span class="hljs-addition">+    const moduleRef = await Test.createTestingModule({</span><span class="hljs-addition">+      imports: [IntercepterModule,</span><span class="hljs-addition">+        ConfigModule.forRoot({</span><span class="hljs-addition">+          ignoreEnvFile: true,</span><span class="hljs-addition">+          isGlobal: true,</span><span class="hljs-addition">+          load: [getConfig]</span><span class="hljs-addition">+        }),],</span><span class="hljs-addition">+    }).compile();</span><span class="hljs-addition">+    intercepterService = moduleRef.get&#x3C;IntercepterService>(IntercepterService);</span><span class="hljs-addition">+    intercepterController = moduleRef.get&#x3C;IntercepterController>(IntercepterController);</span>  });</code></pre><p>ä»ä»¥ä¸Šä»£ç å¯¹æ¯”å¤§å®¶å¯ä»¥å‘ç°ï¼Œä½¿ç”¨äº†
      <code>NestJS</code> è‡ªå¸¦çš„ <code>Test.createTestingModule</code>
      æ–¹æ³•åï¼Œé™¤äº†ä¸å†éœ€è¦ä¸»åŠ¨å®ä¾‹åŒ–ç±»ä¹‹å¤–ï¼Œå…¶ä»–æ‰€æœ‰ç›¸å…³çš„ä¾èµ–ï¼Œæˆ‘ä»¬åªéœ€è¦å€ŸåŠ© <code>NestJS</code> æœ¬èº«çš„ä¾èµ–æ³¨å…¥å°±å¯ä»¥å®Œæˆï¼ŒåŒæ—¶ä½¿ç”¨
      <code>createTestingModule</code> ï¼Œä¼šæ¨¡æ‹Ÿ <code>NestJS</code>
      çš„è¿è¡Œæ—¶ï¼Œå¯ä»¥è·å–åˆ°ä¸Šä¸‹æ–‡ï¼Œæ‰€ä»¥æ‹“å±•æ€§ä¼šå˜å¾—æ›´é«˜ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è¯•è¯•æ›´å¤šçš„åŠŸèƒ½ã€‚</p><h4>E2E TEST</h4><p>å•å…ƒæµ‹è¯•ä¸»è¦æ˜¯æŸä¸ªæ–¹æ³•æˆ–è€…æ¨¡å—çš„é€»è¾‘æµ‹è¯•ï¼Œè€Œ
      <code>E2E</code> æµ‹è¯•åœ¨æ›´èšåˆçš„å±‚é¢è¦†ç›–äº†ç±»å’Œæ¨¡å—çš„äº¤äº’ï¼Œå°½å¯èƒ½çš„æ¨¡æ‹Ÿç”¨æˆ·åœ¨ç”Ÿäº§ç¯å¢ƒçš„æ“ä½œã€‚</p><p>å½“éœ€è¦æµ‹è¯•çš„é“¾è·¯éå¸¸é•¿ä¸å¤æ‚çš„æƒ…å†µä¸‹ï¼Œå•å…ƒæµ‹è¯•æ˜¯æ— æ³•å¾ˆå¥½çš„ä¿è¯é“¾è·¯å¯é æ€§ï¼Œæˆ–è€…è¯´å®ƒä¼šå˜å¾—æ›´åŠ å¤æ‚ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ä¹Ÿå°±éœ€è¦
      <code>E2E</code> æµ‹è¯•æ¥ä¿è¯é“¾æ¥çš„ç¨³å®šä¸æ­£ç¡®æ€§ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä¸€èµ·å­¦ä¹  E2E çš„æµ‹è¯•ç”¨ä¾‹å¼€å‘ã€‚</p><p>é¦–å…ˆåœ¨é¡¹ç›®çš„
      <code>test</code> æ–‡ä»¶å¤¹ä¸‹åˆ›å»º <code>apps/fast-gateway/test/intercepter.e2e-spec.ts</code>
      æ–‡ä»¶ï¼š</p><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> request <span class="hljs-keyword">from</span> <span class="hljs-string">'supertest'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Test</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/testing'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FastifyAdapter</span>, <span class="hljs-title class_">NestFastifyApplication</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/platform-fastify'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">IntercepterModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../src/core/intercepter.module'</span><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigService</span>, <span class="hljs-title class_">ConfigModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;<span class="hljs-keyword">import</span> { getConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'../src/utils/index'</span>;<span class="hljs-title function_">describe</span>(<span class="hljs-string">'Cats'</span>, <span class="hljs-function">() =></span> {  <span class="hljs-keyword">let</span> <span class="hljs-attr">app</span>: <span class="hljs-title class_">NestFastifyApplication</span>;  <span class="hljs-title function_">beforeAll</span>(<span class="hljs-keyword">async</span> () => {    <span class="hljs-keyword">const</span> moduleRef = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Test</span>.<span class="hljs-title function_">createTestingModule</span>({      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">IntercepterModule</span>,        <span class="hljs-title class_">ConfigModule</span>.<span class="hljs-title function_">forRoot</span>({          <span class="hljs-attr">ignoreEnvFile</span>: <span class="hljs-literal">true</span>,          <span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span>,          <span class="hljs-attr">load</span>: [getConfig]        }),],    }).<span class="hljs-title function_">compile</span>();    app = moduleRef.<span class="hljs-property">createNestApplication</span>&#x3C;<span class="hljs-title class_">NestFastifyApplication</span>>(      <span class="hljs-keyword">new</span> <span class="hljs-title class_">FastifyAdapter</span>(),    );    <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">init</span>();    <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">getHttpAdapter</span>().<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">ready</span>();  });  <span class="hljs-title function_">it</span>(<span class="hljs-string">`/GET devops`</span>, <span class="hljs-function">() =></span> {    <span class="hljs-keyword">return</span> <span class="hljs-title function_">request</span>(app.<span class="hljs-title function_">getHttpServer</span>())      .<span class="hljs-title function_">get</span>(<span class="hljs-string">'/devops'</span>)      .<span class="hljs-title function_">set</span>(<span class="hljs-string">'host'</span>, <span class="hljs-string">'www.cookieboty.com'</span>)      .<span class="hljs-title function_">expect</span>(<span class="hljs-number">200</span>)      .<span class="hljs-title function_">expect</span>(<span class="hljs-string">'devops'</span>);  });  <span class="hljs-title function_">it</span>(<span class="hljs-string">`/GET jenkins`</span>, <span class="hljs-function">() =></span> {    <span class="hljs-keyword">return</span> <span class="hljs-title function_">request</span>(app.<span class="hljs-title function_">getHttpServer</span>())      .<span class="hljs-title function_">get</span>(<span class="hljs-string">'/jenkins'</span>)      .<span class="hljs-title function_">set</span>(<span class="hljs-string">'host'</span>, <span class="hljs-string">'www.cookieboty.com'</span>)      .<span class="hljs-title function_">expect</span>(<span class="hljs-number">200</span>)      .<span class="hljs-title function_">expect</span>(<span class="hljs-string">'jenkins'</span>);  });  <span class="hljs-title function_">it</span>(<span class="hljs-string">`/GET 404`</span>, <span class="hljs-function">() =></span> {    <span class="hljs-keyword">return</span> <span class="hljs-title function_">request</span>(app.<span class="hljs-title function_">getHttpServer</span>())      .<span class="hljs-title function_">get</span>(<span class="hljs-string">'/jenk'</span>)      .<span class="hljs-title function_">set</span>(<span class="hljs-string">'host'</span>, <span class="hljs-string">'www.cookieboty.com'</span>)      .<span class="hljs-title function_">expect</span>(<span class="hljs-number">200</span>)      .<span class="hljs-title function_">expect</span>(<span class="hljs-string">'404'</span>);  });  <span class="hljs-title function_">it</span>(<span class="hljs-string">`/GET nginx`</span>, <span class="hljs-function">() =></span> {    <span class="hljs-keyword">return</span> <span class="hljs-title function_">request</span>(app.<span class="hljs-title function_">getHttpServer</span>())      .<span class="hljs-title function_">get</span>(<span class="hljs-string">'/nginx'</span>)      .<span class="hljs-title function_">set</span>(<span class="hljs-string">'host'</span>, <span class="hljs-string">'www.cookieboty.com'</span>)      .<span class="hljs-title function_">expect</span>(<span class="hljs-number">200</span>)      .<span class="hljs-title function_">expect</span>(<span class="hljs-string">'nginx2'</span>);  });  <span class="hljs-title function_">afterAll</span>(<span class="hljs-keyword">async</span> () => {    <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">close</span>();  });});</code></pre><blockquote><p><code>e2e</code>
        çš„æµ‹è¯•æ–‡ä»¶ä¸€å®šè¦æ”¾åœ¨å¯¹åº”é¡¹ç›®çš„ <code>test</code> æ–‡ä»¶å¤¹ä¸­ï¼Œå¦åˆ™ä¸ä¼šç”Ÿæ•ˆã€‚</p></blockquote><p>æ¥ä¸‹æ¥è¿è¡Œ
      <code>e2e</code> æµ‹è¯•è„šæœ¬ï¼š<code>yarn test:e2e</code>ï¼Œä¸‹å›¾åˆ†åˆ«æ˜¯æµ‹è¯•ç”¨ä¾‹æ­£å¸¸ä¸å¼‚å¸¸çš„ç¤ºä¾‹ï¼š</p><p><img
        src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d0804420a6cf4137a1a295052d102a91~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><p><img
        src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b265c3df26764b72b3dd0a835ffcf5ad~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><h2>å†™åœ¨æœ€å</h2><p>æœ¬ç« çš„ç¤ºä¾‹ä»£ç åœ¨ <a
        href="https://github.com/boty-design/gateway/tree/feat/microservices"
        target="_blank" rel="nofollow noopener noreferrer">feat/microservices</a>ï¼Œåç»­ä¼šè¿›è¡ŒæŒç»­çš„è¿­ä»£ï¼Œæœ‰éœ€è¦çš„åŒå­¦è‡ªå–ã€‚</p><p>å¤§å®¶å¯¹æ¯”ä¸€ä¸‹å¯ä»¥æˆ‘ä»¬çš„å¼€å‘ä»£ç ä¸æµ‹è¯•ä»£ç å³å¯å‘ç°ï¼Œæµ‹è¯•ç”¨ä¾‹çš„ä»£ç é‡è¿œè¶…å¼€å‘çš„ä»£ç ï¼Œç”±äºè¦æ¶µç›–çš„é€»è¾‘éå¸¸å¤šï¼Œæ‰€ä»¥ä¸ºäº†ä¿è¯æµ‹è¯•ç”¨ä¾‹çš„è´¨é‡ä¼šæœ‰å¤§é‡çš„ç”¨ä¾‹åˆ¤æ–­ã€‚</p><p>è™½ç„¶æµ‹è¯•ç”¨ä¾‹èƒ½å¾ˆå¥½çš„ä¿è¯ä»£ç çš„è´¨é‡ï¼Œä½†æ˜¯ä¼šæ¶ˆè€—éå¸¸å¤šçš„æ—¶é—´æ¥å¼€å‘ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘åœ¨å¼€å‘é¡¹ç›®æœ€å¼€å§‹çš„æ—¶å€™è·Ÿå¤§å®¶æè¿‡ï¼Œå¦‚æœé¡¹ç›®ç´§æ€¥çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥å…ˆæŠŠæµ‹è¯•ç”¨ä¾‹å¼€å‘æ”¾åœ¨æœ€åï¼Œæµ‹è¯•ç”¨ä¾‹è¦†ç›–æœ€ä¸»è¦çš„æ ¸å¿ƒåŠŸèƒ½å³å¯ã€‚</p><p>ç”±äºç½‘å…³ç³»ç»Ÿä»£ç†çš„æµ‹è¯•ç”¨ä¾‹å¾ˆç‰¹æ®Šï¼Œéœ€è¦é’ˆå¯¹åŸŸååšå¤„ç†ï¼Œæ‰€ä»¥æœ¬ç« çš„ä¾‹å­ä¸»è¦å›´ç»•ç€æ¨¡æ‹Ÿè¯·æ±‚ä½“ä¸ä¿®æ”¹
      <code>Host</code> æ¥å±•ç°ï¼Œå…¶ä»–ç®€å•çš„ <code>CURD</code> çš„æµ‹è¯•ç”¨ä¾‹å¤§å®¶å¯ä»¥å°½å¯èƒ½çš„å¤šå†™å†™ï¼Œç†Ÿèƒ½ç”Ÿå·§ã€‚</p><p><code>Jest</code>
      çš„åŠŸèƒ½è¿˜æ˜¯éå¸¸å¼ºå¤§çš„ï¼Œè¿˜æœ‰éå¸¸å¤šæœ‰è¶£ä»¥åŠæœ‰ç”¨çš„ <code>Api</code> å¤§å®¶å¯ä»¥è‡ªè¡Œç ”ç©¶å‚è€ƒä¸‹ï¼Œæœ‰é—®é¢˜çš„è¯æ¬¢è¿åœ¨ç¾¤é‡Œæå‡ºäº¤æµï¼Œ</p><p>å¦‚æœä½ æœ‰ä»€ä¹ˆç–‘é—®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºæå‡ºæˆ–è€…åŠ ç¾¤æ²Ÿé€šã€‚
      ğŸ‘</p>
  </body>
</html>