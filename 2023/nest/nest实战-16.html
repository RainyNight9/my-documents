<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
  </head>
  <body>
    <h2>å‰è¨€</h2><p>åœ¨ä¸Šä¸€ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å·²ç»å¯¹ä¸€ä¸ªç¨å…·å¤æ‚çš„é¡¹ç›®è¿›è¡Œäº†æ‹†åˆ†ï¼Œç›®å‰å·¥ç¨‹å·²ç»è¢«æ‹†æˆåŠŸèƒ½è¾ƒä¸ºå•ä¸€çš„ä¸‰ä¸ªç‹¬ç«‹é¡¹ç›®ï¼š<code>Core</code>ã€ç”¨æˆ·ä¸ç‰©æ–™ç³»ç»Ÿã€‚</p><p>æ—¢ç„¶æ¯ä¸ªé¡¹ç›®çš„åŠŸèƒ½æ˜¯å•ä¸€ï¼Œä½†æ˜¯åœ¨ä¹‹å‰çš„éœ€æ±‚åˆ†æä¸­ï¼Œå®ƒä»¬åˆæ˜¯ç»„æˆç½‘å…³ç³»ç»Ÿçš„å„ä¸ªé‡è¦éƒ¨åˆ†ï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•å°†å„ä¸ªç³»ç»Ÿä¸­æœ‰å…³è”çš„æœåŠ¡è¿›è¡Œè”é€šå‘¢ï¼Ÿ</p><p>æœ¬ç« å°†ä»‹ç»å¦‚ä½•å€ŸåŠ©
      <code>NestJS</code> æä¾›çš„ <code>RPC</code> æœåŠ¡æ¥æ‰“é€šå„ä¸ªç³»ç»Ÿä¹‹é—´çš„å…³è”ã€‚</p><h2>å¾®æœåŠ¡</h2><blockquote><p>ç»´åŸºä¸Šå¯¹å…¶å®šä¹‰ä¸ºï¼šä¸€ç§è½¯ä»¶å¼€å‘æŠ€æœ¯-
        é¢å‘æœåŠ¡çš„ä½“ç³»ç»“æ„ï¼ˆSOAï¼‰æ¶æ„æ ·å¼çš„ä¸€ç§å˜ä½“ï¼Œå®ƒæå€¡å°†å•ä¸€åº”ç”¨ç¨‹åºåˆ’åˆ†æˆä¸€ç»„å°çš„æœåŠ¡ï¼ŒæœåŠ¡ä¹‹é—´äº’ç›¸åè°ƒã€äº’ç›¸é…åˆï¼Œä¸ºç”¨æˆ·æä¾›æœ€ç»ˆä»·å€¼ã€‚æ¯ä¸ªæœåŠ¡è¿è¡Œåœ¨å…¶ç‹¬ç«‹çš„è¿›ç¨‹ä¸­ï¼ŒæœåŠ¡ä¸æœåŠ¡é—´é‡‡ç”¨è½»é‡çº§çš„é€šä¿¡æœºåˆ¶äº’ç›¸æ²Ÿé€šï¼ˆé€šå¸¸æ˜¯åŸºäº
        <code>HTTP</code> çš„ <code>RESTful API</code>ï¼‰ã€‚æ¯ä¸ªæœåŠ¡éƒ½å›´ç»•ç€å…·ä½“ä¸šåŠ¡è¿›è¡Œæ„å»ºï¼Œå¹¶ä¸”èƒ½å¤Ÿç‹¬ç«‹åœ°éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒã€ç±»ç”Ÿäº§ç¯å¢ƒç­‰ã€‚å¦å¤–ï¼Œåº”å°½é‡é¿å…ç»Ÿä¸€çš„ã€é›†ä¸­å¼çš„æœåŠ¡ç®¡ç†æœºåˆ¶ï¼Œå¯¹å…·ä½“çš„ä¸€ä¸ªæœåŠ¡è€Œè¨€ï¼Œåº”æ ¹æ®ä¸Šä¸‹æ–‡ï¼Œé€‰æ‹©åˆé€‚çš„è¯­è¨€ã€å·¥å…·å¯¹å…¶è¿›è¡Œæ„å»ºã€‚</p></blockquote><h4>å¾®æœåŠ¡çš„ä¼˜åŠ¿</h4><p>å¦‚ä¸Šæ‰€è¯´ï¼Œå¾®æœåŠ¡å…¶å®æ˜¯å°†ä¸€ä¸ªåºå¤§çš„ç³»ç»Ÿåˆ‡å‰²æˆå¤šä¸ªæœ€å°å•å…ƒï¼Œæ¯ä¸€ä¸ªå•å…ƒéƒ½æ˜¯ä¸€ä¸ªæˆ–è€…ä¸€ç»„ç›¸åŒçš„åŠŸèƒ½é›†åˆã€‚</p><p>ä¸ä¼ ç»Ÿçš„æœåŠ¡å¼€å‘ä¸åŒçš„æ˜¯ï¼Œå½“ä¸€ä¸ªé¡¹ç›®æ‹†è§£ä¸ºå¾®æœåŠ¡çš„æ—¶å€™ï¼Œå¸¦æ¥çš„ä¼˜åŠ¿æœ‰å¦‚ä¸‹å‡ ç‚¹ï¼š</p><ol><li>ä¸å†å±€é™äº<strong>å•ä¸€æŠ€æœ¯æ¶æ„</strong>çš„å®ç°ï¼Œæ ¹æ®ä¸åŒæ¨¡å—çš„ç‰¹æ®Šæ€§å¯ä»¥æœ‰ä¸“ä¸šçš„æŠ€æœ¯è§£å†³æ–¹æ¡ˆï¼›</li><li>æ–°çš„ä¸šåŠ¡åŠŸèƒ½ä¸éœ€è¦æ‰¿æ‹…æ—§çš„æŠ€æœ¯å€ºï¼ŒåŒæ—¶å¯ä»¥æ‹†è§£æœåŠ¡é€æ­¥è¿›è¡ŒæŠ€æœ¯å‡çº§ï¼›</li><li><strong>ä¸šåŠ¡åŠŸèƒ½å•ä¸€</strong>ï¼Œå¤æ‚åº¦ä¸‹é™ï¼Œå¼€å‘ç»´æŠ¤æ•ˆç‡æé«˜ï¼›</li><li>ç‹¬ç«‹éƒ¨ç½²ï¼Œå•æœåŠ¡å¯åŠ¨é€Ÿåº¦æé«˜ï¼Œå¿…è¦æ—¶å¯ä»¥æ ¹æ®å®é™…æƒ…å†µå¯¹æŸä¸€äº›æœåŠ¡è¿›è¡ŒæœåŠ¡å™¨<strong>å‡çº§ã€æ‰©å®¹</strong>ã€‚</li></ol><h4>å¾®æœåŠ¡é€šä¿¡æ–¹å¼</h4><ol><li>åŒæ­¥æ–¹å¼ï¼š<code>RPC</code>ã€<code>HTTP</code>ã€<code>TCP</code>ï¼›</li><li>å¼‚æ­¥æ–¹å¼ï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä½¿ç”¨ä¸­è¿‡ç¨‹ä¸­éœ€è¦è€ƒè™‘æ¶ˆæ¯çš„å¯é ä¼ è¾“ã€é«˜æ€§èƒ½ç­‰æƒ…å†µï¼Œå¸¸è§çš„å·¥å…·æœ‰<code>Kafka</code>ã€<code>Notify</code>
        ç­‰ã€‚</li></ol><p><code>HTTP</code> ä¸ <code>TCP</code> éƒ½æ˜¯å¸¸è§çš„é€šä¿¡æ–¹å¼ï¼Œé‚£ä¹ˆ <code>RPC</code>
      åˆæ˜¯å•¥ï¼Ÿ</p><p><code>RPC</code> <strong>æ˜¯ä¸€ç§è®¾è®¡ã€å®ç°æ¡†æ¶ï¼Œé€šè®¯åè®®åªæ˜¯å…¶ä¸­ä¸€éƒ¨åˆ†</strong>ï¼Œå¹¶ä¸é™å®šæŸä¸€ç±»çš„é€šä¿¡åè®®ï¼Œå¤§éƒ¨åˆ†çš„
      <code>RPC</code> åè®®ä½¿ç”¨çš„æ˜¯ <code>TCP</code>ï¼Œä½†ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>HTTP</code>
      åè®®æ¥å°è£…ï¼Œæ¯”å¦‚è°·æ­Œçš„ <code>gRPC</code> ä½¿ç”¨çš„å°±æ˜¯ <code>HTTP2</code> åè®®ã€‚</p><p>åœ¨å¤§æ¦‚äº†è§£äº†å¾®æœåŠ¡çš„ä¸€äº›çŸ¥è¯†ä¹‹åï¼Œæ¥ä¸‹æ¥ç»§ç»­æˆ‘ä»¬çš„å­¦ä¹ è¿‡ç¨‹ã€‚</p><h2>NestJS
      å¾®æœåŠ¡ä½¿ç”¨</h2><p><code>NestJS</code> ä½œä¸ºä¸€æ¬¾éå¸¸æˆç†Ÿçš„æ¡†æ¶ï¼Œæœ¬èº«å°±æ”¯æŒå¾®æœåŠ¡æ¶æ„çš„è®¾è®¡ï¼ŒåŒæ—¶ä¹Ÿå†…ç½®äº†å¾ˆå¤š <code>RPC</code>
      çš„ä¼ è¾“å™¨ï¼Œæ‰€ä»¥åœ¨ <code>NestJS</code> ä¸­ä½¿ç”¨å¾®æœåŠ¡æ˜¯éå¸¸æ–¹ä¾¿çš„ã€‚</p><h4>å¯åŠ¨å¾®æœåŠ¡</h4><p><strong>ç¬¬ä¸€æ­¥</strong>ï¼šå®‰è£…å¾®æœåŠ¡ä¾èµ–
      <code>@nestjs/microservices</code></p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">$ </span><span class="bash">yarn add @nestjs/microservices</span></code></pre><p><strong>ç¬¬äºŒæ­¥</strong>ï¼šä¿®æ”¹ç”¨æˆ·ç³»ç»Ÿä¸­
      <code>user-center/src/main.ts</code> ï¼Œæ·»åŠ å¾®æœåŠ¡å¯åŠ¨é…ç½®ï¼Œå¹¶å¯åŠ¨ç”¨æˆ·ç³»ç»Ÿçš„å¾®æœåŠ¡</p><pre><code class="hljs language-ts"><span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">module</span>: <span class="hljs-built_in">any</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NestFactory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserCenterModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user-center.module'</span>;<span class="hljs-keyword">import</span> {  <span class="hljs-title class_">FastifyAdapter</span>,  <span class="hljs-title class_">NestFastifyApplication</span>,} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/platform-fastify'</span>;<span class="hljs-keyword">import</span> fastify <span class="hljs-keyword">from</span> <span class="hljs-string">'fastify'</span>;<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> cookieParser <span class="hljs-keyword">from</span> <span class="hljs-string">'cookie-parser'</span>;<span class="hljs-keyword">import</span> { generateDocument } <span class="hljs-keyword">from</span> <span class="hljs-string">'./doc'</span><span class="hljs-keyword">import</span> { <span class="hljs-title class_">FastifyLogger</span>, catchError, <span class="hljs-title class_">AllExceptionsFilter</span>, <span class="hljs-title class_">HttpExceptionFilter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@app/common'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ValidationPipe</span>, <span class="hljs-title class_">VersioningType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<span class="hljs-keyword">import</span> fastifyCookie <span class="hljs-keyword">from</span> <span class="hljs-string">'@fastify/cookie'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MicroserviceOptions</span>, <span class="hljs-title class_">Transport</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/microservices'</span>;<span class="hljs-title function_">catchError</span>()<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"></span>) {  <span class="hljs-comment">// åˆå§‹åŒ– fastify </span>  <span class="hljs-keyword">const</span> fastifyInstance = <span class="hljs-title function_">fastify</span>({    <span class="hljs-attr">logger</span>: <span class="hljs-title class_">FastifyLogger</span>,  })  <span class="hljs-comment">// åˆ›å»º NEST å®ä¾‹</span>  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-property">create</span>&#x3C;<span class="hljs-title class_">NestFastifyApplication</span>>(    <span class="hljs-title class_">UserCenterModule</span>,    <span class="hljs-keyword">new</span> <span class="hljs-title class_">FastifyAdapter</span>(fastifyInstance)  );  <span class="hljs-comment">// micro serivce</span>  app.<span class="hljs-property">connectMicroservice</span>&#x3C;<span class="hljs-title class_">MicroserviceOptions</span>>(    {      <span class="hljs-attr">transport</span>: <span class="hljs-title class_">Transport</span>.<span class="hljs-property">TCP</span>,      <span class="hljs-attr">options</span>: {        <span class="hljs-attr">port</span>: <span class="hljs-number">4100</span>,        <span class="hljs-attr">host</span>: <span class="hljs-string">'0.0.0.0'</span>,      },    },    {      <span class="hljs-attr">inheritAppConfig</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// ç»§æ‰¿ app é…ç½®</span>    },  );  app.<span class="hljs-title function_">register</span>(fastifyCookie, {    <span class="hljs-attr">secret</span>: <span class="hljs-string">'my-secret'</span>, <span class="hljs-comment">// for cookies signature</span>  });  <span class="hljs-comment">// å¼‚å¸¸è¿‡æ»¤å™¨</span>  app.<span class="hljs-title function_">useGlobalFilters</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AllExceptionsFilter</span>(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpExceptionFilter</span>());  <span class="hljs-comment">// è®¾ç½®å…¨å±€æ¥å£å‰ç¼€</span>  app.<span class="hljs-title function_">setGlobalPrefix</span>(<span class="hljs-string">'api'</span>);  <span class="hljs-comment">// æ ¼å¼åŒ– cookie</span>  app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cookieParser</span>());  <span class="hljs-comment">// æ¥å£ç‰ˆæœ¬åŒ–ç®¡ç†</span>  app.<span class="hljs-title function_">enableVersioning</span>({    <span class="hljs-attr">type</span>: <span class="hljs-title class_">VersioningType</span>.<span class="hljs-property">URI</span>,  });  <span class="hljs-comment">// å¯åŠ¨å…¨å±€å­—æ®µæ ¡éªŒï¼Œä¿è¯è¯·æ±‚æ¥å£å­—æ®µæ ¡éªŒæ­£ç¡®ã€‚</span>  app.<span class="hljs-title function_">useGlobalPipes</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationPipe</span>());  <span class="hljs-comment">// åˆ›å»ºæ–‡æ¡£</span>  <span class="hljs-title function_">generateDocument</span>(app)  <span class="hljs-comment">// å¯åŠ¨æ‰€æœ‰å¾®æœåŠ¡</span>  <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">startAllMicroservices</span>();  <span class="hljs-comment">// å¯åŠ¨æœåŠ¡</span>  <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">4000</span>);  <span class="hljs-comment">// æ·»åŠ çƒ­æ›´æ–°</span>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>) {    <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-title function_">accept</span>();    <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-title function_">dispose</span>(<span class="hljs-function">() =></span> app.<span class="hljs-title function_">close</span>());  }}<span class="hljs-title function_">bootstrap</span>();</code></pre><p>é‡å¯æœåŠ¡ï¼Œçœ‹åˆ°æ§åˆ¶å°ä¸­æœ‰å¦‚ä¸‹æ‰“å°æ—¥å¿—å³ä»£è¡¨å¾®æœåŠ¡å¯åŠ¨æˆåŠŸï¼š</p><p><img
        src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/638ff629248a406e81ea2a4a90c75a51~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>netstat -ano -p tcp|findstr 4100</code>
      æ£€æŸ¥ TCP ç«¯å£æ˜¯å¦æ­£å¸¸å¯åŠ¨ï¼š</p><p><img
        src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/690f529ae82948a590f22e8ef1392cc2~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><blockquote><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨ <code>NestJS</code> è‡ªå¸¦çš„
        <code>RPC</code> å°†ä½¿ç”¨ <strong>TCPåè®®</strong> ç›‘å¬æ¶ˆæ¯ã€‚</p></blockquote><p><strong>ç¬¬ä¸‰æ­¥</strong>ï¼šåœ¨ç‰©æ–™ç³»ç»Ÿä¸­æ·»åŠ 
      <code>RPC</code> å®¢æˆ·ç«¯è¿æ¥ï¼š</p><p><code>.dev.yaml</code> æ–‡ä»¶æ–°å¢æ–°çš„é…ç½®é¡¹ <code>USER_MICROSERVICES</code>ï¼š</p><pre><code class="hljs language-yml"><span class="hljs-attr">USER_MICROSERVICES:</span>  <span class="hljs-attr">host:</span> <span class="hljs-string">"0.0.0.0"</span>  <span class="hljs-attr">port:</span> <span class="hljs-number">4100</span></code></pre><p>æ–°å»º
      <code>materials/src/microservices/microservices.module.ts</code>ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç ï¼Œå¹¶å¯¼å…¥
      <code>materials.module.ts</code> åï¼Œé‡å¯å³å¯ï¼š</p><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ClientsModule</span>, <span class="hljs-title class_">Transport</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/microservices'</span>;<span class="hljs-keyword">import</span> { getConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'@app/common'</span>;<span class="hljs-keyword">const</span> { <span class="hljs-variable constant_">USER_MICROSERVICES</span> } = <span class="hljs-title function_">getConfig</span>()<span class="hljs-meta">@Module</span>({  <span class="hljs-attr">imports</span>: [    <span class="hljs-title class_">ClientsModule</span>.<span class="hljs-title function_">register</span>([      {        <span class="hljs-attr">name</span>: <span class="hljs-string">'USER-SERVER'</span>,        <span class="hljs-attr">transport</span>: <span class="hljs-title class_">Transport</span>.<span class="hljs-property">TCP</span>,        <span class="hljs-attr">options</span>: <span class="hljs-variable constant_">USER_MICROSERVICES</span>,      },    ]),  ],  <span class="hljs-attr">providers</span>: [],  <span class="hljs-attr">exports</span>: []})<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MicroservicesModule</span> { }</code></pre><p><img
        src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1617b6bb8bfe4960975743e104a82196~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><h4>ç”¨æˆ·ç³»ç»Ÿæ‰“é€š</h4><p><strong>ç¬¬ä¸€æ­¥</strong>ï¼šåœ¨ç”¨æˆ·ç³»ç»Ÿçš„ <code>user/UserController</code>
      æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">MessagePattern</span>, <span class="hljs-title class_">Payload</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">MicroPayload</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/microservices'</span>;<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> userService: UserService,    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> userRoleService: UserRoleService  </span>) { }  <span class="hljs-meta">@MessagePattern</span>(<span class="hljs-string">'userCenter.user.profile'</span>)  <span class="hljs-meta">@Public</span>()  <span class="hljs-title function_">micro_profile</span>(<span class="hljs-params"><span class="hljs-meta">@MicroPayload</span>() data: Payload</span>) {    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">profile</span>(data);  }}</code></pre><p><strong>ç¬¬äºŒæ­¥</strong>ï¼šåœ¨ç‰©æ–™ç³»ç»Ÿä¸­ç§»æ¤ä¹‹å‰çš„
      <code>Auth</code> æ¨¡å—ï¼Œåªä¿ç•™ä»¥ä¸‹æ¨¡å—ï¼š</p><p><img
        src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ea2be6057f73452d907064453fc60fc4~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><p><strong>ç¬¬ä¸‰æ­¥</strong>ï¼šç‰©æ–™ç³»ç»Ÿä¸­æ–°å¢ <code>microservices/user.service.ts</code>ï¼š</p><pre><code class="hljs language-diff">import { Injectable, Inject } from '@nestjs/common';import { ClientProxy } from '@nestjs/microservices';import { firstValueFrom } from 'rxjs';@Injectable()export class UserService {  constructor(    @Inject('USER-SERVER') private userServer: ClientProxy  ) { }  getUser(user) {<span class="hljs-deletion">-   return this.userServer.send('userCenter.user.profile', user)</span><span class="hljs-addition">+   return firstValueFrom(this.userServer.send('userCenter.user.profile', user))</span>  }}</code></pre><blockquote><p>æ³¨æ„å®¢æˆ·ç«¯ä¸­è·å–
        <code>RPC</code> æœåŠ¡ç«¯çš„æ¥å£çš„æ–¹æ³•æ˜¯ <code>ClientProxy</code> ä¸­çš„ <code>send()</code>ï¼Œæ­¤æ–¹æ³•è¯·æ±‚å¹¶è¿”å›æ˜¯å“åº”æ•°æ®æµçš„
        <code>Observable</code>ï¼Œè¿™å¹¶ä¸æ˜¯æ­£å¸¸çš„ <code>HTTP</code> è¿”å›çš„å†…å®¹ï¼Œè€Œæ˜¯é€šè¿‡ <code>TCP</code>
        åè®®ä¼ è¾“çš„å†…å®¹ã€‚æ‰€ä»¥ç›´æ¥è·å–å€¼æ˜¯è·å–ä¸åˆ°çš„ï¼Œä¸€å®šè¦è®°å¾—ä½¿ç”¨ <code>rxjs</code> ä¸­çš„ <code>firstValueFrom</code>
        åŒ…ä¸€å±‚æ‰èƒ½æ‹¿åˆ°æ­£å¸¸çš„è¿”å›å€¼ã€‚</p></blockquote><p><strong>ç¬¬å››æ­¥</strong>ï¼šç‰©æ–™ç³»ç»Ÿä¸­æ–°å¢ <code>src/auth/permission.guard.ts</code></p><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> {  <span class="hljs-title class_">CanActivate</span>,  <span class="hljs-title class_">ExecutionContext</span>,  <span class="hljs-title class_">Injectable</span>,} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Reflector</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../microservices/user.service'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">IS_PUBLIC_KEY</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../constants'</span>;<span class="hljs-meta">@Injectable</span>()<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionGuard</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CanActivate</span> {  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> reflector: Reflector, <span class="hljs-keyword">private</span> userService: UserService</span>) { }  <span class="hljs-keyword">async</span> <span class="hljs-title function_">canActivate</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">ExecutionContext</span>): <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-built_in">boolean</span>> {    <span class="hljs-keyword">const</span> loginAuth = <span class="hljs-variable language_">this</span>.<span class="hljs-property">reflector</span>.<span class="hljs-property">getAllAndOverride</span>&#x3C;<span class="hljs-built_in">boolean</span>>(<span class="hljs-variable constant_">IS_PUBLIC_KEY</span>, [      context.<span class="hljs-title function_">getHandler</span>(),      context.<span class="hljs-title function_">getClass</span>(),    ]);    <span class="hljs-keyword">if</span> (loginAuth) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;    <span class="hljs-keyword">const</span> request = context.<span class="hljs-title function_">switchToHttp</span>().<span class="hljs-title function_">getRequest</span>();    <span class="hljs-keyword">const</span> <span class="hljs-attr">user</span>: <span class="hljs-title class_">Payload</span> = request.<span class="hljs-property">user</span>;    <span class="hljs-keyword">const</span> codes = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">getUser</span>(user);    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'microservices===>'</span>, codes)    <span class="hljs-keyword">return</span> codes;  }}</code></pre><p><code>ç¬¬äº”æ­¥</code>ï¼šå°†æ–°çš„ç½‘å…³éªŒè¯
      <code>PermissionGuard</code> å¯¼å…¥ <code>materials.module.ts</code>ï¼š</p><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">CacheModule</span>, <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">APP_GUARD</span>, <span class="hljs-variable constant_">APP_INTERCEPTOR</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TransformInterceptor</span>, getConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'@app/common'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">GroupModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./materials/group/group.module'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MaterialModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./materials/material/material.module'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ProjectModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./materials/project/project.module'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TaskModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./materials/task/task.module'</span>;<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> redisStore <span class="hljs-keyword">from</span> <span class="hljs-string">'cache-manager-redis-store'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">JwtAuthGuard</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./auth/guards/jwt-auth.guard'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AuthModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./auth/auth.module'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MicroservicesModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./microservices/microservices.module'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PermissionGuard</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./auth/guards/permission.guard'</span>;<span class="hljs-meta">@Module</span>({  <span class="hljs-attr">imports</span>: [    <span class="hljs-title class_">CacheModule</span>.<span class="hljs-title function_">register</span>({      <span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span>,      <span class="hljs-attr">store</span>: redisStore,      <span class="hljs-attr">host</span>: <span class="hljs-title function_">getConfig</span>(<span class="hljs-string">'REDIS_CONFIG'</span>).<span class="hljs-property">host</span>,      <span class="hljs-attr">port</span>: <span class="hljs-title function_">getConfig</span>(<span class="hljs-string">'REDIS_CONFIG'</span>).<span class="hljs-property">port</span>,      <span class="hljs-attr">auth_pass</span>: <span class="hljs-title function_">getConfig</span>(<span class="hljs-string">'REDIS_CONFIG'</span>).<span class="hljs-property">auth</span>,      <span class="hljs-attr">db</span>: <span class="hljs-title function_">getConfig</span>(<span class="hljs-string">'REDIS_CONFIG'</span>).<span class="hljs-property">db</span>    }),    <span class="hljs-title class_">ConfigModule</span>.<span class="hljs-title function_">forRoot</span>({      <span class="hljs-attr">ignoreEnvFile</span>: <span class="hljs-literal">true</span>,      <span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span>,      <span class="hljs-attr">load</span>: [getConfig]    }),    <span class="hljs-title class_">MicroservicesModule</span>,    <span class="hljs-title class_">GroupModule</span>,    <span class="hljs-title class_">TaskModule</span>,    <span class="hljs-title class_">MaterialModule</span>,    <span class="hljs-title class_">ProjectModule</span>,    <span class="hljs-title class_">AuthModule</span>  ],  <span class="hljs-attr">controllers</span>: [],  <span class="hljs-attr">providers</span>: [    {      <span class="hljs-attr">provide</span>: <span class="hljs-variable constant_">APP_INTERCEPTOR</span>,      <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">TransformInterceptor</span>,    },    {      <span class="hljs-attr">provide</span>: <span class="hljs-variable constant_">APP_GUARD</span>,      <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">JwtAuthGuard</span>,    },    {      <span class="hljs-attr">provide</span>: <span class="hljs-variable constant_">APP_GUARD</span>,      <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">PermissionGuard</span>,    },  ],})<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MaterialsModule</span> { }</code></pre><p>ç„¶åè®¿é—®ç‰©æ–™ç³»ç»Ÿçš„ä»»æ„
      <code>API</code> å¾—åˆ°å¦‚ä¸‹ç»“æœåˆ™ä»£è¡¨å¾®æœåŠ¡æ­£å¸¸å¯åŠ¨ï¼Œä¸‹å›¾ä¸­ä½¿ç”¨çš„æ¥å£æ˜¯<a
        href="http://localhost:3000/doc#/%E9%A1%B9%E7%9B%AE/ProjectController_getList"
        target="_blank" rel="nofollow noopener noreferrer">http://localhost:3000/doc#/%E9%A1%B9%E7%9B%AE/ProjectController_getList</a></p><p><img
        src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9a6ed6fcdd464a09bf15d605c93fcf70~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><blockquote><p>ç”±äºæ˜¯ä¸¤ä¸ªé¡¹ç›®ï¼Œå¯åŠ¨åæ˜¯ä¸åŒçš„ç«¯å£ï¼Œæ‰€ä»¥åœ¨ç”¨æˆ·ç³»ç»Ÿä¸­ç™»å½•ä¹‹åä¿å­˜çš„
        <code>token</code> æ˜¯ä¸ä¼šå…±äº« <code>cookie</code>
        åœ¨ç‰©æ–™ç³»ç»Ÿä¸‹é¢ï¼Œæ‰€ä»¥ä¸ºäº†æ–¹ä¾¿ï¼Œå¤§å®¶å¯ä»¥åœ¨ç”¨æˆ·ç³»ç»Ÿç™»å½•å®Œæ¯•ä¹‹åï¼Œæ‰‹åŠ¨å°† <code>cookie</code> å­˜åœ¨ç‰©æ–™ç³»ç»Ÿä¸‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p></blockquote><p><img
        src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/56532ebefe634c9ba62531171d4883a8~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><p>è‡³æ­¤å·²ç»å®Œæˆäº†ç”¨æˆ·ä¸ç‰©æ–™ç³»ç»Ÿçš„å¾®æœåŠ¡æ‰“é€šï¼Œæœ‰å…´è¶£çš„è¯ï¼Œå¯ä»¥å†å°† <code>auth</code>
      ä¸ <code>microservices</code> æ¨¡å—ä¹Ÿä¸€èµ·æ”¾åœ¨ <code>libs common</code> æ¨¡å—ä¸­ï¼Œè¿™æ ·ç½‘å…³
      <code>Core</code> ç³»ç»Ÿä¹Ÿèƒ½ç›´æ¥ä½¿ç”¨é€šç”¨çš„é‰´æƒå·¥å…·ã€‚</p><h2>å†™åœ¨æœ€å</h2><p>æœ¬ç« çš„ç¤ºä¾‹ä»£ç åœ¨ <a
        href="https://github.com/boty-design/gateway/tree/feat/microservices"
        target="_blank" rel="nofollow noopener noreferrer">feat/microservices</a>ï¼Œåç»­ä¼šè¿›è¡ŒæŒç»­çš„è¿­ä»£ï¼Œæœ‰éœ€è¦çš„åŒå­¦è‡ªå–ã€‚</p><p>æœ¬ç« ä¸»è¦ä»‹ç»äº†å¦‚ä½•åœ¨
      <code>NestJS</code> ä¸­ä½¿ç”¨ <code>RPC</code>
      æ¥æ‰“é€šå„ä¸ªå¾®æœåŠ¡ä¸­çš„åŠŸèƒ½ï¼Œå‰æ–‡çš„ä¾‹å­éå¸¸ç®€å•ï¼Œå®é™…ä¸Šæˆ‘ä»¬å¯ä»¥åšçš„å†…å®¹éå¸¸å¤šçš„ï¼Œæ¯”å¦‚åœ¨ <code>PermissionGuard</code>
      ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>RPC</code> ä»ç”¨æˆ·ç³»ç»Ÿä¸­è·å–è¯¥ç™»å½•ç”¨æˆ·çš„æƒé™ï¼Œç„¶åå†æ ¹æ®è¿”å›çš„æƒé™å¯¹ç‰©æ–™ç³»ç»Ÿçš„æ¥å£åšæƒé™é™åˆ¶ç­‰ã€‚</p><p>ç¤ºä¾‹ä¸­æˆ‘ä»¬ä½¿ç”¨çš„å¾®æœåŠ¡é€šä¿¡æ–¹å¼ä¸ºåŒæ­¥æ¨¡å¼ï¼Œå¾®æœåŠ¡çš„é€šä¿¡æ–¹å¼è¿˜æœ‰å¼‚æ­¥æ¨¡å¼ï¼ˆä¸€èˆ¬ä¹Ÿå°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼‰ï¼Œä½†åœ¨æˆ‘ä»¬çš„ç½‘å…³ç³»ç»Ÿä¸­å…¶å®æ˜¯æ²¡æœ‰ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—çš„åœºæ™¯ï¼Œæ‰€ä»¥åœ¨ç½‘å…³ç³»ç»Ÿä¸­å°±æ— æ­¤å®æˆ˜ï¼Œä½†æ˜¯æ¶ˆæ¯é˜Ÿåˆ—åœ¨
      <code>Devops</code> ä¸ç‰©æ–™ç³»ç»Ÿçš„æ‰“é€šä¸­ä¼šæœ‰å¾ˆå¤§çš„åº”ç”¨åœºæ™¯ï¼Œæ‰€ä»¥å„ä½å¯ä»¥æŒç»­å…³æ³¨ <a
        href="https://github.com/boty-design" target="_blank" rel="nofollow
        noopener noreferrer">https://github.com/boty-design</a>
      è¿™ä¸ªç»„ç»‡ï¼ŒåæœŸä¼šä»¥å¼€æºçš„æ–¹å¼å®Œæˆæ•´ä¸ªå·¥ç¨‹çš„æ­å»ºã€‚</p><p><strong>æƒ³äº†è§£åç»­çš„å·¥ç¨‹è¿›åº¦çš„åŒå­¦ï¼Œè®°å¾—è¿›å­¦ä¹ ç¾¤ï¼Œæ¯ä¸€æ¬¡çš„åŠŸèƒ½å‘å¸ƒï¼Œæˆ‘éƒ½ä¼šåœ¨ç¾¤é‡ŒåŠæ—¶é€šçŸ¥ã€‚</strong></p><p>å¦‚æœä½ æœ‰ä»€ä¹ˆç–‘é—®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºæå‡ºæˆ–è€…åŠ ç¾¤æ²Ÿé€šã€‚
      ğŸ‘</p>
  </body>
</html>