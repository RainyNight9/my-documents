<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
  </head>
  <body>
    <h2>前言</h2><p>在上一章节中，我们已经对一个稍具复杂的项目进行了拆分，目前工程已经被拆成功能较为单一的三个独立项目：<code>Core</code>、用户与物料系统。</p><p>既然每个项目的功能是单一，但是在之前的需求分析中，它们又是组成网关系统的各个重要部分，那么该如何将各个系统中有关联的服务进行联通呢？</p><p>本章将介绍如何借助
      <code>NestJS</code> 提供的 <code>RPC</code> 服务来打通各个系统之间的关联。</p><h2>微服务</h2><blockquote><p>维基上对其定义为：一种软件开发技术-
        面向服务的体系结构（SOA）架构样式的一种变体，它提倡将单一应用程序划分成一组小的服务，服务之间互相协调、互相配合，为用户提供最终价值。每个服务运行在其独立的进程中，服务与服务间采用轻量级的通信机制互相沟通（通常是基于
        <code>HTTP</code> 的 <code>RESTful API</code>）。每个服务都围绕着具体业务进行构建，并且能够独立地部署到生产环境、类生产环境等。另外，应尽量避免统一的、集中式的服务管理机制，对具体的一个服务而言，应根据上下文，选择合适的语言、工具对其进行构建。</p></blockquote><h4>微服务的优势</h4><p>如上所说，微服务其实是将一个庞大的系统切割成多个最小单元，每一个单元都是一个或者一组相同的功能集合。</p><p>与传统的服务开发不同的是，当一个项目拆解为微服务的时候，带来的优势有如下几点：</p><ol><li>不再局限于<strong>单一技术架构</strong>的实现，根据不同模块的特殊性可以有专业的技术解决方案；</li><li>新的业务功能不需要承担旧的技术债，同时可以拆解服务逐步进行技术升级；</li><li><strong>业务功能单一</strong>，复杂度下降，开发维护效率提高；</li><li>独立部署，单服务启动速度提高，必要时可以根据实际情况对某一些服务进行服务器<strong>升级、扩容</strong>。</li></ol><h4>微服务通信方式</h4><ol><li>同步方式：<code>RPC</code>、<code>HTTP</code>、<code>TCP</code>；</li><li>异步方式：消息队列，使用中过程中需要考虑消息的可靠传输、高性能等情况，常见的工具有<code>Kafka</code>、<code>Notify</code>
        等。</li></ol><p><code>HTTP</code> 与 <code>TCP</code> 都是常见的通信方式，那么 <code>RPC</code>
      又是啥？</p><p><code>RPC</code> <strong>是一种设计、实现框架，通讯协议只是其中一部分</strong>，并不限定某一类的通信协议，大部分的
      <code>RPC</code> 协议使用的是 <code>TCP</code>，但也可以使用 <code>HTTP</code>
      协议来封装，比如谷歌的 <code>gRPC</code> 使用的就是 <code>HTTP2</code> 协议。</p><p>在大概了解了微服务的一些知识之后，接下来继续我们的学习过程。</p><h2>NestJS
      微服务使用</h2><p><code>NestJS</code> 作为一款非常成熟的框架，本身就支持微服务架构的设计，同时也内置了很多 <code>RPC</code>
      的传输器，所以在 <code>NestJS</code> 中使用微服务是非常方便的。</p><h4>启动微服务</h4><p><strong>第一步</strong>：安装微服务依赖
      <code>@nestjs/microservices</code></p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">$ </span><span class="bash">yarn add @nestjs/microservices</span></code></pre><p><strong>第二步</strong>：修改用户系统中
      <code>user-center/src/main.ts</code> ，添加微服务启动配置，并启动用户系统的微服务</p><pre><code class="hljs language-ts"><span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">module</span>: <span class="hljs-built_in">any</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NestFactory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserCenterModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user-center.module'</span>;<span class="hljs-keyword">import</span> {  <span class="hljs-title class_">FastifyAdapter</span>,  <span class="hljs-title class_">NestFastifyApplication</span>,} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/platform-fastify'</span>;<span class="hljs-keyword">import</span> fastify <span class="hljs-keyword">from</span> <span class="hljs-string">'fastify'</span>;<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> cookieParser <span class="hljs-keyword">from</span> <span class="hljs-string">'cookie-parser'</span>;<span class="hljs-keyword">import</span> { generateDocument } <span class="hljs-keyword">from</span> <span class="hljs-string">'./doc'</span><span class="hljs-keyword">import</span> { <span class="hljs-title class_">FastifyLogger</span>, catchError, <span class="hljs-title class_">AllExceptionsFilter</span>, <span class="hljs-title class_">HttpExceptionFilter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@app/common'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ValidationPipe</span>, <span class="hljs-title class_">VersioningType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<span class="hljs-keyword">import</span> fastifyCookie <span class="hljs-keyword">from</span> <span class="hljs-string">'@fastify/cookie'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MicroserviceOptions</span>, <span class="hljs-title class_">Transport</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/microservices'</span>;<span class="hljs-title function_">catchError</span>()<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"></span>) {  <span class="hljs-comment">// 初始化 fastify </span>  <span class="hljs-keyword">const</span> fastifyInstance = <span class="hljs-title function_">fastify</span>({    <span class="hljs-attr">logger</span>: <span class="hljs-title class_">FastifyLogger</span>,  })  <span class="hljs-comment">// 创建 NEST 实例</span>  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-property">create</span>&#x3C;<span class="hljs-title class_">NestFastifyApplication</span>>(    <span class="hljs-title class_">UserCenterModule</span>,    <span class="hljs-keyword">new</span> <span class="hljs-title class_">FastifyAdapter</span>(fastifyInstance)  );  <span class="hljs-comment">// micro serivce</span>  app.<span class="hljs-property">connectMicroservice</span>&#x3C;<span class="hljs-title class_">MicroserviceOptions</span>>(    {      <span class="hljs-attr">transport</span>: <span class="hljs-title class_">Transport</span>.<span class="hljs-property">TCP</span>,      <span class="hljs-attr">options</span>: {        <span class="hljs-attr">port</span>: <span class="hljs-number">4100</span>,        <span class="hljs-attr">host</span>: <span class="hljs-string">'0.0.0.0'</span>,      },    },    {      <span class="hljs-attr">inheritAppConfig</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 继承 app 配置</span>    },  );  app.<span class="hljs-title function_">register</span>(fastifyCookie, {    <span class="hljs-attr">secret</span>: <span class="hljs-string">'my-secret'</span>, <span class="hljs-comment">// for cookies signature</span>  });  <span class="hljs-comment">// 异常过滤器</span>  app.<span class="hljs-title function_">useGlobalFilters</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AllExceptionsFilter</span>(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpExceptionFilter</span>());  <span class="hljs-comment">// 设置全局接口前缀</span>  app.<span class="hljs-title function_">setGlobalPrefix</span>(<span class="hljs-string">'api'</span>);  <span class="hljs-comment">// 格式化 cookie</span>  app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cookieParser</span>());  <span class="hljs-comment">// 接口版本化管理</span>  app.<span class="hljs-title function_">enableVersioning</span>({    <span class="hljs-attr">type</span>: <span class="hljs-title class_">VersioningType</span>.<span class="hljs-property">URI</span>,  });  <span class="hljs-comment">// 启动全局字段校验，保证请求接口字段校验正确。</span>  app.<span class="hljs-title function_">useGlobalPipes</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationPipe</span>());  <span class="hljs-comment">// 创建文档</span>  <span class="hljs-title function_">generateDocument</span>(app)  <span class="hljs-comment">// 启动所有微服务</span>  <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">startAllMicroservices</span>();  <span class="hljs-comment">// 启动服务</span>  <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">4000</span>);  <span class="hljs-comment">// 添加热更新</span>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>) {    <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-title function_">accept</span>();    <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-title function_">dispose</span>(<span class="hljs-function">() =></span> app.<span class="hljs-title function_">close</span>());  }}<span class="hljs-title function_">bootstrap</span>();</code></pre><p>重启服务，看到控制台中有如下打印日志即代表微服务启动成功：</p><p><img
        src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/638ff629248a406e81ea2a4a90c75a51~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><p>也可以使用 <code>netstat -ano -p tcp|findstr 4100</code>
      检查 TCP 端口是否正常启动：</p><p><img
        src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/690f529ae82948a590f22e8ef1392cc2~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><blockquote><p>默认情况下，使用 <code>NestJS</code> 自带的
        <code>RPC</code> 将使用 <strong>TCP协议</strong> 监听消息。</p></blockquote><p><strong>第三步</strong>：在物料系统中添加
      <code>RPC</code> 客户端连接：</p><p><code>.dev.yaml</code> 文件新增新的配置项 <code>USER_MICROSERVICES</code>：</p><pre><code class="hljs language-yml"><span class="hljs-attr">USER_MICROSERVICES:</span>  <span class="hljs-attr">host:</span> <span class="hljs-string">"0.0.0.0"</span>  <span class="hljs-attr">port:</span> <span class="hljs-number">4100</span></code></pre><p>新建
      <code>materials/src/microservices/microservices.module.ts</code>，添加如下代码，并导入
      <code>materials.module.ts</code> 后，重启即可：</p><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ClientsModule</span>, <span class="hljs-title class_">Transport</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/microservices'</span>;<span class="hljs-keyword">import</span> { getConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'@app/common'</span>;<span class="hljs-keyword">const</span> { <span class="hljs-variable constant_">USER_MICROSERVICES</span> } = <span class="hljs-title function_">getConfig</span>()<span class="hljs-meta">@Module</span>({  <span class="hljs-attr">imports</span>: [    <span class="hljs-title class_">ClientsModule</span>.<span class="hljs-title function_">register</span>([      {        <span class="hljs-attr">name</span>: <span class="hljs-string">'USER-SERVER'</span>,        <span class="hljs-attr">transport</span>: <span class="hljs-title class_">Transport</span>.<span class="hljs-property">TCP</span>,        <span class="hljs-attr">options</span>: <span class="hljs-variable constant_">USER_MICROSERVICES</span>,      },    ]),  ],  <span class="hljs-attr">providers</span>: [],  <span class="hljs-attr">exports</span>: []})<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MicroservicesModule</span> { }</code></pre><p><img
        src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1617b6bb8bfe4960975743e104a82196~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><h4>用户系统打通</h4><p><strong>第一步</strong>：在用户系统的 <code>user/UserController</code>
      添加如下代码：</p><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">MessagePattern</span>, <span class="hljs-title class_">Payload</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">MicroPayload</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/microservices'</span>;<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> userService: UserService,    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> userRoleService: UserRoleService  </span>) { }  <span class="hljs-meta">@MessagePattern</span>(<span class="hljs-string">'userCenter.user.profile'</span>)  <span class="hljs-meta">@Public</span>()  <span class="hljs-title function_">micro_profile</span>(<span class="hljs-params"><span class="hljs-meta">@MicroPayload</span>() data: Payload</span>) {    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">profile</span>(data);  }}</code></pre><p><strong>第二步</strong>：在物料系统中移植之前的
      <code>Auth</code> 模块，只保留以下模块：</p><p><img
        src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ea2be6057f73452d907064453fc60fc4~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><p><strong>第三步</strong>：物料系统中新增 <code>microservices/user.service.ts</code>：</p><pre><code class="hljs language-diff">import { Injectable, Inject } from '@nestjs/common';import { ClientProxy } from '@nestjs/microservices';import { firstValueFrom } from 'rxjs';@Injectable()export class UserService {  constructor(    @Inject('USER-SERVER') private userServer: ClientProxy  ) { }  getUser(user) {<span class="hljs-deletion">-   return this.userServer.send('userCenter.user.profile', user)</span><span class="hljs-addition">+   return firstValueFrom(this.userServer.send('userCenter.user.profile', user))</span>  }}</code></pre><blockquote><p>注意客户端中获取
        <code>RPC</code> 服务端的接口的方法是 <code>ClientProxy</code> 中的 <code>send()</code>，此方法请求并返回是响应数据流的
        <code>Observable</code>，这并不是正常的 <code>HTTP</code> 返回的内容，而是通过 <code>TCP</code>
        协议传输的内容。所以直接获取值是获取不到的，一定要记得使用 <code>rxjs</code> 中的 <code>firstValueFrom</code>
        包一层才能拿到正常的返回值。</p></blockquote><p><strong>第四步</strong>：物料系统中新增 <code>src/auth/permission.guard.ts</code></p><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> {  <span class="hljs-title class_">CanActivate</span>,  <span class="hljs-title class_">ExecutionContext</span>,  <span class="hljs-title class_">Injectable</span>,} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Reflector</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../microservices/user.service'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">IS_PUBLIC_KEY</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../constants'</span>;<span class="hljs-meta">@Injectable</span>()<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionGuard</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CanActivate</span> {  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> reflector: Reflector, <span class="hljs-keyword">private</span> userService: UserService</span>) { }  <span class="hljs-keyword">async</span> <span class="hljs-title function_">canActivate</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">ExecutionContext</span>): <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-built_in">boolean</span>> {    <span class="hljs-keyword">const</span> loginAuth = <span class="hljs-variable language_">this</span>.<span class="hljs-property">reflector</span>.<span class="hljs-property">getAllAndOverride</span>&#x3C;<span class="hljs-built_in">boolean</span>>(<span class="hljs-variable constant_">IS_PUBLIC_KEY</span>, [      context.<span class="hljs-title function_">getHandler</span>(),      context.<span class="hljs-title function_">getClass</span>(),    ]);    <span class="hljs-keyword">if</span> (loginAuth) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;    <span class="hljs-keyword">const</span> request = context.<span class="hljs-title function_">switchToHttp</span>().<span class="hljs-title function_">getRequest</span>();    <span class="hljs-keyword">const</span> <span class="hljs-attr">user</span>: <span class="hljs-title class_">Payload</span> = request.<span class="hljs-property">user</span>;    <span class="hljs-keyword">const</span> codes = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">getUser</span>(user);    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'microservices===>'</span>, codes)    <span class="hljs-keyword">return</span> codes;  }}</code></pre><p><code>第五步</code>：将新的网关验证
      <code>PermissionGuard</code> 导入 <code>materials.module.ts</code>：</p><pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">CacheModule</span>, <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">APP_GUARD</span>, <span class="hljs-variable constant_">APP_INTERCEPTOR</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TransformInterceptor</span>, getConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'@app/common'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">GroupModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./materials/group/group.module'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MaterialModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./materials/material/material.module'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ProjectModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./materials/project/project.module'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TaskModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./materials/task/task.module'</span>;<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> redisStore <span class="hljs-keyword">from</span> <span class="hljs-string">'cache-manager-redis-store'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">JwtAuthGuard</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./auth/guards/jwt-auth.guard'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AuthModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./auth/auth.module'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MicroservicesModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./microservices/microservices.module'</span>;<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PermissionGuard</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./auth/guards/permission.guard'</span>;<span class="hljs-meta">@Module</span>({  <span class="hljs-attr">imports</span>: [    <span class="hljs-title class_">CacheModule</span>.<span class="hljs-title function_">register</span>({      <span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span>,      <span class="hljs-attr">store</span>: redisStore,      <span class="hljs-attr">host</span>: <span class="hljs-title function_">getConfig</span>(<span class="hljs-string">'REDIS_CONFIG'</span>).<span class="hljs-property">host</span>,      <span class="hljs-attr">port</span>: <span class="hljs-title function_">getConfig</span>(<span class="hljs-string">'REDIS_CONFIG'</span>).<span class="hljs-property">port</span>,      <span class="hljs-attr">auth_pass</span>: <span class="hljs-title function_">getConfig</span>(<span class="hljs-string">'REDIS_CONFIG'</span>).<span class="hljs-property">auth</span>,      <span class="hljs-attr">db</span>: <span class="hljs-title function_">getConfig</span>(<span class="hljs-string">'REDIS_CONFIG'</span>).<span class="hljs-property">db</span>    }),    <span class="hljs-title class_">ConfigModule</span>.<span class="hljs-title function_">forRoot</span>({      <span class="hljs-attr">ignoreEnvFile</span>: <span class="hljs-literal">true</span>,      <span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span>,      <span class="hljs-attr">load</span>: [getConfig]    }),    <span class="hljs-title class_">MicroservicesModule</span>,    <span class="hljs-title class_">GroupModule</span>,    <span class="hljs-title class_">TaskModule</span>,    <span class="hljs-title class_">MaterialModule</span>,    <span class="hljs-title class_">ProjectModule</span>,    <span class="hljs-title class_">AuthModule</span>  ],  <span class="hljs-attr">controllers</span>: [],  <span class="hljs-attr">providers</span>: [    {      <span class="hljs-attr">provide</span>: <span class="hljs-variable constant_">APP_INTERCEPTOR</span>,      <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">TransformInterceptor</span>,    },    {      <span class="hljs-attr">provide</span>: <span class="hljs-variable constant_">APP_GUARD</span>,      <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">JwtAuthGuard</span>,    },    {      <span class="hljs-attr">provide</span>: <span class="hljs-variable constant_">APP_GUARD</span>,      <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">PermissionGuard</span>,    },  ],})<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MaterialsModule</span> { }</code></pre><p>然后访问物料系统的任意
      <code>API</code> 得到如下结果则代表微服务正常启动，下图中使用的接口是<a
        href="http://localhost:3000/doc#/%E9%A1%B9%E7%9B%AE/ProjectController_getList"
        target="_blank" rel="nofollow noopener noreferrer">http://localhost:3000/doc#/%E9%A1%B9%E7%9B%AE/ProjectController_getList</a></p><p><img
        src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9a6ed6fcdd464a09bf15d605c93fcf70~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><blockquote><p>由于是两个项目，启动后是不同的端口，所以在用户系统中登录之后保存的
        <code>token</code> 是不会共享 <code>cookie</code>
        在物料系统下面，所以为了方便，大家可以在用户系统登录完毕之后，手动将 <code>cookie</code> 存在物料系统下，如下图所示：</p></blockquote><p><img
        src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/56532ebefe634c9ba62531171d4883a8~tplv-k3u1fbpfcp-watermark.image?"
        alt="image.png"></p><p>至此已经完成了用户与物料系统的微服务打通，有兴趣的话，可以再将 <code>auth</code>
      与 <code>microservices</code> 模块也一起放在 <code>libs common</code> 模块中，这样网关
      <code>Core</code> 系统也能直接使用通用的鉴权工具。</p><h2>写在最后</h2><p>本章的示例代码在 <a
        href="https://github.com/boty-design/gateway/tree/feat/microservices"
        target="_blank" rel="nofollow noopener noreferrer">feat/microservices</a>，后续会进行持续的迭代，有需要的同学自取。</p><p>本章主要介绍了如何在
      <code>NestJS</code> 中使用 <code>RPC</code>
      来打通各个微服务中的功能，前文的例子非常简单，实际上我们可以做的内容非常多的，比如在 <code>PermissionGuard</code>
      中，我们可以通过 <code>RPC</code> 从用户系统中获取该登录用户的权限，然后再根据返回的权限对物料系统的接口做权限限制等。</p><p>示例中我们使用的微服务通信方式为同步模式，微服务的通信方式还有异步模式（一般也就是消息队列），但在我们的网关系统中其实是没有使用消息队列的场景，所以在网关系统中就无此实战，但是消息队列在
      <code>Devops</code> 与物料系统的打通中会有很大的应用场景，所以各位可以持续关注 <a
        href="https://github.com/boty-design" target="_blank" rel="nofollow
        noopener noreferrer">https://github.com/boty-design</a>
      这个组织，后期会以开源的方式完成整个工程的搭建。</p><p><strong>想了解后续的工程进度的同学，记得进学习群，每一次的功能发布，我都会在群里及时通知。</strong></p><p>如果你有什么疑问，欢迎在评论区提出或者加群沟通。
      👏</p>
  </body>
</html>