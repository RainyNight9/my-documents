# RBAC 权限设计

## 是什么？

>RBAC（Role-Based Access Control） 的三要素即`用户`、`角色`与`权限`。 用户通过赋予的角色，执行角色所拥有的权限。

![RBAC](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1683434857d14024bf5318a679af4666~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

为什么不直接使用`用户 -> 权限`的链路而是采用`用户 -> 角色 -> 权限`的链路呢？

|  方案   | 用户量  | 权限数 | 权限表数据量 |
|  ----  | ----  |----  |----  |
| 用户 -> 权限  | 1 | 10 | 10 * 1 |
| 用户 -> 权限  | 100，000 | 10 | 10 * 100，000 |
| 用户 -> 角色 -> 权限  | 1 | 10 | 10 * Role |
| 用户 -> 角色 -> 权限  | 100，000 | 10 | 10 * Role |

## 模型的分类

RBAC 模型可分为 `RBAC0、RBAC1、RBAC2、RBAC3`，其中 RBAC0 是基础模型。 RBAC1、RBAC2、RBAC3 都是在 RBAC0 模型的基础上升级。

### RBAC0 模型

RBAC0 即最简单的用户角色权限管理模型：

- 用户和角色可以是一对多，一个用户只能赋予一个角色； 一个角色可以关联多个用户
- 用户和角色可以是多对多的关系， 一个用户拥有多个角色；一个角色可以关联多个用户

基于此模型设计数据库表如下：

![RBAC0 模型数据库表](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/25a84dce643d4a688af1026671814efd~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

### RBAC1 模型

基于模型 `RBAC0 的升级版本`，一个角色可以从另一个角色继承许可权，即角色具有上下级的关系。

一个简单的例子，GitLab 中 master 与 dev 分为两种角色，matser 的权限会涵盖 dev 所有的权限，也就是 master 继承了 dev 的权限，同时额外增加了更高级别的权限。

![RBAC1 模型](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2759d0ce19b04b1498cc8e3ed9e38126~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

角色间的继承关系可分为一般继承关系和受限继承关系：

- 一般继承关系允许角色间的多继承，无特殊限制；
- 受限继承关系则进一步要求角色继承关系是一个树结构，也就是继承关系受到限制，继承 A 类后的角色不再允许继承同级角色 B 类，等同于测试与开发的子权限不能互相继承。

![RBAC1 模型表达关系](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5772933eb57d47068e6498e0d07a8f25~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

### RBAC2 模型

RBAC2 模型是在 RBAC0 模型基础上解决了`角色的授权场景`。角色授权分为两类：

- 静态职责分离
- 动态职责分离

`静态职责分离`又具体分为：

1. 角色互斥 -- 多种角色间不能同时赋予同一个用户，比如 devops 中，研发、产品与测试的权限不会相互重复赋予，当然你可以设置一个更高级别的角色权限 leader 来同时享用所有权限。
2. 基数约束 -- 角色至多能赋予 N 个用户。
3. 先决条件角色 -- 授予用户 B 角色前提是用户必须已经拥有 A 角色，这个在项目管理中比较常见，当你想给你组员分配角色时，你的角色权限理应高于需要分配的角色。

`动态职责分离`即运行时通过当前会话确定用户角色。

例如以我们的范例飞书来说，在飞书账号中可以有多重公司认证，但登录的时候只能选择确定的一家公司身份才能进入。

![静态&动态](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1a74a10e944e4fd2b21c010a8f6ab83b~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

### RBAC3 模型

RBAC3 模型是目前最全面的权限管理，它是基于 RBAC0 的基础上，并将 RBAC1 和 RBAC2 进行了整合。

![RBAC3 模型](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/947ee692cda447269d167c821a07b9e2~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

## 进阶 - 用户组

当系统用户非常多以及角色种类非常多的情况，为了更方便的管理人员，此时可以引用用户组的概念。

每一个用户组分配一批用户，再将角色分配到用户组，将用户与角色之间的桥接关系再引入一层用户组，使得用户只与用户组绑定，用户组与角色绑定。当新的用户想要分配权限的时候，可以直接添加到对应的用户组，这样快速开通该用户组的所有权限，再根据需求分配更细节的角色即可。

这个场景的实例可以参考 GitLab 的 Group 管理模式。

- 用户可以拥有单独的角色权限
- 用户分配到用户组就可以自动拥有用户组的角色权限

这种设计大大减少了数据的冗余性和管理员对权限管理的工作复杂程度。

![用户组](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5b7265490e764a49b3a2220e43494c73~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

## 权限的拓展

当系统逐渐庞大后，权限也需要更加的粒度细化。对于权限的管理分为功能权限和数据权限：

- 功能权限：将系统的可操作性分配给角色，来控制用户的可见性和可编辑性
  1. 读写权限：可见可编辑，
  2. 只读权限：仅可见不可更改
  3. 不可见权限：不可见也没有操作入口
- 数据权限：数据是多维的、抽象的，主要控制某条数据记录对用户是否可见，结合功能权限可以更灵活的配置业务过程中每一位员工的功能操作权限及数据可见范围
  1. 基础数据：比如只有创建人可编辑，其他人只读
  2. 数据共享：比如部门 A 的所有成员均可查看部门 A 的全部处理的财务记录。

针对`功能权限`按功能类型可分为`菜单模块、页面元素模块、文件资源模块`等。要结合实际业务需要合理划分功能点来控制权限的粒度，将权限拆分到模块可以方便后续的其他类型模块拓展。

![功能权限](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0b4a90a89e93423187917875ee11c781~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

针对于上述所有的拓展与设计，最终版本的设计如下所示：

![最终版本](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/192cff00645e41759d06859323f589d4~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)