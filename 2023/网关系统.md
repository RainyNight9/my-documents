# 网关系统

## 应用场景

对于现在主流的后端架构来说，微服务的普及范围还是比较广的，毕竟巨石项目的维护与开发都不太灵活。

最主要的问题是所有功能都放在一个系统里面开发部署，其中任意一个模块出现了问题都可能会导致整个系统雪崩。

对于一个应用的稳定性来说，如果没办法对单一的模块做熔断、升级、回滚等操作，线上不可控的概率极大，这也是目前主流采用微服务架构最大的原因之一。

但是，当一个系统的微服务模块数量非常多的情况下，也经常会出现以下问题：

1. 通用性的认证、鉴权、限流等功能会导致每个微服务都存在造轮子的行为；
2. 业务复杂度上升之后，存在域名分配的问题，没办法对每个服务都分配一个新的域名，同时每一个新的服务上线，运维重复配置的工作量多不少；
3. 太多的域名服务对客户端并不友好，特别是请求层没有做 BFF 的话，每一次拆分新的微服务出来都可能会引起前端的改造；
4. 并非每个服务都是同一种语言或者框架所开发，前面提到的公共的插件并不能满足所有的服务，这个情况可能在 DevOps 系统中比较常见。

为了解决上述的问题，网关系统随之诞生。我们可以通过网关的统一入口来调度各个微服务功能模块，使得每个微服务可以关注于自身的业务功能开发。

## 什么是网关系统（Gateway）

网关系统根据请求类型可以分为：

1. 静态资源网关：处理前端资源数据包括 CSR、SSR 等；
2. API 网关：随着微服务架构（MSA）的普及，通过统一的 API 网关可以聚合所有零散的微服务资源，保持统一的出入口，降低多项目的接入成本以及其他项目的使用成本。

从功能属性上可以分为：

1. 流量网关：无关业务属性，单纯做安全（黑白名单）、分流（负载均衡）等；
2. 业务网关：用户（认证、鉴权）、服务稳定性（降级、容灾）、业务属性灰度、代理（资源代理、缓存）、统一前置（日志、数据校验）等。

所以，市面上常见的网关系统除了提供请求聚合功能之外基本都包含所有通用功能：

- 认证（验证登录态，一般不做鉴权）
- 分流
- 代理（静态资源、API 等）
- AB test （流量灰度，一般根据 IP 或者用户信息灰度）
- 缓存（成本不低，看看就行）
- 等等

## Gateway 功能拆解

### Nginx

Nginx 作为专业的 WEB 代理服务器，在代理方面能够提供负载均衡、流量切换等功能，脚本语言也有 lua 支持。

那么 Nginx 做不到什么呢？

1. Nginx 作为专业的转发服务器，对 Session 以及 Cookie 的处理比较弱。
2. Nginx仅仅支持 HTTP 协议（Email 不算常用功能）。
3. 虽然可以通过 Lua 脚本来处理一些拓展的功能，但是 Lua 脚本的变更以及修改 Nginx 的配置都需要重新启动无法做到热更新，比较麻烦。
4. 没有可视化管理界面也是一个比较大的硬伤（开源的有一些可视化配置项目，但跟可视化管理有一定的区别与差距）。

### Gateway

业务性的 Gateway 需要做点啥：

1. 统一鉴权收口，通过统一配置给接口资源添加权限；
2. 支持 RPC 微服务调用，减少资源消耗；
3. 系统易于监控，同时可以采集收口进来的信息。

通过两者的对比可以看出，Nginx 更关注负载均衡以及反向代理，对业务部分的侵入很低，而 Gateway 作为后端应用，可以携带业务属性，两者可以很好的互补。

在系统架构设计上，我们可以使用 Nginx 作为上文所说的流量网关，由 Nginx 做一层流量代理，通过负载均衡到 Gateway 做业务层的转发处理，这样可以减少我们自建网关系统的工作量。

![网关系统架构](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e15b1e4bc0b842a1affeba55594b232d~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

## 网关系统设计

![网关系统拆解](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f73f00d3e2aa4b779c6539089252c54e~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

### 网关基础服务

因为流量入口已经有 Nginx 作负载均衡，我们网关的基础服务就可以专注于代理模块的开发：

1. 专注于前后端资源分发以及不同类型的项目 API 分发；
2. 常用资源缓存模块；
3. AB Test 模块；
4. 通用日志模块。

### 统一用户中心系统

用户系统需要提供的功能有：

1. 用户登录、认证等基础功能；
2. 权限系统（基于 RBAC 包括角色、系统、资源等权限控制）。

### 物料系统

物料系统主要是针对于静态资源的管理，一般物料系统会跟 DevOps 体系关联比较大，毕竟物料会涉及构建部署的过程，但我们的主题并不是 DevOps，所以物料系统在小册的占比不会很高，只是作为一个辅助类型的项目为网关服务提供静态资源路由的配置、资源版本的管理等功能。

## 技术选型

针对网关系统，以下都是业内比较成熟的框架以及方案：

- Nginx+Lua：Open Resty、Abtesting Gateway。
- Java：Spring Cloud Gateway。
- Go：Janus、Grpc-Gateway。
- Node.js：Express Gateway、MicroGateway。

作为前端，选择 nodejs 来开发，成本会小一点。

Egg 与 NestJs 对比

首先，我们先看看两家的 Slogan。

- Egg: 为企业级框架和应用而生。
- NestJS: 用于构建高效、可伸缩的服务端应用程序的渐进式 Node.js 框架。

从 Slogan 上我们可以看出， Egg更关注企业的维度，NestJS 更注重项目这个维度。

接下来是它们的学习体验。首先是 Egg：

1. 文档体验非常棒，毕竟是阿里开源，国人开发的框架，中文文档内容很丰富，使用过程中出现问题，可以很方便地找到对应的内容。
2. 奉行『约定优于配置』，按照一套统一的约定进行应用开发，团队内部采用这种方式可以减少开发人员的学习与协同成本。
3. 使用的总人数虽然不比 NestJS，但胜在国人多，遇到问题可以咨询的人也会多一些。

接着是 NestJS：

1. 中文文档大部分的内容是中文直译，有些内容没有翻译完整或者翻译意境不对。另外，中文版本的内容也会落后英文版本很多，文档资料使用、学习起来会比较麻烦。
2. 使用总人数虽然比 Egg 更多一些，但是在国内使用的人数不及 Egg，所以很多问题解答中文版本会少于 Egg。

接着从技术上分析：

***Egg***

1. Egg 的底层框架是基于 Koa 开发，在性能与开发体验上会比 Express 更优越。
2. 可选用 JS 以及 TS 开发，两者都是基于 Classify 开发，对刚接触服务端开发的前端更友好。
3. 约定优于配置，减少开发负担、学习以及协作成本。
4. 高度可扩展的插件机制，可以方便定制插件。
5. 内置集群：使用 Cluster，自带进程守护、多进程以及进程间通讯等功能。

***NestJS***

1. NestJS 的底层框架是基于 Express 开发的。
2. 除了 Express 之外，NestJS 也支持使用 Fastify 作为底层框架。因为 NestJS 的设计理念本身就是一个框架适配器，其主要功能是代理中间件和处理器到适当的特定库应用中，从而达到框架的独立性。
3. TS 编程并结合了 OOP（面向对象编程），FP（函数式编程）和 FRP（函数式响应编程）的元素，学习成本会高于 Egg，对新手前端友好度不高，再加上文档缺陷，劝退概率倍增。
4. 模块加载方面使用 IoC 模式：模块容器 - 依赖注入(通过装饰器和元数据实现)，开发效率以及维护性会更高。
5. 整个框架的配套功能非常完善例如：鉴权、文档、微服务、CLI 工具等。

最后，综合对比：

NestJS 提供了更多的选择，更加自由以及更偏向后端开发的体验，而 Egg 作为深度定制过的框架，自定义的程度会弱于 NestJS，在团队初期快速开发业务的时候非常适合。

上述对比并不代表两个框架一定有个高下之分，针对于团队、项目的不同时期，开发人员的能力、喜好，哪一种框架能发挥最大价值，它就是当前对你来说最好的框架。

## 数据库选型

数据库部分，我们主要对比 MySQL 和 MongoDB。

MySQL 作为典型的关系型数据库，支持单点、集群部署架构，成熟度非常高。它作为开源数据库拥有非常全的文档与社区资源，出现问题能快速获得对应的帮助，后端首推数据库之一。

但是对于复杂读写操作，需要组合索引查询多表，对性能消耗不小，需要做读写分离或者表结构拆解，对业务架构设计要求比较高。

MongoDB 是非关系型数据库、nosql 的代表作。它可以通过副本集、分片实现高可用，在集群架构拥有十分高的扩展性，但要实现这种高可用对运维的要求比较高。

MongoDB 数据处理方式 是基于内存的，将热数据存在物理内存中，从而达到高速读写。由于性能出色，一般用在博客、内容管理等大数据存储的系统中较为合适。

总的来说，这两种数据库各有千秋，我们要根据不同的项目需求来选择合适的数据库。

在之前的架构设计中，我们一共需要开发 3 个系统，其中物料系统除了需要保存物料的版本信息之外，还需要存储 HTML 这种内容数据，所以在物料系统中使用 MongoDB 无疑是非常好的选择。常规的项目如用户中心，针对于权限的管理非常复杂，所以选择 MySQL 使用多表关联来存储数据更为合适。

但是用户中心使用 MySQL 作为数据库的话，用户登录信息这种共用的数据就不可能保存在每个 pod，而且频繁的读取 MySQL 也不太实际。这个时候就需要使用 Redis 来做统一缓存，弥补关系型数据的缺陷。Redis 是一个高性能的 key-value 数据库，一般常用于业务数据缓存的操作。
